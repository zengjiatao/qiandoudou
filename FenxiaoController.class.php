<?php  namespace Func\Controller;use Think\Controller;class FenxiaoController extends Controller {    //交易分销功能 $order 交易订单号    public function fenxiaoByOrderCeshi($order)    {        //   $order = "ZNHK2017121614283843DK300000005";//        $oldorder=$order;//        $order="JY".$order;        if(!$order)        {//             echo "请输入要分销的订单";        }        //判断是否已经有分销过        $cwhere['sh_ordersn'] = array('eq',$order);        $cwhere['money_type_id'] = array('in','11');        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {//              echo $order."已经分成过<br/>";            return false;        }//        var_dump($order);die;        $where['pt_ordersn'] = array('eq',$order);        $orderarr=M('money_detailed')->where($where)->select();        //   var_dump($orderarr);        if($orderarr)        {            //判断订单是否已支付完成            if($orderarr[0]['jy_status']==1){//              echo "订单已完成，准备分销<br/>";                $wheretype['money_type_id'] = array('eq',$orderarr[0]['money_type_id']);                $money_type=M('money_type')->where($wheretype)->select();//             echo M('money_type')->getLastSql();                if ($money_type[0]['dis_type'] == 1) {//                 echo "支付是可分销类型<br/>";                    $userid=$orderarr[0]['user_id'];                    $users = array();                    $users=$this->getUpUser($userid);                    if($users['user_id'])                    {                        for ($i = 0; $i < 3; $i++) {                            if($users['user_id']){//                          echo "用户id=".$users['id']."正在插入订单<br/>";                                if($users['utype']==20)                                {//                              echo ($i+1)."级是推客<br/>";                                    //添加用户分销记录并赋余额                                    $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    //添加推客分销记录                                    $this->addTkOrder($users['user_id'],$order,$users['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    return true;                                }else {//                              echo ($i+1)."级普通兜客<br/>";                                    //添加用户分销记录并赋余额                                    $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    $users=$this->getUpUser($users['user_id']);                                }                            }else {//                              echo ($i+1)."级没有兜客了<br/>";                            }                        }                    }else                    {//                      echo "该用户没有上级<br/>";                    }//                  echo "3级都没有推客，找到本人的推客进行分配收益<br/>";                    $wheretk['user_id'] = array('eq',$userid);                    $user1=M('user')->where($wheretk)->find();//                 echo M('user')->getLastSql();                    if($user1)                    {                        $tk_pid=$user1['tk_pid'];                        if($tk_pid){//                         echo "推客用户id=".$tk_pid."正在插入订单<br/>";                            $wheretkuser['user_id'] = array('eq',$tk_pid);                            $usertk=M('user')->where($wheretkuser)->select();                            //     echo M('user')->getLastSql();                            //       var_dump($usertk);                            //添加推客分销记录                            $this->addTkOrder($tk_pid,$order,$usertk[0]['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                        }else {//                          echo "该用户没有推客<br/>";                        }                    }else {//                      echo "该用户没有推客<br/>";                    }                    return  true;                }else                {//                 echo "该订单没有分销功能";                    return  false;                }            }else            {//                 echo "该订单没有完成";                return  false;            }//             echo "订单已完成，准备分销<br/>";        }else        {//             echo "数据库没有该订单";        }        return  false;    }     //交易分销功能 $order 交易订单号    public function fenxiaoByOrder($order)    {        //   $order = "ZNHK2017121614283843DK300000005";//        $oldorder=$order;//        $order="JY".$order;        if(!$order)        {//             echo "请输入要分销的订单";        }        //判断是否已经有分销过        $cwhere['sh_ordersn'] = array('eq',$order);        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {             #  echo $order."已经分成过<br/>";            return false;        }//        var_dump($order);die;        $where['pt_ordersn'] = array('eq',$order);        $orderarr=M('money_detailed')->where($where)->select();     //   var_dump($orderarr);        if($orderarr)        {            //判断订单是否已支付完成            if($orderarr[0]['jy_status']==1){//              echo "订单已完成，准备分销<br/>";            $wheretype['money_type_id'] = array('eq',$orderarr[0]['money_type_id']);            $money_type=M('money_type')->where($wheretype)->select();//             echo M('money_type')->getLastSql();            if ($money_type[0]['dis_type'] == 1) {//                 echo "支付是可分销类型<br/>";                $userid=$orderarr[0]['user_id'];                $users = array();                            $users=$this->getUpUser($userid);                            if($users['user_id'])                            {                                for ($i = 0; $i < 3; $i++) {//                                    echo $users['user_id'];                                    if($users['user_id']){//echo "用户id=".$users['user_id']."，推客等级：".$users['utype'].",正在插入订单,index".$i ."<br/>";                                        if($users['utype']==20)                                        {//                                          echo ($i+1)."级是推客<br/>";                                            //添加用户分销记录并赋余额                                             $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                            //添加推客分销记录                                             $this->addTkOrder($users['user_id'],$order,$users['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                            $this->fenxiaoTkLevelOrder($order);                                            # 如果是推客身份 （同时pid）兜客                                            R("Payapi/BaseFunc/threeYjFunc",array($order));                                            return true;                                        }else {   #　兜客身份//                              echo ($i+1)."级普通兜客<br/>";                                            //添加用户分销记录并赋余额                             $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                            $users=$this->getUpUser($users['user_id']);  # 此方法只针对兜客有效/获取三级关系                        }                        }else {                             # echo ($i+1)."级没有兜客了<br/>";                        }                    }                   #  echo '测试完毕';exit;                }else                {//                      echo "该用户没有上级<br/>";                }//                  echo "3级都没有推客，找到本人的推客进行分配收益<br/>";                # echo '到这位';                $wheretk['user_id'] = array('eq',$userid);                $user1=M('user')->where($wheretk)->find();//                 echo M('user')->getLastSql();                if($user1)                {                    $tk_pid=$user1['tk_pid'];                    if($tk_pid){//                         echo "推客用户id=".$tk_pid."正在插入订单<br/>";                        $wheretkuser['user_id'] = array('eq',$tk_pid);                        $usertk=M('user')->where($wheretkuser)->select();                   //     echo M('user')->getLastSql();                 //       var_dump($usertk);                        //添加推客分销记录                        $this->addTkOrder($tk_pid,$order,$usertk[0]['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                    }else {//                          echo "该用户没有推客<br/>";                    }                }else {//                      echo "该用户没有推客<br/>";                }                $this->fenxiaoTkLevelOrder($order);                # echo '到那里';                return  true;            }else            {//                 echo "该订单没有分销功能";                return  false;            }            }else            {//                 echo "该订单没有完成";                return  false;            }//             echo "订单已完成，准备分销<br/>";        }else        {//             echo "数据库没有该订单";        }        return  false;    }    # 推客分销  ( 针对兜客升级为推客之后按照三级分销进行分配佣金 )    public function getLevelTk($userid,$sh_ordersn,$leve,$type,$money,$pay_type)    {        $where['type'] = array('eq',$type);        $distribution=M('distribution_level')->where($where)->select();        $commission=0;        if($leve==1)        {            $commission=$distribution[0]['commission1'];        }elseif ($leve==2)        {            $commission=$distribution[0]['commission2'];        }elseif ($leve==3)        {            $commission=$distribution[0]['commission3'];        }        $where['user_pay_supply_id'] = array('eq',$pay_type);        $distribution=M('user_pay_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=$money*($yy_rate-$pt_rate)/1000*$commission/100;        $type="9";        $whereorder['pt_ordersn'] = array('eq',$sh_ordersn);        $orderarr=M('money_detailed')->where($whereorder)->find();        if($orderarr['money_type_id']==16)        {            $type="20";        }        $typename = $this->getType($type);        $blarray = array(            'commission_bl' => trim($commission/100),            'commission_summoney' =>trim($ratemoney/($commission/100)),            'commission_fr_bl' => 0,            'commissioncommission_fr_summoney' => 0        );        $this->createOrder($userid,$ratemoney,$typename,$sh_ordersn,"系统自动分配",$pay_type,$type,$blarray);        /*        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");        */    }    //添加兜客分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级兜客，目前有三级兜客，分销利益不同,$type用户所属的类型    public  function addUserOrder($userid,$sh_ordersn,$leve,$type,$money,$pay_type)    {        //如果是推客，则分配普通的兜客分成        # dump($type);        if($type==20)        {            $type=1;        }        $where['type'] = array('eq',$type);        $distribution=M('distribution_level')->where($where)->select();        $commission=0;        if($leve==1)        {            $commission=$distribution[0]['commission1'];        }elseif ($leve==2)        {            $commission=$distribution[0]['commission2'];        }elseif ($leve==3)        {            $commission=$distribution[0]['commission3'];        }        $where['user_pay_supply_id'] = array('eq',$pay_type);        $distribution=M('user_pay_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=$money*($yy_rate-$pt_rate)/1000*$commission/100;        # echo $leve."级兜客所得分销利润=".$ratemoney."<br/>";        $type="9";        $whereorder['pt_ordersn'] = array('eq',$sh_ordersn);        $orderarr=M('money_detailed')->where($whereorder)->find();        if($orderarr['money_type_id']==16)        {            $type="20";        }        $typename = $this->getType($type);        $blarray = array(            'commission_bl' => trim($commission/100),            'commission_summoney' =>trim($ratemoney/($commission/100)),            'commission_fr_bl' => 0,            'commissioncommission_fr_summoney' => 0        );        $this->createOrder($userid,$ratemoney,$typename,$sh_ordersn,"系统自动分配",$pay_type,$type,$blarray);        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    //添加推客分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级推客，目前有三级推客，分销利益不同    public  function addTkOrder($userid,$sh_ordersn,$leve,$money,$pay_type)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        $commission=$distribution[0]['commission1'];        $where['user_pay_supply_id'] = array('eq',$pay_type);        $distribution=M('user_pay_supply')->where($where)->select();        $pt_rate=$distribution[0]['pt_rate']; //平台费率        $tk_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=$money*($tk_rate-$pt_rate)/1000*$commission/100;//         echo "推客所得分销利润百分比=".$commission."<br/>";//         echo "推客所得分销利润=".$ratemoney."<br/>";        $type="12";        $whereorder['pt_ordersn'] = array('eq',$sh_ordersn);        $orderarr=M('money_detailed')->where($whereorder)->find();        if($orderarr['money_type_id']==16)        {            $type="21";        }        $typename = $this->getType($type);        $blarray = array(            'commission_bl' => 0,            'commission_summoney' => 0,            'commission_fr_bl' => trim($commission/100),            'commissioncommission_fr_summoney' => trim($ratemoney/($commission/100))        );        $this->createOrder($userid,$ratemoney,$typename,$sh_ordersn,"系统自动分配",$pay_type,$type,$blarray);        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    public function getType($type=0)    {        $typename = M("money_type")->where(array('money_type_id'=>$type))->getField('type');        return $typename;    }    //生成用户订单    public  function createOrder($userid,$money,$title,$sh_ordersn,$pay_name,$pay_type,$type,$blarray=array())    {        $pt_ordersn="YJ". date("YmdHis",time()).mt_rand(1000,9999).$userid;        $where['user_id'] = array('eq',$userid);        $user=M('user')->where($where)->select();        $usermoneybf=$user[0]['money'];        $usermoneyat=$usermoneybf+$money;        M('user')->where($where)->save(array(            'money'=>$usermoneyat        ));;        //交易明细        $detailed = M("money_detailed");	// 实例化模型类        // 构建写入的数据数组        $data["goods_name"] =$title;        $data["money"] = $money;        $data["user_id"] = $userid;        $data["sh_ordersn"] = $sh_ordersn;        $data["user_pay_supply_id"] = $pay_type;        $data["pay_name"] = $pay_name;        $data["pt_ordersn"] = $pt_ordersn;        $data["js_status"] = 4;        $data["jy_status"] = 1;        $data["after_money"] = $usermoneyat;        $data["pay_money"] = $money;        $data["before_money"] = $usermoneybf;        $data["money_type_id"] = $type;        $data["t"] = time();        $data["d_t"] = time();        $data["service_charge"] = 0;        $data["serial_number"] = 0;        $data["bank_cart"] = 0;        $data["pay_zhe"] = 0;        $data["phone"] = 0;        $data["timestamp"] = time();        $data["freezing_money"] = 0;        $data["benefit"] = $money;        $data["commission_bl"] = $blarray['commission_bl'];  # 佣金比例        $data["commission_summoney"] = $blarray['commission_summoney']; # 订单总佣金        $data["commission_fr_bl"] = $blarray['commission_fr_bl'];  # 分润比例        $data["commissioncommission_fr_summoney"] = $blarray['commissioncommission_fr_summoney'];  # 订单总分润//         var_dump($data);        // 写入数据        if($lastInsId = $detailed->add($data)){//             echo "插入数据 id 为：$lastInsId";            return true;        } else {//             $this->error('数据写入错误！');            return false;        }    }    //获取上一级    public function getUpUser($userid)    {        $users = array();        $where['user_id'] = array('eq',trim($userid));        $user1=M('user')->where($where)->select();    //    echo M('user')->getLastSql();        if($user1)        {            $where2['user_id'] = array('eq',trim($user1['0']['pid']));            $user2=M('user')->where($where2)->select();            $user1id=$user2[0]['user_id'];            $pid=$user2[0]['pid'];            $tk_pid=$user2[0]['tk_pid'];            $level=$user2[0]['level'];            $utype=$user2[0]['utype'];            $money=$user2[0]['money'];            $users['user_id']=$user1id;            $users['pid']=$pid;            $users['tk_pid']=$tk_pid;            $users['level']=$level;            $users['utype']=$utype;            $users['money']=$money;        }        return $users;    }    //结算分销功能 $order 结算订单号    public function jiesuanfenxiaoByOrder($order)    {        $oldorder=$order;        $order="JS".$order;        if(!$order)        {            # echo "请输入要分销的订单";        }        //判断是否已经有分销过        $cwhere['sh_ordersn'] = array('eq',$order);        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {//             echo "已经分成过<br/>";            return false;        }        $where['pt_ordersn'] = array('eq',$oldorder);        $orderarr=M('moneyjs_detailed')->where($where)->select();        //   var_dump($orderarr);        if($orderarr)        {            //判断订单是否已支付完成            if($orderarr[0]['js_status']==2){//              echo "订单已完成，准备分销<br/>";                $wheretype['settlement_type_id'] = array('eq',$orderarr[0]['type']);                $money_type=M('settlement_type')->where($wheretype)->select();                //             echo M('money_type')->getLastSql();                if ($money_type[0]['dis_type'] == 1) {//                   echo "支付是可分销类型<br/>";                    $userid=$orderarr[0]['user_id'];                    $users = array();                    $users=$this->getUpUser($userid);                    if($users['user_id'])                    {                        for ($i = 0; $i < 3; $i++) {                            if($users['user_id']){//                              echo "用户id=".$users['id']."正在插入订单<br/>";                                if($users['utype']==20)                                {//                                  echo ($i+1)."级是推客<br/>";                                    //添加用户分销记录并赋余额                                    $this->jiesuanaddUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['js_money'],$orderarr[0]['user_js_supply_id']);                                    //添加推客分销记录                                    $this->jiesuanaddTkOrder($users['user_id'],$order,$users['level'],$orderarr[0]['js_money'],$orderarr[0]['user_js_supply_id']);                                    #$users=$this->getUpUser($users['user_id']);                                    $this->fenxiaoTkJsLevelOrder($oldorder);                                    R("Payapi/BaseFunc/threeYjJsFunc",array($oldorder));                                    return true;                                }else {//                                    echo ($i+1)."级普通兜客<br/>";                                    //添加用户分销记录并赋余额                                    $this->jiesuanaddUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['js_money'],$orderarr[0]['user_js_supply_id']);                                    $users=$this->getUpUser($users['user_id']);                                }                            }else {//                                  echo ($i+1)."级没有兜客了<br/>";                            }                        }                    }else                    {//                             echo "该用户没有上级<br/>";                    }//                  echo "3级都没有推客，找到本人的推客进行分配收益<br/>";                    $where['user_id'] = array('eq',$userid);                    $user1=M('user')->where($where)->select();                    if($user1)                    {                        $tk_pid=$user1[0]['tk_pid'];                        if($tk_pid){                            //                         echo "用户id=".$tk_pid."正在插入订单<br/>";                            $where['user_id'] = array('eq',$tk_pid);                            $usertk=M('user')->where($where)->select();                            //     echo M('user')->getLastSql();                            //       var_dump($usertk);                            //添加推客分销记录                            $this->jiesuanaddTkOrder($tk_pid,$order,$usertk[0]['level'],$orderarr[0]['js_money'],$orderarr[0]['user_js_supply_id']);                        }else {//                     echo "该用户没有推客<br/>";                        }                    }else {//                       echo "该用户没有推客<br/>";                    }                    $this->fenxiaoTkJsLevelOrder($oldorder);                    return  true;                }else                {//                  echo "该订单没有分销功能";                    return  false;                }            }else            {//              echo "该订单没有完成";                return  false;            }//              echo "订单已完成，准备分销<br/>";        }else        {//              echo "数据库没有该订单";        }        return  false;    }    //添加兜客结算分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级兜客，目前有三级兜客，分销利益不同,$type用户所属的类型    public  function jiesuanaddUserOrder($userid,$sh_ordersn,$leve,$type,$money,$pay_type)    {        //如果是推客，则分配普通的兜客分成        if($type==20)        {            $type=1;        }        $where['type'] = array('eq',$type);        $distribution=M('distribution_level')->where($where)->select();        $commission=0;        if($leve==1)        {            $commission=$distribution[0]['commission1'];        }elseif ($leve==2)        {            $commission=$distribution[0]['commission2'];        }elseif ($leve==3)        {            $commission=$distribution[0]['commission3'];        }        $where['user_js_supply_id'] = array('eq',$pay_type);        $distribution=M('user_js_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=($yy_rate-$pt_rate)*$commission/100;        //         echo $leve."级兜客所得分销利润=".$ratemoney."<br/>";        $pay_type =$distribution[0]['sid'];        $type="14";        $typename = $this->getType($type);        $blarray = array(            'commission_bl' => trim($commission/100),            'commission_summoney' =>trim($ratemoney/($commission/100)),            'commission_fr_bl' => 0,            'commissioncommission_fr_summoney' => 0        );        $this->createOrder($userid,$ratemoney,$typename,$sh_ordersn,"系统自动分配",$pay_type,$type,$blarray);        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    //添加推客结算分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级推客，目前有三级推客，分销利益不同    public  function jiesuanaddTkOrder($userid,$sh_ordersn,$leve,$money,$pay_type)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        $commission=$distribution[0]['commission1'];        $where['user_js_supply_id'] = array('eq',$pay_type);        $distribution=M('user_js_supply')->where($where)->select();        $pt_rate=$distribution[0]['pt_rate']; //平台费率        $tk_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=($tk_rate-$pt_rate)*$commission/100;        //         echo "推客所得分销利润百分比=".$commission."<br/>";        //         echo "推客所得分销利润=".$ratemoney."<br/>";        $pay_type =$distribution[0]['sid'];        $type="15";        $typename = $this->getType($type);        $blarray = array(            'commission_bl' => 0,            'commission_summoney' => 0,            'commission_fr_bl' => trim($commission/100),            'commissioncommission_fr_summoney' => trim($ratemoney/($commission/100))        );        $this->createOrder($userid,$ratemoney,$typename,$sh_ordersn,"系统自动分配",$pay_type,$type,$blarray);        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }   //获取当前用户的分销额    public function index($uid){//        var_dump($this->orderRe($uid));        $w['user_id'] = $uid;        $res = M('distribution_jilu')->alias('a')->field('a.*,b.nick_name,head_img')->join('left join y_user as b on a.user_id=b.user_id')->where($w)->order('distribution_jilu_id desc')->select();      //  var_dump($res);        return $res;    }     //获得分销上下级    public function orderRetails($uid=0,$level=0){      $data = M('user')->field('nick_name,pid,user_id,head_img,time,utype')->select();        static $lists=array();        static $array=array();      foreach($data as $k=>$v){          if($v['pid'] == $uid){              $v['level']=$level;              if ($v['level'] > 2){                  break;              }              $lists[]=$v;           $this->orderRetails($v['user_id'],$level+1);          }      }    //    dump($lists);        return $lists;    }    //获得会员上下级    public function orderRe($uid=0,$level=0){      $data = M('user')->field('nick_name,pid,user_id,utype')->select();        // static $lists=array();        // static $array=array();        static $arr=array();      foreach($data as $k=>$v){          //获取上级          if ($v['user_id'] == $uid) {              $v['level'] = $level;            $lists = M('user')->field('nick_name,pid,user_id,utype')->where(array('user_id'=>$v['pid']))->find();            if($lists)            {              if($lists['utype'] ==  20){                  $lists['level'] = $v['level'];                  $arr["TWO"] = $lists;  # 所属推客                  $li = M('institution')->field('username,password,user_id')->where(array('institution_id'=>$arr["TWO"]['pid']))->find();                  $arr["THREE"] = $li;              }else if($lists['utype'] != 20){              }              # 一级//              $arr['ONE'] = $lists;                if ($v['level'] >= 2){                    break;                }            }              $this->orderRe($lists['user_id'],$level+1);          }      }        return $arr;    }    # 获取上级兜客、推客、机构  ---  暂时不需要用到    # type = 1上级兜客   2推客  3机构    public function levelY($type=1,$uid=0)    {        $d = array();        if($type == 1)        {            $d = $this->levelO($uid);        }else if($type == 2)        {            $d = $this->levelS($uid);        }else if($type == 3)        {            $d = $this->levelJ($uid);        }else{            // 默认        }        return $d;    }    # 获取上级兜客    public function levelO($uid=0)    {        $d = array();        $pid = M('user')->where("user_id = '{$uid}' AND (utype = 1 OR utype = 10)")->getField('pid');        if($pid!=0)        {            $d = M('user')->field('user_id,nick_name')->where(array('user_id'=>$pid))->find();        }        return $d;    }    # 获取上级推客    public function levelS($uid=0)    {        $data = M('user')->field('nick_name,pid,user_id,utype')->where(array('utype'=>20))->order('user_id desc')->select();        static $d=array();        foreach($data as $k=>$v){            //获取上级            var_dump($v['user_id'].' --- '.$uid);            if ($v['user_id'] == $uid) {                $d = M('user')->field('nick_name,id')->where(array('pid'=>$v['user_id']))->find();//                $this->levelS($v['id']);            }        }        return $d;    }    # 获取上级机构    public function levelJ($uid=0)    {        $d = array();        $pid = M('user')->where(array('user_id'=>$uid,'utype'=>20))->getField('pid');        if($pid!=0)        {            $d = M('institution')->field('user_id,username')->where(array('user_id'=>$pid))->find();        }        return $d;    }    /**     * @author : Jeffery     * @time : 2017.12.11     * 针对信用卡申请审核通过分销方法     */    public function fenxiaoCCOrder()    {            $order = trim($_REQUEST['order_sn']);            if(!$order)            {                return false;            }        //判断是否已经有分销过        $cwhere['sh_ordersn'] = array('eq',$order);        $corderarr=M('creditcard_jilu')->where($cwhere)->select();        if($corderarr)        {            return false;        }        $where['order_sn'] = array('eq',$order);        $orderarr=M('creditcard_jilu')->where($where)->select();//        dump($orderarr);        if($orderarr)        {            //判断订单是否已支付完成            if($orderarr[0]['status']==4){//              echo "订单已完成，准备分销<br/>";                $wheretype['money_type_id'] = array('eq',$orderarr[0]['money_type_id']);                $money_type=M('money_type')->where($wheretype)->select();//             echo M('money_type')->getLastSql();                if ($money_type[0]['dis_type'] == 1) {//                 echo "支付是可分销类型<br/>";                    $userid=$orderarr[0]['user_id'];                    $users = array();                    $users=$this->getUpUser($userid); //获得上级信息                    if($users['user_id'])                    {                        for ($i = 0; $i < 3; $i++) {                            if($users['user_id']){//                         echo "用户id=".$users['id']."正在插入订单<br/>";                                if($users['utype']==20)                                {//                             echo ($i+1)."级是推客<br/>";                                    //添加用户分销记录并赋余额                                    $this->ccaddUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['creditcard_td_id']);                                    //添加推客分销记录                                    $this->ccaddTkOrder($users['user_id'],$order,$users['level'],$orderarr[0]['pay_money'],$orderarr[0]['creditcard_td_id']);                                    return true;                                }else{//                             echo ($i+1)."级普通兜客<br/>";                                    //添加用户分销记录并赋余额                                    $this->ccaddUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['creditcard_td_id']);                                    $users=$this->getUpUser($users['user_id']); //获得上级信息                                }                            }else{//                             echo ($i+1)."级没有兜客了<br/>";                            }                        }                    }else                    {//                     echo "该用户没有上级<br/>";                    }//                 echo "3级都没有推客，找到本人的推客进行分配收益<br/>";//                    die;                    $where['user_id'] = array('eq',$userid);                    $user1=M('user')->where($where)->select();                    if($user1)                    {                        $tk_pid=$user1[0]['tk_pid'];                        if($tk_pid){//                         echo "用户id=".$tk_pid."正在插入订单<br/>";                            $where['user_id'] = array('eq',$tk_pid);                            $usertk=M('user')->where($where)->select();                            //     echo M('user')->getLastSql();                            //       var_dump($usertk);                            //添加推客分销记录                            $this->ccaddTkOrder($tk_pid,$order,$usertk[0]['level'],$orderarr[0]['pay_money'],$orderarr[0]['creditcard_td_id']);                        }else {//                         echo "该用户没有推客<br/>";                        }                    }else {//                     echo "该用户没有推客<br/>";                    }                    return  true;                }else                {//                 echo "该订单没有分销功能";                    return  false;                }            }else            {//                 echo "该订单没有完成";                return  false;            }//             echo "订单已完成，准备分销<br/>";        }else        {//             echo "数据库没有该订单";        }        return  false;    }    //生成用户订单    public  function cccreateOrder($userid,$money,$goods_name,$sh_ordersn,$pay_type,$type)    {        $pt_ordersn="CS". date("YmdHis",time()).$userid;        $where['user_id'] = array('eq',$userid);        $user=M('user')->where($where)->select();        $usermoneybf=$user[0]['money'];        $usermoneyat=$usermoneybf+$money;        M('user')->where($where)->save(array(            'money'=>$usermoneyat  // 得利润        ));;        //交易明细        $detailed = M("creditcard_jilu");	// 实例化模型类        $data["user_id"] = $userid;        $creditcard_id = M("creditcard_jilu")->where(array('order_sn'=>$sh_ordersn))->getField('creditcard_id');        $data["sh_ordersn"] = $sh_ordersn;        $data["user_pay_supply_id"] = $pay_type;        $data["order_sn"] = $pt_ordersn;        $data["status"] = 4;        $data['creditcard_id'] = $creditcard_id;        $data["money_type_id"] = intval($type);        $data["bank_status"] = 4;        $data["pay_name"] = '系统自动分配';        $data['goods_name'] = $goods_name;        $data["t"] = time();        $data["d_t"] = time();        $data["benefit"] = $money;        $mondata['user_id'] = $userid;        $mondata['goods_name'] = $goods_name;        $mondata['user_pay_supply_id'] = $pay_type;        $mondata['benefit'] = $money;        $mondata['goods_type'] = '信用卡申请';        $mondata['pay_name'] = '系统自动分配';        $mondata['pt_ordersn'] = $pt_ordersn;        $mondata['sh_ordersn'] = $sh_ordersn;        $mondata['jy_status'] = 1;        $mondata['js_status'] = 4;        $mondata['before_money'] = $usermoneybf;        $mondata['after_money'] = $usermoneyat;        $mondata['money'] = $money;        $mondata['money_type_id'] = intval($type);        $mondata['t'] = time();        $mondata['d_t'] = time();        $mondata['d_t'] = time();        # 添加分销表        M("money_detailed")->add($mondata);//         var_dump($data);        // 写入数据        if($lastInsId = $detailed->add($data)){//             echo "插入数据 id 为：$lastInsId";            return true;        } else {//             $this->error('数据写入错误！');            return false;        }    }    //添加兜客信用卡申请分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级兜客，目前有三级兜客，分销利益不同,$type用户所属的类型    public  function ccaddUserOrder($userid,$sh_ordersn,$leve,$type,$money,$pay_type)    {//        var_dump($money);//        var_dump($pay_type);        //如果是推客，则分配普通的兜客分成        if($type==20)        {            $type=1;        }        $where['type'] = array('eq',$type);        $distribution=M('distribution_level')->where($where)->select();        $commission=0;        if($leve==1)        {            $commission=$distribution[0]['commission1']; //50        }elseif ($leve==2)        {            $commission=$distribution[0]['commission2']; //30        }elseif ($leve==3)        {            $commission=$distribution[0]['commission3']; // 20        }// $where['user_pay_supply_id'] = array('eq',$pay_type);        //$distribution=M('user_pay_supply')->where($where)->select();        $where['creditcard_td_id'] = array('eq',$pay_type);        $distribution=M('creditcard_td')->where($where)->select();//        $yy_rate=$distribution[0]['yy_rate']; //运营费率//        $pt_rate=$distribution[0]['tk_rate']; //推客费率        $yy_rate=$distribution[0]['dk_sy']; //运营费率        $pt_rate=$distribution[0]['tk_sy']; //推客费率        //所得分销利润        $ratemoney = ($yy_rate-$pt_rate)*($commission/100);        //         echo $leve."级兜客所得分销利润=".$ratemoney."<br/>";//        $pay_type =$distribution[0]['sid'];//        dump($ratemoney);die;        R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---兜客分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        $type="18";        $typename = $this->getType($type); //获得类型名称        $this->cccreateOrder($userid,$ratemoney,$typename,$sh_ordersn,$pay_type,$type);        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    //添加推客信用卡申请分销订单 $userid用户id，$sh_ordersn父级订单,$leve第几级推客，目前有三级推客，分销利益不同    public  function ccaddTkOrder($userid,$sh_ordersn,$leve,$money,$pay_type)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        $commission=$distribution[0]['commission1'];//        $where['user_pay_supply_id'] = array('eq',$pay_type);//        $distribution=M('user_pay_supply')->where($where)->select();        $where['creditcard_td_id'] = array('eq',$pay_type);        $distribution=M('creditcard_td')->where($where)->select();//        $pt_rate=$distribution[0]['pt_rate']; //平台费率//        $tk_rate=$distribution[0]['tk_rate']; //推客费率        $pt_rate=$distribution[0]['dk_sy']; //平台费率        $tk_rate=$distribution[0]['tk_sy']; //推客费率        //所得分销利润        $ratemoney=($pt_rate-$tk_rate)*($commission/100);        //         echo "推客所得分销利润百分比=".$commission."<br/>";        //         echo "推客所得分销利润=".$ratemoney."<br/>";//        $pay_type =$distribution[0]['sid'];        $type="19";        $typename = $this->getType($type); //类型名称        $this->cccreateOrder($userid,$ratemoney,$typename,$sh_ordersn,$pay_type,$type);        R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---兜客分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    //商家交易分销功能 $order 商家交易订单号    public function businessByOrder($order)    {        //   $order = "ZNHK2017121614283843DK300000005";        if(!$order)        {            //             echo "请输入要分销的订单";        }        //判断是否已经有分销过        $cwhere['sh_ordersn'] = array('eq',$order);        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {            //             echo "已经分成过<br/>";            return false;        }        $where['pt_ordersn'] = array('eq',$order);        $orderarr=M('business_order')->where($where)->select();        //   var_dump($orderarr);        if($orderarr)        {            //判断订单是否已支付完成            if($orderarr[0]['jy_status']==1){                echo "订单已完成，准备分销<br/>";                $wheretype['money_type_id'] = array('eq',$orderarr[0]['money_type_id']);                $money_type=M('money_type')->where($wheretype)->select();                //             echo M('money_type')->getLastSql();                if ($money_type[0]['dis_type'] == 1) {                     echo "支付是可分销类型<br/>";            //        $userid=$orderarr[0]['user_id'];                    $wherenbs['business_id'] = array('eq',$orderarr[0]['business_id']);                    $business=M('business')->where($wherenbs)->find();                    $userid=$business['user_id'];                    $users = array();                    $users=$this->getUpUser($userid);                    if($users['user_id'])                    {                        for ($i = 0; $i < 3; $i++) {                            if($users['user_id']){                                //                          echo "用户id=".$users['id']."正在插入订单<br/>";                                if($users['utype']==20)                                {//                                     echo ($i+1)."级是推客<br/>";                                    //添加用户分销记录并赋余额                                    $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    //添加推客分销记录                                    $this->addTkOrder($users['user_id'],$order,$users['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    return true;                                }else {//                                     echo ($i+1)."级普通兜客<br/>";                                    //添加用户分销记录并赋余额                                    $this->addUserOrder($users['user_id'],$order,$i+1,$users['utype'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                    $users=$this->getUpUser($users['user_id']);                                }                            }else {//                                  echo ($i+1)."级没有兜客了<br/>";                            }                        }                    }else                    {//                         echo "该用户没有上级<br/>";                    }//                         echo "3级都没有推客，找到本人的推客进行分配收益<br/>";                    $wheretk['user_id'] = array('eq',$userid);                    $user1=M('user')->where($wheretk)->find();                    //                 echo M('user')->getLastSql();                    if($user1)                    {                        $tk_pid=$user1['tk_pid'];                        if($tk_pid){                            //                         echo "推客用户id=".$tk_pid."正在插入订单<br/>";                            $wheretkuser['user_id'] = array('eq',$tk_pid);                            $usertk=M('user')->where($wheretkuser)->select();                            //     echo M('user')->getLastSql();                            //       var_dump($usertk);                            //添加推客分销记录                            $this->addTkOrder($tk_pid,$order,$usertk[0]['level'],$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                        }else {//                                       echo "该用户没有推客<br/>";                        }                    }else {//                            echo "该用户没有推客<br/>";                    }                    return  true;                }else                {//                     echo "该订单没有分销功能";                    return  false;                }            }else            {//                  echo "该订单没有完成";                return  false;            }//               echo "订单已完成，准备分销<br/>";        }else        {//                   echo "数据库没有该订单";        }        return  false;    }    /**     * @author : Jeffery     * @time : 2018.2.1     * @重新编写推客二级收益 --- 交易     */    # 获取推客上级    public function getUpTkUser($i,$user_id)    {        # one step        if($i == 0)        {            // xxxx            return array();        }else if($i == 1) # 上级        {            $tk_pid = M("user")->where(array('user_id'=>$user_id))->getField('tk_pid');            $uptkpid = $this->getCurrentLevelUser($tk_pid);            $res['up'] = $uptkpid;            if($uptkpid) # 上上级            {                /*                $tk_pid = M("user")->where(array('user_id'=>$user_id))->getField('tk_pid');                $up_tk_pid = M("user")->where(array('user_id'=>$tk_pid))->getField('tk_pid');                */                $res['upup'] = $this->getCurrentLevelUser($uptkpid['tk_pid']);            }        }        return $res;    }    # 获取当前机构信息    public function getInstitutionInfo($institution_id)    {        $info = M("institution")->field('institution_id,lirun_bl')->where(array('institution'=>$institution_id))->find();        return $info;    }    # 固定收益 -- 交易    public function fenxiaoTkLevelOrder($order)    {        # dump($order);        if(!$order)        {            return false;        }        $cwhere['sh_ordersn'] = array('eq',$order);        $cwhere['money_type_id'] = array('in','25');  # 上级推客/机构        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {            return false;        }        $where['pt_ordersn'] = array('eq',$order);        $orderarr=M('money_detailed')->where($where)->select();        if($orderarr) {            if ($orderarr[0]['jy_status'] == 1) {                $wheretype['money_type_id'] = array('eq', $orderarr[0]['money_type_id']);                $money_type = M('money_type')->where($wheretype)->select();                if ($money_type[0]['dis_type'] == 1) {                    $userid=$orderarr[0]['user_id'];                    $users = $this->getCurrentLevelUser($userid);                    # dump($users);die;                    if($users['utype'] != 20)  # 推客做交易，一律不分                    {                        $userUtype = M("user")->field('pid,user_id,utype')->where(array('user_id'=>trim($users['pid'])))->find();                        if($userUtype)                        {                            if($userUtype['utype']==20)                            {                                $users['tk_pid'] = $userUtype['user_id'];                            }                        }                                                if($users['tk_pid'])                        {                            $i = 1;                            if ($i == 1) {                                if($users['tk_pid']){                                    $tkutype = $this->getCurrentLevelUser($users['tk_pid']);    //                                dump($tkutype);                                    if($tkutype['utype'] == 20)                                    {                                        $upUser = $this->getUpTkUser($i,$users['tk_pid']);                                        foreach ($upUser as $k => $v)                                        {                                            if($k == 'upup')                                            {                                                $uptkid = $this->getCurrentLevelUser($tkutype['tk_pid']);                                                $level = $uptkid['level'];                                            }else{                                                $level = $tkutype['level'];                                            }                                            $this->fenxiaoTkaddOrder($v['user_id'],$level,$v['level'],$k,$order,$orderarr[0]['pay_money'],$orderarr[0]['user_pay_supply_id']);                                        }                                    }                                }                            }                        }                    }                }            }        }    }    # 推客收益订单 $is_sj = 1有上级推客 2无 --- 交易    public function fenxiaoTkaddOrder($userid,$dnlevel,$level,$k,$sh_ordersn,$money,$pay_type,$is_sj=2)    {        $upinfo = M("user")->field('user_id,pid,tk_pid')->where(array('user_id'=>$userid))->find();        if(!$upinfo)        {            return false;        }        $leve = $level;        # 第一等级        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        # 第二等级        $wherejx['distribution_level_id'] = array('eq',$dnlevel);        $distributionjx=M('distribution_level')->where($wherejx)->select();        $commission=$distribution[0]['commission1'] - $distributionjx[0]['commission1'];//        echo '--'.$k.'--'.$distribution[0]['levelname'].$commission."%：";        $where['user_pay_supply_id'] = array('eq',$pay_type);        $distribution=M('user_pay_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=$money*($yy_rate-$pt_rate)/1000*$commission/100;        $levelname = M("distribution_level")->where(array('distribution_level_id'=>$leve))->getField('levelname');        # echo '--'.$money.'--'.(($yy_rate-$pt_rate)/1000).($commission/100)."%：";        $type="25";        $typename = $this->getType($type); //类型名称        /*            dump($upinfo);            dump($ratemoney);            dump($levelname);            dump($dnlevel);            dump($level);            echo '<hr>';        */        $blarray = array(            'commission_bl' => 0,            'commission_summoney' => 0,            'commission_fr_bl' => trim($commission/100),            'commissioncommission_fr_summoney' => trim($ratemoney/($commission/100))        );        # dump($blarray);        $this->fenxiaoTkCreatOrder($userid,$ratemoney,$sh_ordersn,$pay_type,$type,$typename,$blarray);        # R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    # 机构收益订单    public function fenxiaoJgaddOrder($userid,$sh_ordersn,$leve,$upuplevel,$money,$pay_type)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        if($upuplevel)        {            $commission = 100 - $distribution[0]['commission1'];        }//        echo '----'.$distribution[0]['levelname'].$commission."%：";        $where['user_pay_supply_id'] = array('eq',$pay_type);        $distribution=M('user_pay_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=$money*($yy_rate-$pt_rate)/1000*$commission/100;//        echo '原本价格：'.$money.',所得固定收益：'.$ratemoney;//        echo '<br/>';//        echo '<hr/>';        $type="26";        $typename = $this->getType($type); //类型名称        $this->fenxiaoJgCreatOrder($userid,$ratemoney,$sh_ordersn,$pay_type,$type,$typename);        # R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---兜客分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /*        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");        */    }    # 固定收益 -- 结算    public function fenxiaoTkJsLevelOrder($order)    {        if(!$order)        {            return false;        }        $cwhere['sh_ordersn'] = array('eq',$order);        $cwhere['money_type_id'] = array('in','27');  # 上级推客/机构        $corderarr=M('money_detailed')->where($cwhere)->select();        if($corderarr)        {            return false;        }        $where['pt_ordersn'] = array('eq',$order);        $orderarr=M('moneyjs_detailed')->where($where)->select();        if($orderarr) {            if ($orderarr[0]['js_status'] == 2) {                $wheretype['settlement_type_id'] = array('eq',$orderarr[0]['type']);                $money_type=M('settlement_type')->where($wheretype)->select();                if ($money_type[0]['dis_type'] == 1) {                    $userid=$orderarr[0]['user_id'];                    $users = $this->getCurrentLevelUser($userid);                    if($users['utype'] != 20)  # 推客做交易，一律不分                    {                        $userUtype = M("user")->field('pid,user_id,utype')->where(array('user_id'=>trim($users['pid'])))->find();                        if($userUtype)                        {                            if($userUtype['utype']==20)                            {                                $users['tk_pid'] = $userUtype['user_id'];                            }                        }                                                if($users['tk_pid'])                        {                            $i = 1;                            if ($i == 1) {                                if($users['tk_pid']){                                    $tkutype = $this->getCurrentLevelUser($users['tk_pid']);                                    //                                dump($tkutype);                                    if($tkutype['utype'] == 20)                                    {                                        $upUser = $this->getUpTkUser($i,$users['tk_pid']);                                        foreach ($upUser as $k => $v)                                        {                                            if($k == 'upup')                                            {                                                $uptkid = $this->getCurrentLevelUser($tkutype['tk_pid']);                                                $level = $uptkid['level'];                                            }else{                                                $level = $tkutype['level'];                                            }                                            $this->fenxiaoTkJsaddOrder($v['user_id'],$level,$v['level'],$k,$order,$orderarr[0]['js_money'],$orderarr[0]['user_js_supply_id']);                                        }                                    }                                }                            }                        }                    }                }            }        }    }    # 推客收益订单 $is_sj = 1有上级推客 2无 --- 结算    public function fenxiaoTkJsaddOrder($userid,$dnlevel,$level,$k,$sh_ordersn,$money,$pay_type,$is_sj=2)    {        $upinfo = M("user")->field('user_id,pid,tk_pid')->where(array('user_id'=>$userid))->find();        if(!$upinfo)        {            return false;        }        $leve = $level;        # 第一等级        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        # 第二等级        $wherejx['distribution_level_id'] = array('eq',$dnlevel);        $distributionjx=M('distribution_level')->where($wherejx)->select();        $commission=$distribution[0]['commission1'] - $distributionjx[0]['commission1'];//        echo '--'.$k.'--'.$distribution[0]['levelname'].$commission."%：";        $where['user_js_supply_id'] = array('eq',$pay_type);        $distribution=M('user_js_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=($yy_rate-$pt_rate)*$commission/100;        $levelname = M("distribution_level")->where(array('distribution_level_id'=>$leve))->getField('levelname');//        echo '--'.$money.'--'.(($yy_rate-$pt_rate)/1000).($commission/100)."%：";        $type="27";        $typename = $this->getType($type); //类型名称        /*            dump($upinfo);            dump($ratemoney);            dump($levelname);            dump($dnlevel);            dump($level);            echo '<hr>';        */        $blarray = array(            'commission_bl' => 0,            'commission_summoney' => 0,            'commission_fr_bl' => trim($commission/100),            'commissioncommission_fr_summoney' => trim($ratemoney/($commission/100))        );            $this->fenxiaoTkCreatOrder($userid,$ratemoney,$sh_ordersn,$pay_type,$type,$typename,$blarray);        # R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /**/        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");    }    # 机构收益订单    public function fenxiaoJgJsaddOrder($userid,$sh_ordersn,$leve,$upuplevel,$money,$pay_type)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        if($upuplevel)        {            $commission = 100 - $distribution[0]['commission1'];        }//        echo '----'.$distribution[0]['levelname'].$commission."%：";        $where['user_js_supply_id'] = array('eq',$pay_type);        $distribution=M('user_js_supply')->where($where)->select();        $yy_rate=$distribution[0]['yy_rate']; //运营费率        $pt_rate=$distribution[0]['tk_rate']; //推客费率        //所得分销利润        $ratemoney=($yy_rate-$pt_rate)*$commission/100;//        echo '原本价格：'.$money.',所得固定收益：'.$ratemoney;//        echo '<br/>';//        echo '<hr/>';        $type="26";        $typename = $this->getType($type); //类型名称        $this->fenxiaoJgCreatOrder($userid,$ratemoney,$sh_ordersn,$pay_type,$type,$typename);        # R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---兜客分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /*        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$userid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");        */    }    # 生成订单 - 针对用户    public function fenxiaoTkCreatOrder($userid,$money,$sh_ordersn,$pay_type,$type,$goods_name,$blarray=array())    {        $pt_ordersn="TKUP". date("YmdHis",time()).mt_rand(10,99).$userid;        $where['user_id'] = array('eq',$userid);        $user=M('user')->where($where)->select();        $usermoneybf=$user[0]['money'];        $usermoneyat=$usermoneybf+$money;        M('user')->where($where)->save(array(            'money'=>$usermoneyat  // 得利润        ));        $mondata['user_id'] = $userid;        $mondata['goods_name'] = $goods_name;        $mondata['user_pay_supply_id'] = $pay_type;        $mondata['benefit'] = $money;        $mondata['goods_type'] = '推客上级收益';        $mondata['pay_name'] = '系统自动分配';        $mondata['pt_ordersn'] = $pt_ordersn;        $mondata['sh_ordersn'] = $sh_ordersn;        $mondata['jy_status'] = 1;        $mondata['js_status'] = 4;        $mondata['before_money'] = trim($usermoneybf);        $mondata['after_money'] = trim($usermoneyat);        $mondata['money'] = $money;        $mondata['money_type_id'] = intval($type);        $mondata['t'] = time();        $mondata['d_t'] = time();        $mondata["commission_bl"] = $blarray['commission_bl'];  # 佣金比例        $mondata["commission_summoney"] = $blarray['commission_summoney']; # 订单总佣金        $mondata["commission_fr_bl"] = $blarray['commission_fr_bl'];  # 分润比例        $mondata["commissioncommission_fr_summoney"] = $blarray['commissioncommission_fr_summoney'];  # 订单总分润        # 添加分销表        $ids = M("money_detailed")->add($mondata);        if($ids){            return true;        } else {            return false;        }    }    # 生成订单 - 针对机构 $userid = 机构ID    public function fenxiaoJgCreatOrder($userid,$money,$sh_ordersn,$pay_type,$type,$goods_name)    {        $pt_ordersn="JG". date("YmdHis",time()).mt_rand(10,99).$userid;        $where['institution_id'] = array('eq',$userid);        $user=M('institution')->where($where)->select();        $usermoneybf=$user[0]['money'];        $usermoneyat=$usermoneybf+$money;        M('institution')->where($where)->save(array(            'money'=>$usermoneyat  // 得利润        ));        $mondata['user_id'] = $userid;        $mondata['goods_name'] = $goods_name;        $mondata['user_pay_supply_id'] = $pay_type;        $mondata['benefit'] = $money;        $mondata['goods_type'] = '机构固定收益';        $mondata['pay_name'] = '系统自动分配';        $mondata['pt_ordersn'] = $pt_ordersn;        $mondata['sh_ordersn'] = $sh_ordersn;        $mondata['jy_status'] = 1;        $mondata['js_status'] = 4;        $mondata['before_money'] = trim($usermoneybf);        $mondata['after_money'] = trim($usermoneyat);        $mondata['money'] = $money;        $mondata['money_type_id'] = intval($type);        $mondata['t'] = time();        $mondata['d_t'] = time();        # 添加分销表        $ids = M("money_detailed")->add($mondata);        if($ids){            return true;        } else {            return false;        }    }    /**     * @author : Jeffery     * @time : 2018.1.19     * 缴费收益  -  针对品牌服务费所得收益 ( 合伙人/机构 )     * 请在缴费成功支付之后，再调用     */    public function fenxiaoPartnerJgOrder($order)    {        $opinfo = M("jfpay_log")->where(array('pt_ordersn'=>$order))->find();        if(!$opinfo)        {            # 订单不存在            return false;        }else        {            $user_id = $opinfo['user_id'];            if($user_id)            {                $money = $opinfo['price']/($opinfo['sf']/100+1);                # 合伙人（ 上级合伙人 ）                $userInfo = $this->getCurrentLevelUser($user_id);                # 上级机构                $institution_id = trim($userInfo['institution_id']);                if($institution_id)                {                    $this->fenxiaoPartnerJgaddOrder($institution_id,$order,7,$money);                }                if($userInfo['tk_pid'])                {                    $pidLevel = $this->getCurrentLevelUser($userInfo['tk_pid']);                    if($pidLevel['level'] != 9)                    {                        # 不是合伙人身份                        return false;                    }else{                        $this->fenxiaoPartnerJgaddOrder($userInfo['tk_pid'],$order,9,$money);                    }                }            }        }    }    # 添加合伙人/机构收益订单    public function fenxiaoPartnerJgaddOrder($userid,$sh_ordersn,$leve,$money)    {        $where['distribution_level_id'] = array('eq',$leve);        $distribution=M('distribution_level')->where($where)->select();        # 合伙人        if($leve == 9)        {            $type = 1;            $commission=$distribution[0]['ppf_commission'];        }else if($leve == 7){            $wherejx['distribution_level_id'] = array('eq',9);            $type = 2;            $distributionjx=M('distribution_level')->where($wherejx)->select();            $commission=$distribution[0]['ppf_commission'] - $distributionjx[0]['ppf_commission'];        }//        echo '----'.$distribution[0]['levelname'].$commission."%：";        $ratemoney=$money*$commission/100;//        echo $leve.'等级，'.$commission.'%，原本价格：'.$money.',所得固定收益：'.$ratemoney;////        echo '<br/>';//        echo '<hr/>';        $this->fenxiaoPartnerJgCreatOrder($userid,$ratemoney,$sh_ordersn,$type,$commission,$money);        # R("Payapi/Api/PaySetLog", array("./PayLog", "myfenxiao__", '---- ---兜客分润 ----' . json_encode($ratemoney).'---'.json_encode($distribution)));        /*        sendToUser("{\"fromid\":\"1\",\"fromname\":\"钱兜兜\",\"user_id\":\"".$us   erid."\",\"name\":\"\",\"token\":\"cebced47c9d6c22c9ed9c6df528caace83f04edb1a52780b49f53e975001bed4\",\"msg\":\"您所得".$typename.number_format($ratemoney,4)."元\",\"operation\":\"text\",\"sound\":\"default\",\"content-available\":\"1\"}");        */    }    # 生成订单    public function fenxiaoPartnerJgCreatOrder($userid,$money,$sh_ordersn,$type,$bl,$pay_money)    {        $pt_ordersn="PPFSY". date("YmdHis",time()).mt_rand(10,99).$userid;        if($type==2) {            $where['institution_id'] = array('eq', $userid);            $user = M('institution')->where($where)->select();            $usermoneybf = $user[0]['money'];        }else if($type==1){            $where['user_id'] = array('eq', $userid);            $user = M('user')->where($where)->select();            $usermoneybf = $user[0]['money'];        }        $usermoneyat=$usermoneybf+$money;        /*        if($type==2)        {            M('institution')->where($where)->save(array(                'money'=>$usermoneyat  // 得利润            ));        }else{            M('user')->where($where)->save(array(                'money'=>$usermoneyat  // 得利润            ));        }        */        $mondata['user_id'] = $userid;        $mondata['type'] = $type;        $mondata['profit'] = $money;        $mondata['bl'] = $bl;        $mondata['pt_ordersn'] = $pt_ordersn;        $mondata['sh_ordersn'] = $sh_ordersn;        $mondata['money'] = $pay_money;        $mondata['money_type_id'] = intval($type);        $mondata['t'] = time();        # 添加分销表        $ids = M("jiaofei_sy")->add($mondata);        if($ids){            return true;        } else {            return false;        }    }    # 获取当前等级信息 - 用户表    public function getCurrentLevelUser($userid)    {        $users = array();        $where['user_id'] = array('eq',trim($userid));        $user1=M('user')->where($where)->select();        //    echo M('user')->getLastSql();        if($user1)        {            $user2=$user1;            $user1id=$user2[0]['user_id'];            $pid=$user2[0]['pid'];            $tk_pid=$user2[0]['tk_pid'];            $institution_id=$user2[0]['institution_id'];            $level=$user2[0]['level'];            $utype=$user2[0]['utype'];            $money=$user2[0]['money'];            $users['user_id']=$user1id;            $users['pid']=$pid;            $users['institution_id']=$institution_id;            $users['tk_pid']=$tk_pid;            $users['level']=$level;            $users['utype']=$utype;            $users['money']=$money;        }        return $users;    }}    ?>