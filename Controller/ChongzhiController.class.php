<?php# 银钱包 - 话费流量充值模块 namespace Payapi\Controller;use Think\Controller;class ChongzhiController extends BaseController {    public $signType;    public $timestamp;    public $dataType;    public $inputCharset;    public $version;    public $parem;    public $sign;    public function _initialize()    {        $this->parem=array(            'signType'=>$_REQUEST['signType'],            'timestamp' => $_REQUEST['timestamp'],            'dataType' => $_REQUEST['dataType'],            'inputCharset' => $_REQUEST['inputCharset'],            'version' => $_REQUEST['version'],            # 上面是固定            # 我们要传的参数//            'key' => json_decode($_REQUEST['key'],true)        );        $this->sign=$_REQUEST['sign'];//        https://wallet.insoonto.com/Payapi/Chongzhi/index?signType=MD5&timestamp=20171116150321&dataType=KEYVALUE&inputCharset=UTF-8&version=1.0&sign=md5(signType=MD5&timestamp=20171116150321&dataType=KEYVALUE&inputCharset=UTF-8&version=1.0)//        https://wallet.insoonto.com/Payapi/Chongzhi/index&signType=xxxx&.......&key="{nicknamew:'小李子',phone:13112157790}"//        $this->signType =$_REQUEST['sign'];//        $this->timestamp = $_REQUEST['timestamp'];//        $this->dataType = $_REQUEST['dataType'];//        $this->inputCharset = $_REQUEST['inputCharset'];//        $this->version = $_REQUEST['version'];    }    //话费产品    public function index(){//         $this->parem['key'] = json_encode($keyarr);/*注释加密 上线放开*///         $this->sign = $_REQUEST['sign']; //加密字符串//        $phone = $_REQUEST['phone']; //加密字符串//////         $msg = R('Func/Func/getKey',array($this->parem));//返回加密//////        dump($msg);die;////        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;////        }////         if ($this->sign !== $msg){////             echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;////         }////        R('Func/Func/getTwoSign',array($this->sign));////        $_SESSION['last_sign'] = $this->sign;        /*注释加密 上线放开*/        $m2m=new \Org\Util\M2M;        $arr=$m2m->getPhone($phone);        $arr['supplier']='移动';        if($arr['supplier']=='移动'){            $plat='yd';        }else if($arr['supplier']=='联通'){            $plat='liantong';        }else if($arr['supplier']=='电信'){            $plat='dx';        }        $where['type'] = 'money';        if($plat){            $where['plat'] = $plat;        }        $where['status']=1;        $where['activ']=2;        $list = M('Product')->where($where)->order("price asc")->group("unit")->limit(0,9)->select();//首次获取        $maxMoney = M('activity')->where(array('activity_id' => 3))->getField('month_money');        $discount=M('activity')->where(array('activity_id' => 3))->getField('percentage');        foreach ($list as$k=>$v){            $list[$k]['id']=$v['product_id'];            $list[$k]['fee'] = round($v['price']*$discount,2);//推客75折话费        }//        $list = M('Product')->where($where)->order("price asc")->group("price")->limit(0,9)->select();        $d = array(            'code' => 3001,            'msg' => '话费充值',            'data' => $list        );        echo json_encode($d);exit;    }    //流量产品    public function liuliang(){        $this->sign = $_REQUEST['sign']; //加密字符串        $phone = $_REQUEST['phone']; //加密字符串        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign == $_SESSION['last_sign']){            echo json_encode(array('code'=>10006,'msg'=>'禁止第二次访问'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $m2m=new \Org\Util\M2M;        $arr=$m2m->getPhone($phone);        if($arr['supplier']=='移动'){            $plat='yd';        }else if($arr['supplier']=='联通'){            $plat='liantong';        }else if($arr['supplier']=='电信'){            $plat='dx';        }        $where['type'] = 'flow';        if($plat){            $where['plat'] = $plat;        }        $where['status']=1;        $where['activ']=2;//        $list = M('chongzhi')->where($where)->order("price asc")->group("price")->limit(0,9)->select();        $list = M('Product')->where($where)->order("price asc")->group("unit")->limit(0,9)->select();        foreach ($list as$k=>$v){            $list[$k]['id']=$v['product_id'];        }        $d = array(            'code' => 3002,            'msg' => '流量充值',            'data' => $list        );        echo json_encode($d);exit;    }    /*     *获取流量产品    */    public function getflow(){        $name=$_REQUEST['unit'];//获取名称        $phone=$_REQUEST['phone'];//获取名称        $uid=$_REQUEST['user_id'];//新增一个参数 user_id//        $this->sign = $_REQUEST['sign'];////        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;////        }////        $array=array(////            'unit'=>$name,////        );////        $this->parem = array_merge($this->parem,$array);////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密////        if ($this->sign !== $msg){////            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;////        }////        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)////        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $m2m=new \Org\Util\M2M;        $arr=$m2m->getPhone($phone);        if($arr['supplier']=='移动'){            $plat='yd';        }else if($arr['supplier']=='联通'){            $plat='liantong';        }else if($arr['supplier']=='电信'){            $plat='dx';        }        $where['type'] = 'flow';        $where['unit'] = $name;        if($plat){            $where['plat'] = $plat;        }        $where['area'] = 1;        $where['activ']=2;        $utype = M('user')->where(array('user_id'=>$uid))->getField('utype');        $flow_rate=M('activity')->where(array('activity_id' => 3))->getField('flow_rate');        $list = M('Product')->where($where)->group('area')->limit(2)->select();        foreach ($list as$k=>$v){            $list[$k]['id']=$v['product_id'];            if ($utype == '20'){                $list[$k]['tk_fee'] = $v['fee'];//                $list[$k]['fee'] = $v['fee']*$flow_rate;            }else{                $list[$k]['tk_fee'] = $v['dfee'];            }        }        $d = array(            'code' => 3001,            'msg' => '流量',            'data' => $list        );        echo json_encode($d);exit;     }    //Q币    public function qbi(){//         $this->parem['key'] = json_encode($keyarr);        $this->sign = $_REQUEST['sign']; //加密字符串        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign));        $_SESSION['last_sign'] = $this->sign;        $where['type'] = 'Qbi';        $where['status']=1;        $where['activ']=2;        $list = M('Product')->where($where)->order("price asc")->group("unit")->limit(0,9)->select();//        $list = M('Product')->where($where)->order("price asc")->group("price")->limit(0,9)->select();        foreach ($list as$k=>$v){            $list[$k]['id']=$v['product_id'];        }        $d = array(            'code' => 3001,            'msg' => 'Q币充值',            'data' => $list        );        echo json_encode($d);exit;    }    //加油卡    public function refuel(){//         $this->parem['key'] = json_encode($keyarr);        $this->sign = $_REQUEST['sign']; //加密字符串        $plat = $_REQUEST['plat']; //加密字符串/*测试时候注释 上线放开*/        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign));        $_SESSION['last_sign'] = $this->sign;        /*测试时候注释 上线放开*/        $where['type'] = 'refuel';        $where['plat'] = $plat;        $where['status']=1;        $where['activ']=2;        $list = M('Product')->where($where)->order("price asc")->group("unit")->limit(0,9)->select();        foreach ($list as$k=>$v){            $list[$k]['id']=$v['product_id'];        }//        $list = M('Product')->where($where)->order("price asc")->group("price")->limit(0,9)->select();        $d = array(            'code' => 3001,            'msg' => '加油卡',//            'data' => $list            'data' => $list        );        echo json_encode($d);exit;    }    /*   *根据手机号获取话费流量产品   */    public function getGoodsByAjax(){        $type=$_REQUEST['type']; //类型  money      flow        $uid=$_REQUEST['user_id']; //user_id        $phone=$_REQUEST['phone'];  //手机号码        $activ=$_REQUEST['activ'];  //手机号码        /*注释加密 上线放开*///        if(!$type){////            echo json_encode(array('code'=>'4001','msg'=>'参数错误'));die;////            //output_error('参数错误');////        }//        $this->sign = $_REQUEST['sign'];////        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;////        }////        $array=array(////            'type'=>$_REQUEST['type'],////            'phone'=>$_REQUEST['phone']////        );////        $this->parem = array_merge($this->parem,$array);//////        dump($this->parem);die;////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//////        if ($this->sign !== $msg){////            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;////        }////        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)////        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        /*注释加密 上线放开*///        if ($type == 'flow'){////            $area = $_REQUEST['area'];////        }//        $user_info=$this->userModel;        if($phone){            $m2m=new \Org\Util\M2M;            $arr=$m2m->getPhone($phone);            $province=$arr['province'];//省份            $supplier=$arr['supplier'];//运营商//            $arr['supplier']='联通';            if($arr['supplier']=='移动'){                $plat='yd';            }else if($arr['supplier']=='联通'){                $plat='liantong';            }else if($arr['supplier']=='电信'){                $plat='dx';            }        }        if($plat){//运营商            $where['plat']=$plat;        }        if($activ){  //运营商            $where['activ']=$activ;        }else{            $where['activ']=2;        }        $where['status']=1;        // 类型 话费或流量        if($type){            $where['type']=$type;        }        //判断类型是不是流量 流量区分全国和省        if($type=='flow' && $area){            if($area==1){                $where.=" and area=1 ";  //全国流量            }else if($area==0){                $where.=" and area=0 ";  //省内流量                if($province){                    $where.=" and province like '%".$province."' ";                }            }        }        $registerPhone = M('user')->where(array('user_id'=>$uid))->getField('phone');        $utype=M('user')->where(array('user_id'=>$uid))->getField('utype');        if(!$registerPhone){            echo json_encode(array('code'=>'1011','msg'=>'不存在的用户'));die;        }//        dump($registerPhone);die;        //echo $where; exit();        $datalist=M('Product')->where($where)->order("price asc")->group("unit")->select();        #统计本月话费充值金额        $start_time = strtotime(date('Y-m-01', strtotime(date("Y-m-d"))));        $year = date("Y");        $month = date("m");        $allday = date("t");        $end_time = strtotime($year."-".$month."-".$allday);        $end_time = $end_time+86399; //本月最后一天时间戳        $map['pay_time'] = array(array('gt',$start_time),array('lt',$end_time), 'AND');        $map['user_id']=$uid;        $map['type'] = 'money';        $map['pay_status'] = 1;        $map['activ'] = 1; //活动        $sumMoney = M('chongzhi_order')->where($map)->sum('units');        $maxMoney = M('activity')->where(array('activity_id' => 3))->getField('month_money');        $discount=M('activity')->where(array('activity_id' => 3))->getField('percentage');        $flow_rate=M('activity')->where(array('activity_id' => 3))->getField('flow_rate');        if ($sumMoney >= $maxMoney){ #本月充值大于500元//            echo json_encode(array('code'=>'1011','msg'=>'您本月充值的话费大于500元'));die;            foreach ($datalist as$k=>$v){                $datalist[$k]['id']=$v['product_id'];                if ($utype == '20'){                    if ($type == 'money'){ #话费                        if ($phone == $registerPhone){                            $datalist[$k]['tk_fee'] = $v['fee'];//                            $datalist[$k]['fee'] = round($v['price'] * $discount,2);                        }else{                            $datalist[$k]['tk_fee'] = $v['fee'];                            $datalist[$k]['fee'] = $v['fee'];                        }    //                $datalist[$k]['activ'] = 2;                    }else{                        $datalist[$k]['tk_fee'] = $v['fee'];                        $datalist[$k]['fee'] = $v['fee'] * $flow_rate;                    }                }             }        }else{  #小于500元 可充            foreach ($datalist as$k=>$v){                $datalist[$k]['id']=$v['product_id'];                #可以不用显示75折优惠   输入自己注册的手机号 可以享受75折 输入其他人的号码不能享受75折                if ($type == 'money'){ #话费                    if($utype == '20'){                        if ($phone == $registerPhone){                            $datalist[$k]['tk_fee'] = $v['fee'];                            $datalist[$k]['fee'] = round($v['price']*$discount,2);                            $datalist[$k]['activ'] = 1; //活动                        }                    }else{                        $datalist[$k]['tk_fee'] = $v['fee'];                    }                }else{                    if($utype == '20'){                        $datalist[$k]['tk_fee'] = $v['fee'];                        $datalist[$k]['fee'] = $v['fee'] * $flow_rate;                    }else{                        $datalist[$k]['tk_fee'] = $v['fee'];                    }                }            }        }        if(!$plat){ //运营商            $datalist=array();        }        // print_r($datalist); exit();        //echo M('chongzhi')->getLastSql(); exit();        echo json_encode(array(            'code'=>'3001',            'msg'=>'获取参数',            'data'=>array(                'phone'=>$arr,                'data'=>$datalist                )            )); exit();    }    #显示 金额  +提示    public function BlockMoney(){        $goodsid = $_REQUEST['goodsid'];        $phone=$_REQUEST['phone']; //充值手机号码        $uid = $_REQUEST['uid']; //用户        $goods=M("Product")->find($goodsid);  //查询产品//        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在','ret_msg'=>'加密字符串不存在'));die;////        }        $userInfo = M('user')->where(array('user_id'=>$uid))->find();        if (!$userInfo){            echo json_encode(array('code'=>'4003','ret_msg'=>'用户不存在'));die;        }        $maxMoney = M('activity')->where(array('activity_id' => 3))->getField('month_money');        $discount=M('activity')->where(array('activity_id' => 3))->getField('percentage');        $flow_rate=M('activity')->where(array('activity_id' => 3))->getField('flow_rate');        if($goods['type'] == 'money') //话费        {            if ($userInfo['utype'] == '20') { #仅限推客                if ($phone == $userInfo['phone']) {                    $fee = round($goods['price'] * $discount,2); //推客价格                }else{                    $fee = $goods['fee']; //推客价格                }                $beginToday = mktime(0, 0, 0, date('m'), date('d'), date('Y'));                $endToday = mktime(0, 0, 0, date('m'), date('d') + 1, date('Y')) - 1;                #统计今日的额度 是否已满                $all['pay_time'] = array(array('gt', $beginToday), array('lt', $endToday), 'AND');                $all['type'] = 'money';                $all['pay_status'] = 1;                $all['activ'] = 1; //活动                $toDaySumMoney = M('chongzhi_order')->where($all)->sum('units');                $sumCountMoney = M('activity')->where(array('activity_id' => 3))->getField('charge');                if ($toDaySumMoney > $sumCountMoney) { #总的充值金额大于今日额度                    $fee = $goods['fee'];  //换回普通推客金额 不是975折                    $tishi='今日的额度已用完,请明天再来';//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                }                if ($toDaySumMoney + $fee > $sumCountMoney) { #充值的金额 + 总的充值金额大于今日额度                    $fee = $goods['fee'];  //换回普通推客金额 不是975折                    $tishi = '今日的额度已用完,请明天再来,已为您切换为平常价格';//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                }                #统计本月话费充值金额                $start_time = strtotime(date('Y-m-01', strtotime(date("Y-m-d"))));                $year = date("Y");                $month = date("m");                $allday = date("t");                $end_time = strtotime($year . "-" . $month . "-" . $allday);                $end_time = $end_time + 86399; //本月最后一天时间戳                $map['pay_time'] = array(array('gt', $start_time), array('lt', $end_time), 'AND');                $map['user_id'] = $uid;                $map['type'] = 'money';                $map['pay_status'] = 1;                $map['activ'] = 1; //活动                $sumMoney = M('chongzhi_order')->where($map)->sum('units');                if ($sumMoney + $fee > $maxMoney) {                    $fee = $goods['fee']; //换回普通推客金额 不是975折                    $tishi = '您本月享受9.75折话费超过本月最大限度,已为您切换为平常价格';//                    echo json_encode(array('code'=>'4003','ret_msg'=>'您本月享受9.75折话费超过本月最大限度'));die;                }            }else{                $tkJg = round($goods['price']*$discount,2);                $tishi='推客仅需'.$tkJg;                $fee = $goods['dfee']; //推客价格            }            if (!$tishi){                $tishi='推客仅需'.$goods['price']*0.975;            }        }elseif($goods['type'] == 'flow'){ #流量            if($userInfo['utype'] == '20'){ #推客流量享受9折//                $tishi = '推客充值流量享受9折优惠';                $tishi='';                $fee = $goods['fee'] *$flow_rate;            }else{                $tkJg = $goods['fee']*$flow_rate;                $tishi='';//                $tishi = '推客仅需'.$tkJg;                $fee=$goods['dfee']; //兜客价格            }        }        echo json_encode(array('code'=>'1003','msg'=>'获取成功','ret_msg'=>'获取成功','fee'=>$fee,'tishi'=>$tishi));    }    //保存话费流量订单 余额支付  (第一步)    public function buyOrder(){        $goodsid = $_REQUEST['goodsid'];        $phone=$_REQUEST['phone']; //充值手机号码        $activ=$_REQUEST['activ']; //活动状态 1 是9.75, 2是普通价格        $pay_type=$_REQUEST['pay_type'];        if($pay_type==2){            $pay_type= '余额支付'; //付款方式 2余额3微信        }elseif ($pay_type==3){            $pay_type= '微信支付'; //付款方式 1余额 2微信        }else{            echo json_encode(array('code'=>5,'ret_msg'=>'请选择付款方式','msg'=>'请选择付款方式'));die;        }        $uid = $_REQUEST['uid']; //用户        $area=$_REQUEST['area']; //省内外        $this->sign = $_REQUEST['sign']; //加密字符串        $array=array(            'uid'=>$_REQUEST['uid'],            'goodsid'=>$_REQUEST['goodsid'],            'phone'=>$_REQUEST['phone']        );/*测试注释 正式放开*///        $this->parem = array_merge($this->parem,$array);////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密////        if ($this->sign !== $msg){////            echo json_encode(array('code'=>10004,'ret_msg'=>'禁止访问','msg'=>'禁止访问'));die;////        }////        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)////        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断//        $goods=M("Product")->find($goodsid);  //查询产品////        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在','ret_msg'=>'加密字符串不存在'));die;////        }//        $userInfo = M('user')->where(array('user_id'=>$uid))->find();        if (!$userInfo){            echo json_encode(array('code'=>'4003','ret_msg'=>'用户不存在'));die;        }        $maxMoney = M('activity')->where(array('activity_id' => 3))->getField('month_money');        $discount=M('activity')->where(array('activity_id' => 3))->getField('percentage');        $flow_rate=M('activity')->where(array('activity_id' => 3))->getField('flow_rate');        if($activ==1){ //活动话费 75折//            $map['activ']=1;//            $map['phone']=$phone;//            $map['pay_status']=1;//            $goods1=M("chongzhi_order")->where($map)->order('time desc')->limit(2)->select();  //查询订单  $time=strtotime('+ 1 month',$time);//            $time1=strtotime(date('Y-m',time()));//获取当月1号时间戳//            if($goods1) {////                $goodstime = strtotime(date('Y-m', $goods1[0]['time']));////                $goodstime1 = strtotime(date('Y-m', $goods1[1]['time']));////                if($time1==$goodstime || $time1==$goodstime1){//                    echo json_encode(array('ret_code'=>4,'ret_msg'=>'该活动每个号码每两个月只能参与一次'));die;//                }//            }        if($goods['type'] == 'money') //话费        {            if($userInfo['utype'] == '20'){ #仅限推客                if ($phone == $userInfo['phone']){                    $fee = round($goods['price'] * $discount,2); //推客价格                }else{                    $fee=$goods['fee']; //推客价格                }                $beginToday=mktime(0,0,0,date('m'),date('d'),date('Y'));                $endToday=mktime(0,0,0,date('m'),date('d')+1,date('Y'))-1;                #统计今日的额度 是否已满                $all['pay_time'] = array(array('gt',$beginToday),array('lt',$endToday), 'AND');                $all['type'] = 'money';                $all['pay_status'] = 1;                $all['activ'] = 1; //活动                $toDaySumMoney=M('chongzhi_order')->where($all)->sum('units');                $sumCountMoney = M('activity')->where(array('activity_id'=>3))->getField('charge');                if ($toDaySumMoney > $sumCountMoney){ #总的充值金额大于今日额度                    $fee = $goods['fee'];  //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                }                if ($toDaySumMoney+$fee > $sumCountMoney){ #充值的金额 + 总的充值金额大于今日额度                    $fee = $goods['fee'];  //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                }                #统计本月话费充值金额                $start_time = strtotime(date('Y-m-01', strtotime(date("Y-m-d"))));                $year = date("Y");                $month = date("m");                $allday = date("t");                $end_time = strtotime($year."-".$month."-".$allday);                $end_time = $end_time+86399; //本月最后一天时间戳                $map['pay_time'] = array(array('gt',$start_time),array('lt',$end_time), 'AND');                $map['user_id']=$uid;                $map['type'] = 'money';                $map['pay_status'] = 1;                $map['activ'] = 1; //活动                $sumMoney = M('chongzhi_order')->where($map)->sum('units');                if ($sumMoney+$fee > $maxMoney ){                    $fee = $goods['fee']; //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'您本月享受9.75折话费超过本月最大限度'));die;                }            }else{                $fee=$goods['dfee']; //兜客价格            }        }elseif($goods['type'] == 'flow'){ #流量            if($userInfo['utype'] == '20'){ #推客流量享受9折                $fee = $goods['fee'] *$flow_rate;            }else{                $fee=$goods['dfee']; //兜客价格            }        }            $unit= $goods['unit'];        }else{   //判断本月金额是否已经充满,判断今日额度是否已满            if($goods['type'] == 'money') //话费            {                if ($userInfo['utype'] == 20) { #推客                    if ($phone == $userInfo['phone']) {                        $fee = round($goods['price'] * $discount,2); //推客价格                    }else {                        $fee = $goods['fee']; //推客价格                    }                    $beginToday = mktime(0, 0, 0, date('m'), date('d'), date('Y'));                    $endToday = mktime(0, 0, 0, date('m'), date('d') + 1, date('Y')) - 1;                    #统计今日的额度 是否已满                    $all['pay_time'] = array(array('gt', $beginToday), array('lt', $endToday), 'AND');                    $all['type'] = 'money';                    $all['pay_status'] = 1;                    $all['activ'] = 1; //活动                    $toDaySumMoney = M('chongzhi_order')->where($all)->sum('units');                    $sumCountMoney = M('activity')->where(array('activity_id' => 3))->getField('charge');                    if ($toDaySumMoney > $sumCountMoney) { #总的充值金额大于今日额度                        $fee = $goods['fee'];  //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                    }                    if ($toDaySumMoney + $fee > $sumCountMoney) { #充值的金额 + 总的充值金额大于今日额度                        $fee = $goods['fee'];  //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'今日的额度已用完,请明天再来.'));die;                    }                    #统计本月话费充值金额                    $start_time = strtotime(date('Y-m-01', strtotime(date("Y-m-d"))));                    $year = date("Y");                    $month = date("m");                    $allday = date("t");                    $end_time = strtotime($year . "-" . $month . "-" . $allday);                    $end_time = $end_time + 86399; //本月最后一天时间戳                    $map['pay_time'] = array(array('gt', $start_time), array('lt', $end_time), 'AND');                    $map['user_id'] = $uid;                    $map['type'] = 'money';                    $map['pay_status'] = 1;                    $map['activ'] = 1; //活动                    $sumMoney = M('chongzhi_order')->where($map)->sum('units');                    if ($sumMoney + $fee > $maxMoney) {                        $fee = $goods['fee']; //换回普通推客金额 不是975折//                    echo json_encode(array('code'=>'4003','ret_msg'=>'您本月享受9.75折话费超过本月最大限度'));die;                    }                } else {                    $fee = $goods['dfee']; //兜客价格                }            }elseif($goods['type'] == 'flow'){ //流量                if($userInfo['utype'] == '20'){ #推客流量享受9折                    $fee = $goods['fee'] *$flow_rate;                }else{                    $fee=$goods['dfee']; //兜客价格                }            }            $unit=$goods['unit'];            $activ=1;        }        if ($userInfo['wallet_money'] < $fee && $_REQUEST['pay_type']==2){            echo json_encode(array('code'=>'4008','ret_msg'=>'您的账户余额不足'));die;        }        if(!$goodsid || !$phone || !$pay_type){            echo json_encode(array('code'=>'4006','ret_msg'=>'参数错误')); exit();        }        if(!preg_match("/^1[23456789]{1}\d{9}$/",$phone)){            echo json_encode(array('code'=>'4002','ret_msg'=>'手机号码错误')); exit();        }        if(!$goods['fee']){            echo json_encode(array('code'=>'4004','ret_msg'=>'金额未配置')); exit();        }        if($goods['is_jifen']==1){            $jifen=$goods['ri_jifen'];        }else{            $jifen=0;        }        $type=$goods['type'];  //产品类型 分为money(话费)和flow(流量)        if(!$type){            echo json_encode(array('code'=>'4005','ret_msg'=>'type error')); exit();        }        if($type=='money'){            $ordernum='HFCZ'.create_ordernos();            /**此处添加优惠券**/            $cuponid=trim($_REQUEST['coupon_data_id']);            if($cuponid){                //如果传入优惠券                $cupon=M('coupon_data')->where(array('coupon_data_id'=>$cuponid,'used'=>0))->field('user_id,coupon_id')->find();   //查询优惠券领取用户ID  优惠券id                if(!empty($cupon)){                    //比较优惠券 uid                    if($uid!=$cupon['user_id']){                        echo json_encode(array('code'=>400,'ret_msg'=>'暂无优惠券可使用')); exit();                    }                    $cupons=M('coupon')->where(array('coupon_id'=>$cupon['coupon_id'],'status'=>'1'))->field('name,money,full_price,start_time,end_time,coupontype')->find();   //查询优惠券信息                    //优惠券不存在或者已关闭                    if(empty($cupons)){                        echo json_encode(array('code'=>400,'ret_msg'=>'暂无优惠券可使用')); exit();                    }                    $time=time();                    //不在优惠券时间内使用                    if( $time > $cupons['end_time']){                        echo json_encode(array('code'=>400,'ret_msg'=>'优惠券已过期')); exit();                    }                    if($time < $cupons['start_time']){                        echo json_encode(array('code'=>400,'ret_msg'=>'请在规定时间内使用优惠券')); exit();                    }                    //判断 满减优惠券金额                    if($cupons['coupontype']==2){//满减                        if($fee < $cupons['full_price']){                            echo json_encode(array('code'=>400,'ret_msg'=>'未满足优惠券使用条件')); exit();                        }else{                            $fee=$fee-$cupons['money'];//扣除优惠券后金额                            $datas['coupon_fee']=$cupons['money'];//优惠券金额                            $datas['coupon_title']=$cupons['name'];//优惠券名称                            $datas['coupon_id']=$cuponid;//优惠券名称                        }                    }                    elseif($cupons['coupontype']==1){//立减                        $fee=$fee-$cupons['money'];//扣除优惠券后金额                        $coupondata['used']=1;                        $datas['coupon_fee']=$cupons['money'];//优惠券金额                        $datas['coupon_title']=$cupons['name'];//优惠券名称                        $datas['coupon_id']=$cuponid;//优惠券名称                    }                }else{                    echo json_encode(array('code'=>400,'ret_msg'=>'暂无优惠券可使用')); exit();                }            }            #  系统平台订单号            $platform_ordersn = "300".date('YmdHis').get_timeHm();        }        elseif($type=='flow'){            $ordernum='LLCZ'.create_ordernos();            #  系统平台订单号            $platform_ordersn = "400".date('YmdHis').get_timeHm();        }        if(!$ordernum){            echo json_encode(array('code'=>'4011','ret_msg'=>'订单生成失败')); exit();        }        $lirun=$goods['lirun']; //利润        $return_fee=$goods['return_fee'];//        $activ=$goods['activ'];//        $act_type=$activ==1?'c1':'';        $act_type='';        $time=time();        if($phone){            $m2m=new \Org\Util\M2M;            $arr=$m2m->getPhone($phone);            $province=$arr['province'];//省份//            $arr['supplier']='联通';            if($arr['supplier']=='移动'){                $plat='yd';            }else if($arr['supplier']=='联通'){                $plat='liantong';            }else if($arr['supplier']=='电信'){                $plat='dx';            }        }        $data = array(            "user_id" => $uid,//            "openid" => cookie('openid'),            "phone" => $phone,            "units" => $unit,            "product_id" => $goods['product_id'],            "fee" => $fee,            "lirun" => $lirun,            "goodsname" => $goods['pname'],            "isfukuan" => "未付款",            "ischongzhi" => "未充值",            "order_number" => $ordernum,//生成订单            "platform_ordersn" => $platform_ordersn,  # 平台订单号            "type" => $type,            "province" => $province,            "plat" => $plat,            "time"=>$time,            "pay_type"=>$pay_type,            'activ'=>$activ,            'return_fee'=>$return_fee?$return_fee:0,            'act_type'=>$act_type        );        if(!empty($datas)){            $data=array_merge($data,$datas);        }        if($activ){            $tongdao=self::level($goods['product_id']);            if(empty($tongdao)){                echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;            }            $inId=M('chongzhi_order')->add($data);        }else{            $tongdao=self::level($goods['product_id']);            if(empty($tongdao)){                echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;            }            $inId=M('chongzhi_order')->add($data);//                $inId=M('chongzhi_order')->add($data);//                //此处新增活动话费的订单//                $ordernum1='HFCZ'.create_ordernos();//////            #  系统平台订单号//            $platform_ordersn = "300".date('YmdHis').get_timeHm();////            $time=strtotime('+ 1 month',$time);////            $time=strtotime(date('Y-m-15 00:00:00',$time));//保存为下个月十五号0点时间////            $data1 = array(////                    "user_id" => $uid,//////            "openid" => cookie('openid'),//                    "units" => $unit,//商品规格 实际充值////                    "phone" => $phone,//////            'cztongdao_id'=>$goods['cztongdao_id'],////                    "product_id" => $goods['product_id'],////                    "fee" => 0,////                    "lirun" => $lirun,////                    "goodsname" => $goods['pname'],////                    "isfukuan" => "未付款",////                    "ischongzhi" => "未充值",////                    "order_number" => $ordernum1,////                    "platform_ordersn" => $platform_ordersn,  # 平台订单号////                    "type" => $type,////                    "province" => $province,////                    "plat" => $plat,////                    "time"=>$time,////                    "pay_type"=>$pay_type,////                    'activ'=>$activ,////                    'return_fee'=>0,////                    'last_order_number'=>$ordernum,////                    'act_type'=>'c2'////                );////                $inId1=M('chongzhi_order')->add($data1);        }        if(!$inId){            echo json_encode(array('code'=>4010,'ret_msg'=>'订单生成失败')); exit();        }        else{            if($coupondata['used'] && $coupondata['used']==1){                M('coupon_data')->where(array('coupon_data_id'=>$cuponid))->save($coupondata);//修改优惠券使用状态为已使用            }            if($_REQUEST['pay_type']==3){//微信支付的时候 调用方法返回微信参数                $res = R("Payapi/WeixinPay/APPczpay",array($data));                echo json_encode(array('code'=>4009,'wxpay'=>$res,'order_id'=>$inId)); exit();            }            else{                echo json_encode(array('code'=>4009,'ret_msg'=>'订单生成成功','order_id'=>$inId)); exit();            }        }    }    //Q币 加油卡保存订单 余额支付  (第一步)    public function buyOrder1(){        $goodsid = $_REQUEST['goodsid'];        $account=$_REQUEST['account']; //充值账号        $plat=$_REQUEST['plat']; //充值账号        $accountname=urldecode($_REQUEST['accountname']); //充值账号        $phone=$_REQUEST['phone']; //充值手机号码 非必须 加油卡充值传送        $ip = $_REQUEST['ip']; //充值账号  加油卡 Q币使用        if($_REQUEST['pay_type']==2){            $pay_type= '余额支付'; //付款方式 2余额3微信        }        elseif ($_REQUEST['pay_type']==3){            $pay_type= '微信支付'; //付款方式 1余额 2微信        }        $plat= $_REQUEST['plat'] ; //付款方式 1余额 2微信        $uid = $_REQUEST['uid']; //用户        $this->sign = $_REQUEST['sign']; //加密字符串        $array=array(            'uid'=>$_REQUEST['uid'],            'goodsid'=>$_REQUEST['goodsid'],            'account'=>$_REQUEST['account']        );        $this->parem = array_merge($this->parem,$array);//        dump($this->parem);die;        /*测试注释 上线放开*/        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问','ret_msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断//        $goods=M("Product")->find($goodsid);  //查询产品//        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在','ret_msg'=>'加密字符串不存在'));die;        }        /*测试注释 上线放开*/        $userInfo = M('user')->where(array('user_id'=>$uid))->find();        if (!$userInfo){            echo json_encode(array('code'=>'4003','ret_msg'=>'用户不存在'));die;        }        if ($userInfo['wallet_money'] < $goods['fee']  && $_REQUEST['pay_type']==2){            echo json_encode(array('code'=>'4008','ret_msg'=>'您的账户余额不足'));die;        }        if(!$goodsid || !$pay_type || !$account){            echo json_encode(array('code'=>'4006','ret_msg'=>'参数错误'.$account.$goodsid.$pay_type)); exit();        }        if(!$goods['fee']){            echo json_encode(array('code'=>'4004','ret_msg'=>'金额未配置')); exit();        }        if($goods['is_jifen']==1){            $jifen=1;        }else{            $jifen=0;        }        $type=$goods['type'];  //产品类型 加油卡 Q币        if(!$type){            echo json_encode(array('code'=>'4005','ret_msg'=>'type error')); exit();        }        if($type=='Qbi'){            $ordernum='QBCZ'.create_ordernos();            // 系统平台订单号            $platform_ordersn = "500".date('YmdHis').get_timeHm();        }elseif($type=='refuel'){            $ordernum='JYCZ'.create_ordernos();            $platform_ordersn = "600".date('YmdHis').get_timeHm();        }        if(!$ordernum){            echo json_encode(array('code'=>'4011','ret_msg'=>'订单生成失败')); exit();        }        if($userInfo['utype']==20){            $fee=$goods['fee']; //推客价格        }else{            $fee=$goods['dfee']; //兜客价格        }        ////        $fee=$goods['fee']; //价格        $lirun=$goods['lirun']; //利润        $data = array(            "user_id" => $uid,//            "openid" => cookie('openid'),            "account" => $account,            "accountname" => $accountname,            "phone" => $phone,            "plat" => $plat,            "units" => $goods['unit'],            "product_id" => $goods['product_id'],            "fee" => $fee,            "lirun" => $lirun,            "goodsname" => $goods['pname'],            "isfukuan" => "未付款",            "ischongzhi" => "未充值",            "order_number" => $ordernum,//生成订单            "platform_ordersn"=> $platform_ordersn, # 平台订单号            "type" => $type,            "plat" => $plat,            "time"=>time(),            "ip"=>$ip,//            "tongdao" => $goods['tongdao'],  //充值通道            "pay_type"=>$pay_type        );        // print_r($data); exit();        $tongdao=self::level($goods['product_id']);        if(empty($tongdao)){            echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;        }        $inId=M('chongzhi_order')->add($data);        if(!$inId){            echo json_encode(array('code'=>4010,'ret_msg'=>'订单生成失败')); exit();        }else{            if($_REQUEST['pay_type']==3){                $res = R("Payapi/WeixinPay/APPczpay",array($data));                echo json_encode(array('code'=>4009,'wxpay'=>$res,'order_id'=>$inId)); exit();            }else{                echo json_encode(array('code'=>4009,'ret_msg'=>'订单生成成功','order_id'=>$inId)); exit();            }        }    }        //判断支付密码是否正确  (第二步)    public function payPassword(){            $pawd = $_REQUEST['pawd'];//支付密码            $uid = $_REQUEST['uid']; //用户            $this->sign= $_REQUEST['sign'];            $array=array(                'uid'=>$uid,                'pawd'=>$pawd            );           $this->parem = array_merge($this->parem,$array);/*测试注释 上线放开*/        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        /*测试注释 上线放开*/            $userInfo = M('password')->where(array('user_id'=>$uid,'type'=>1))->find();            if (!$userInfo){                echo json_encode(array('code'=>'4011','ret_msg'=>'您未设置支付密码'));die;            }            if (md5(md5($pawd)) != $userInfo['pwd']){                echo json_encode(array('code'=>'4012','ret_msg'=>'支付密码错误'));die;            }else{                echo json_encode(array('code'=>'4013','ret_msg'=>'支付密码正确'));die;            }        }    //活动状态  (第三步)    public function activpay($order_id){        $order_info=M('chongzhi_order')->find($order_id);        $info = M('user')->where(array('user_id'=>$order_info['user_id']))->find();        if($order_info['pay_type']=='余额支付'){            $log['msg']='余额支付';            $tt['pay_name']='余额支付';            $tt['user_pay_supply_id']=21;            $info['wallet_money'] = $info['wallet_money'] - $order_info['fee'];//余额支付的时候，减去余额            $a=M('user')->save($info);            $order['isfukuan'] ='已付款';//付款完成，等待充值结果            $order['pay_time'] =time();//写入支付时间            $order['tongdao'] ='手动充值';//写入通道            $order['pay_status'] =1;//写入付款状态0未付款 1已付款            $ordernumber['order_number']=$order_info['order_number'];            //插入用户资金变动记录            $msg='话费余额支付'.$order_info['fee'].'元';            $log['msg']=$msg;            $log['user_id']=$info['user_id'];            $log['money']=$order_info['fee'];            $log['pn']='-';            $log['ordersn']= $order_info['order_number'];            $log['type']= 2;            $log['is_type']= 2;            $log['t']= time();            M('usermoney_log')->add($log);        }        elseif ($order_info['pay_type']=='微信支付'){            $log['msg']='微信支付';            $tt['user_pay_supply_id']=18;            $order['pay_time'] =time();//写入支付时间            $tt['pay_name']='微信支付';            $order['tongdao'] ='手动充值';//写入通道            $order['pay_status'] =1;//写入付款状态0未付款 1已付款            $ordernumber['order_number']=$order_info['order_number'];        }        $tt['user_id']=$info['user_id'];        $tt['goods_name'] = $order_info['goodsname'];        $tt['jy_status'] = 4;//结算状态 1结算中2结算成功3失败4未结算        $tt['money']= $order_info['fee']; //支付金额        $tt['tongdao']= '手动充值'; //充值通道        $tt['pay_money']=$order_info['fee'];        $tt['type']='money';        $tt['t']=time();        $tt['timestamp']=time();        $tt['phone']=$order_info['phone'];        $tt['money_type_id']=3;         M('money_detailed')->add($tt);        if($order_info['activ']==1){            $where['last_order_number']=$order_info['order_number'];            M("chongzhi_order")->where($where)->save($order);//修改活动话费第二个订单的状态        }        $zhuangtai1 = M('ChongzhiOrder')->where($ordernumber)->save($order);        if($zhuangtai1){            return true;        }else{            return false;        }    }    //发起充值(余额支付)  (第三步)    public function pay(){        $order_id = $_REQUEST['order_id'];//订单id        $supplier = urldecode($_REQUEST['supplier']);//运营商        $province = urldecode($_REQUEST['province']);//省份        $uid = $_REQUEST['uid']; //用户        $type = $_REQUEST['type']; //充值類型 flow流量 money话费        $this->sign= $_REQUEST['sign']; //加密字符串        $array=array(            'order_id'=>$order_id,            'supplier'=>$supplier,            'province'=>$province,            'uid'=>$uid,            'type'=>$type        ); //请求字符串        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$type){            echo json_encode(array('code'=>'4014','msg'=>'没有参数'));die;        }        if (!$order_id || !$uid){            echo json_encode(array('code'=>'4014','msg'=>'没有参数'));die;        }        $order_info=M('chongzhi_order')->find($order_id);        if(!$order_info){            echo json_encode(array('code'=>'4015','msg'=>'不存在的订单'));die;        }        if($order_info['activ']==1){            $tongdao=M('cztongdao')->where(array('name'=>'Activ'))->getField('isopen');            if($tongdao==0){                echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;            }            $a=$this->activpay($order_id);            if($a==true){                echo json_encode(array('code'=>'4017','msg'=>'支付成功'));die;            }else{                echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;            }        }        $tongdao=self::level($order_info['product_id']);        if(empty($tongdao)){            echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;        }        $jiesuan=false;        //流量支持通道 KaixinOne Banma        if($type=='flow'){            //流量            $area=I('area');            $area=1;            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道            if($res[0]==false){                if((count($tongdao)<=1)){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道                if($res1[0]==false){                    if((count($tongdao)<=1)){                        echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                    }                    array_shift($tongdao);                    $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道                    if($res2[0]==false){                        if((count($tongdao)<=1)){                            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                        }                        $order_info['return_msg']=$res['result']['ret_msg'];                        M('chongzhi_order')->save($order_info);                        echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                    }else{                        $jiesuan=$this->jiesuan('flow',$order_info,$res2[1],$uid,$tongdao[0]);                    }                }else{                    $jiesuan=$this->jiesuan('flow',$order_info,$res1[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('flow',$order_info,$res[1],$uid,$tongdao[0]);            }        }        elseif($type=='money'){            //话费支持通道kaixin1 kaixin2 19e banma            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道            if($res[0]==false){                if((count($tongdao)<=1)){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                if($res1[0]==false){                    if((count($tongdao)<=1)){                        echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                    }                    array_shift($tongdao);                    $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                    if($res2[0]==false){                        if((count($tongdao)<=1)){                            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                        }                        array_shift($tongdao);                        $res3=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                        if($res3[0]==false) {                            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                        }else{                            $jiesuan=$this->jiesuan('money',$order_info,$res3[1],$uid,$tongdao[0]);                        }                    }else{                        $jiesuan=$this->jiesuan('money',$order_info,$res2[1],$uid,$tongdao[0]);                    }                }else{                    $jiesuan=$this->jiesuan('money',$order_info,$res1[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('money',$order_info,$res[1],$uid,$tongdao[0]);            }        }        if($jiesuan==true){            echo json_encode(array('code'=>'4017','msg'=>'充值已受理！'));die;        }elseif ($jiesuan==false){            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;        }    }    //发起充值(微信支付)  (第三步)    public function wxchongzhi($orderid){        $order_info= M("chongzhi_order")->where(array('order_number'=>$orderid))->find();//查询订单信息        $order_number = $order_info['order_number'];//订单id        $plat = $order_info['plat'];//运营商        $province = $order_info['province'];//省份        $uid = $order_info['user_id']; //用户        $type = $order_info['type']; //充值類型 flow流量 money话费        if(!$order_info){            die;        }        $tongdao=self::level($order_info['product_id']);        if(empty($tongdao)){            die;        }        $jiesuan=false;        //流量支持通道 KaixinOne Banma        if($type=='flow'){            //流量//            $area=I('area');            $area=1;            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道            if($res[0]==false){                if((count($tongdao)<=1)){                    die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道                if($res1[0]==false){                    if((count($tongdao)<=1)){                        die;                    }                    array_shift($tongdao);                    $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat,$area);//选择通道                    if($res2[0]==false){                        if((count($tongdao)<=1)){                            die;                        }                        $order_info['return_msg']=$res['result']['ret_msg'];                        M('chongzhi_order')->save($order_info);                       die;                    }else{                        $jiesuan=$this->jiesuan('flow',$order_info,$res2[1],$uid,$tongdao[0]);                    }                }else{                    $jiesuan=$this->jiesuan('flow',$order_info,$res1[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('flow',$order_info,$res[1],$uid,$tongdao[0]);            }        }        elseif($type=='money'){            //话费支持通道kaixin1 kaixin2 19e banma            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道//            dump($res);die;            if($res[0]==false){                if((count($tongdao)<=1)){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                if($res1[0]==false){                    if((count($tongdao)<=1)){                        echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                    }                    array_shift($tongdao);                    $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                    if($res2[0]==false){                        if((count($tongdao)<=1)){                            die;                        }                        array_shift($tongdao);                        $res3=$this->ChoiceChannel($type,$tongdao,$order_info,$province,$plat);//选择通道                        if($res3[0]==false) {                            die;                        }else{                            $jiesuan=$this->jiesuan('money',$order_info,$res3[1],$uid,$tongdao[0]);                            return true;                        }                    }else{                        $jiesuan=$this->jiesuan('money',$order_info,$res2[1],$uid,$tongdao[0]);                        return true;                    }                }else{                    $jiesuan=$this->jiesuan('money',$order_info,$res1[1],$uid,$tongdao[0]);                    return true;                }            }else{                $jiesuan=$this->jiesuan('money',$order_info,$res[1],$uid,$tongdao[0]);                return true;            }        }        elseif($type=='Qbi'){            //话费支持通道kaixintwo 19e qy//            $tongdao=array('Banma');        $res=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip'],'');//选择通道        if($res[0]==false){            if((count($tongdao)<=1)){                echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;            }            array_shift($tongdao);//删除已使用的通道            $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip']);//选择通道            if($res1[0]==false){                if((count($tongdao)<=1)){                    die;                }                array_shift($tongdao);                $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip']);//选择通道                if($res2[0]==false){                    if((count($tongdao)<=1)){                        die;                    }                    array_shift($tongdao);                    $res3=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip']);//选择通道                    if($res3[0]==false) {                        die;                    }else{                        $jiesuan=$this->jiesuan('Qbi',$order_info,$res3[1],$uid,$tongdao[0]);                    }                }else{                    $jiesuan=$this->jiesuan('Qbi',$order_info,$res2[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('Qbi',$order_info,$res1[1],$uid,$tongdao[0]);            }        }else{            $jiesuan=$this->jiesuan('Qbi',$order_info,$res[1],$uid,$tongdao[0]);        }    }        elseif($type=='refuel'){            //加油卡 开心1 斑马        $res=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip'],'');//选择通道        if($res[0]==false){            if((count($tongdao)<=1)){                die;            }            array_shift($tongdao);            $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$order_info['ip']);//选择通道            if($res1[0]==false){                die;            }else{                $jiesuan=$this->jiesuan('refuel',$order_info,$res1[1],$uid,$tongdao[0]);            }        }else{            $jiesuan=$this->jiesuan('refuel',$order_info,$res[1],$uid,$tongdao[0]);        }    }    }    #2018 04 29 补单    public function buOrdercs(){        //  HFCZ1524918488085        $data = $this->wxchongzhi('HFCZ1526870529585');        dump($data);die;    }    //发起充值(余额支付)Q币 加油卡  (第三步)    public function pay1(){        $order_id = $_REQUEST['order_id'];//订单id        $uid = $_REQUEST['uid']; //用户        $type = $_REQUEST['type']; //充值類型 flow流量 money话费 Qbi refuel加油卡        $ip = $_REQUEST['ip']; //充值账号  加油卡 Q币使用        $this->sign= $_REQUEST['sign']; //加密字符串            $array=array(                'order_id'=>$order_id,                'ip'=>$ip,                'uid'=>$uid,                'type'=>$type            ); //请求字符串/*测试注释 上线放开*/        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        /*测试注释 上线放开*/        if (!$type){            echo json_encode(array('code'=>'4014','msg'=>'没有参数'));die;        }        if (!$order_id || !$uid){            echo json_encode(array('code'=>'4014','msg'=>'缺少参数'));die;        }        $order_info=M('chongzhi_order')->find($order_id);        if(!$order_info){            echo json_encode(array('code'=>'4015','msg'=>'不存在的订单'));die;        }        $tongdao=self::level($order_info['product_id']);        if(empty($tongdao)){            echo json_encode(array('code'=>'4015','msg'=>'该通道已关闭，请联系客服'));die;        }        $jiesuan=false;        if($type=='Qbi'){            //话费支持通道kaixintwo 19e qy//            $tongdao=array('Banma');            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$ip,'');//选择通道            if($res[0]==false){                if((count($tongdao)<=1)){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$ip);//选择通道                if($res1[0]==false){                    if((count($tongdao)<=1)){                        echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                    }                    array_shift($tongdao);                    $res2=$this->ChoiceChannel($type,$tongdao,$order_info,$ip);//选择通道                    if($res2[0]==false){                        if((count($tongdao)<=1)){                            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                        }                        array_shift($tongdao);                        $res3=$this->ChoiceChannel($type,$tongdao,$order_info,$ip);//选择通道                        if($res3[0]==false) {                            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                        }else{                            $jiesuan=$this->jiesuan('Qbi',$order_info,$res3[1],$uid,$tongdao[0]);                        }                    }else{                        $jiesuan=$this->jiesuan('Qbi',$order_info,$res2[1],$uid,$tongdao[0]);                    }                }else{                    $jiesuan=$this->jiesuan('Qbi',$order_info,$res1[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('Qbi',$order_info,$res[1],$uid,$tongdao[0]);            }        }        elseif($type=='refuel'){            //加油卡 开心1 斑马            $res=$this->ChoiceChannel($type,$tongdao,$order_info,$ip,'');//选择通道            if($res[0]==false){                if((count($tongdao)<=1)){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }                array_shift($tongdao);                $res1=$this->ChoiceChannel($type,$tongdao,$order_info,$ip);//选择通道                if($res1[0]==false){                    echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;                }else{                    $jiesuan=$this->jiesuan('refuel',$order_info,$res1[1],$uid,$tongdao[0]);                }            }else{                $jiesuan=$this->jiesuan('refuel',$order_info,$res[1],$uid,$tongdao[0]);            }        }        if($jiesuan==true){                echo json_encode(array('code'=>'4017','msg'=>'充值已受理！'));die;        }elseif ($jiesuan==false){            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;        }    }    // public function wxlogin(){    // 	header('Content-Type:text/html;charset=utf-8');    // 	//$user_id=('user_id');    //     	if($user_id){    //     		$d = array(    //             'code' => 3001,    //             'msg' => '已登录',    //            );    //         echo json_encode($d);exit;    // 	}else{    // 		//A('Wx')->wxLoginBase();    // 	}    // }        //根据手机号获取地区和服务商    public function phone(){        $phone=I('phone');//        $phone='13828136102';        $m2m=new \Org\Util\M2M;        $arr=$m2m->getPhone($phone);        $province=$arr['province'];        //print_r($arr); exit();        $msg=$province.$arr['supplier'];        //$msg='广东移动';        if($msg){            $ret_code=200;        }else{            $ret_code=400;        }        echo json_encode(array('code'=>$ret_code,'msg'=>$msg)); exit();    }    //话费流量充值记录    public function chongzhiRecord(){        $uid = $_REQUEST['uid'];        $this->sign= $_REQUEST['sign']; //加密字符串        $time= $_REQUEST['time']; //加密字符串        $page= $_REQUEST['page']?:1; //加密字符串        $array=array(            'uid'=>$uid,        ); //请求字符串        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$uid){            echo json_encode(array('code'=>6002,'msg'=>'不存在的参数'));die;        }        $msg = M('user')->where(array('user_id'=>$uid))->find();        if (!$msg){            echo json_encode(array('code'=>6003,'msg'=>'用户不存在'));die;        }        $benyue=array();        $shangyue=array();        $map['a.user_id'] = $uid;        $map['a.act_type'] = array('neq','c2');        $map['a.pay_status'] = 1;        $map['a.type']  = array('IN','money,flow');        $czorder=M('chongzhi_order');        $count      = $czorder->alias('a')->where($map)->count();// 查询满足要求的总记录数        $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数(25)        $show       = $Page->show();// 分页显示输出// 进行分页数据查询 注意limit方法的参数要使用Page类的属性        $info =  $czorder->alias('a')            ->field('a.chongzhi_order_id,a.user_id,a.phone,a.type,a.goodsname,a.ischongzhi,a.isfukuan,a.time,a.pay_time,a.product_id,a.fee,b.pname,a.plat,a.status')            ->join('inner join y_product as b on a.product_id=b.product_id')            ->order('a.time desc')            ->page($page.',15')            ->where($map)            ->select();        //匹配本月 上月 以及传入参数的时候的数据        foreach ($info as $k=>$v){            $benyue[]=$v;            if($time==date('Y-m',$v['time'])){                $select[]=$v;            }        }        if ($info){            echo json_encode(array('code'=>6001,'msg'=>'数据获取成功','data'=>array('benyue'=>$benyue,'shangyue'=>$shangyue,'select'=>$select,'total'=>$count)));die;        }else{            echo json_encode(array('code'=>6006,'msg'=>'数据为空'));die;        }    }    //话费流量充值记录    public function chongzhiRecord1(){        $uid = $_REQUEST['uid'];        $this->sign= $_REQUEST['sign']; //加密字符串        $time= $_REQUEST['time']; //加密字符串        $type= $_REQUEST['type']; //加密字符串        $page= $_REQUEST['page']?:1; //加密字符串        $array=array(            'uid'=>$uid,        ); //请求字符串        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$uid){            echo json_encode(array('code'=>6002,'msg'=>'不存在的参数'));die;        }        $msg = M('user')->where(array('user_id'=>$uid))->find();        if (!$msg){            echo json_encode(array('code'=>6003,'msg'=>'用户不存在'));die;        }        $benyue=array();        $shangyue=array();        $map['a.user_id'] = $uid;        $map['a.type']  = $type;        $map['a.pay_status'] = 1;        $czorder=M('chongzhi_order');        $count      = $czorder->alias('a')->where($map)->count();// 查询满足要求的总记录数        $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数(25)        $show       = $Page->show();// 分页显示输出// 进行分页数据查询 注意limit方法的参数要使用Page类的属性        $info =  $czorder->alias('a')            ->field('a.chongzhi_order_id,a.user_id,a.phone,a.type,a.goodsname,a.ischongzhi,a.isfukuan,a.time,a.pay_time,a.product_id,a.fee,b.pname,a.plat,a.status')            ->join('inner join y_product as b on a.product_id=b.product_id')            ->order('a.time desc')            ->page($page.',15')            ->where($map)            ->select();        //匹配本月 上月 以及传入参数的时候的数据        foreach ($info as $k=>$v){            if (date('Y-m',time()) == date('Y-m',$v['time'])){                $benyue[]=$v;            }            if (date('Y-m',$v['time']) == date('Y-m',strtotime('-1 month'))){                $shangyue[]=$v;            }            if($time==date('Y-m',$v['time'])){                $select[]=$v;            }        }        if ($info){            echo json_encode(array('code'=>6001,'msg'=>'数据获取成功','data'=>array('benyue'=>$benyue,'shangyue'=>$shangyue,'select'=>$select,'total'=>$count)));die;        }else{            echo json_encode(array('code'=>6006,'msg'=>'数据为空'));die;        }    }    //详细信息    public function orderDetail(){        $id = $_REQUEST['order_id'];        $this->sign = $_REQUEST['sign'];        $array=array(            'order_id'=>$id,        ); //请求字符串        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$id){            echo json_encode(array('code'=>6002,'msg'=>'参数不存在'));die;        }        $data = M('chongzhi_order')->where(array('chongzhi_order_id'=>$id))->find();        if (!$data){            echo json_encode(array('code'=>6004,'msg'=>'订单不存在'));die;        }        $info = M('chongzhi_order')->alias('a')->field('a.*,b.name')->join('left join y_cztongdao as b on a.cztongdao_id = b.cztongdao_id')->where(array('a.chongzhi_order_id'=>$id))->find();        $info['activ']=2;            if ($info){                if($info['activ']==2){                    $info1 = M('chongzhi_order')->alias('a')->field('a.*,b.name')->join('left join y_cztongdao as b on a.cztongdao_id = b.cztongdao_id')->where(array('a.last_order_number'=>$info['order_number']))->find();                    $info1['activ'] =2;                    echo json_encode(array('code'=>6005,'msg'=>'获取成功','data'=>$info,'data1'=>$info1));die;                }else{                    echo json_encode(array('code'=>6005,'msg'=>'获取成功','data'=>$info));die;                }            }else{                echo json_encode(array('code'=>6006,'msg'=>'数据为空'));die;            }    }    /**调用开心通道1 只有话费和全国流量     * @$type 充值类型     * @$data 订单信息     * @$i 转换通道次数     */    public function kaixinOne($type,$order_info,$ip){        $true=true;        $pay = new \Com\Kaixin\Chongzhi('KaixinOne');        if($type=='money'){//话费充值            $array['order_number'] = $order_info['order_number']; //订单号            $array['phone'] = $order_info['phone'];            $miane['price'] = $order_info['units'];            // $huafeiUrl='http://122.224.88.51:18080/mobile/charge.json';//测试//            $huafeiUrl='http://183.129.169.172:6666/mobile/charge.json';//正式            $huafeiUrl='http://www.aikaixin.com:6666/mobile/charge.json';//正式            $res = $pay->moneyCharge($array,$miane,$huafeiUrl); //话费充值            file_put_contents('./Public/log/kaixin1huafe.txt',json_encode($res), FILE_APPEND);            $res = json_decode($res,true);            if (!$res['result']){                $true=false;            }            if($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);        }        elseif($type=='Qbi'){            $qbiurl='http://183.129.169.172:6666/qq/charge.json';//正式//            $qbiurl='http://122.224.88.51:18080/qq/charge.json';//测试            //$province为ip            $array['order_number'] = $order_info['order_number']; //订单号            $array['account'] = $order_info['account'];            $array['unit'] = $order_info['units'];//充值具体数量//            $miane['price'] = 1;//面额            $qitaC['unit']=$order_info['units'];            $res = $pay->QbiCharges($array,$qitaC,$qbiurl,$ip); //Qbi            $res = json_decode($res,true);            if (!$res['result']){                $true=false;            }            if ($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);        }        elseif ($type=='refuel'){            $qbiurl='http://183.129.169.172:6666/fuel/charge.json';//正式//            $qbiurl='http://122.224.88.51:18080/fuel/charge.json';//测试地址            //$province为ip            $array['order_number'] = $order_info['order_number']; //订单号            $array['account'] = $order_info['account'];            if($order_info['plat']=='zsh'){                $array['isp_id']=9;            }elseif($order_info['plat']=='zsy'){                $array['isp_id']=8;            }            $qitaC['unit']=$order_info['units'];            $res = $pay->refuelCharges($array,$qitaC,$qbiurl); //Qbi            $res = json_decode($res,true);            if (!$res['result']){                $true=false;            }            if ($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);//            "pay_password": "B72172AABF7FDD8B00D6094F6CB97423",//		"order_no": "test20160101001",//		"account_no": "13666666666",//		"face_price": "100",//		"isp_id": "9"        }    }//开心全国流量    public function kaixinNew($type,$order_info,$ip){        $true=true;        if($type=='flow'){//流量充值            $pay = new \Com\Kaixin\Chongzhi('KaixinNew');            $liuliangUrl='http://ll.aikaixin.com:6666/charge.json';//正式//            $liuliangUrl='http://122.224.88.51:8280/charge.json';//测试地址            $liuliang['order_number'] = $order_info['order_number'];            $liuliang['phone']=$order_info['phone'];            $liuliang['area']=0;//1为省内 跟数据库字段相反            $qitaC['unit']=$order_info['units'];            $liuliang['fee']=$order_info['fee'];//            $qitaC['unit']='5M';            $res = $pay->flowCharge($liuliang,$qitaC,$liuliangUrl);            $res = json_decode($res,true);            file_put_contents('./Public/log/kaixinshengnei.txt',json_encode($res), FILE_APPEND);            if (!$res['result']){                $true=false;            }            if ($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);        }else{            $true=false;            return array($true,array());        }    }//开心省内流量    public function kaixinNew1($type,$order_info,$ip){        $true=true;        if($type=='flow'){  //流量充值            $pay = new \Com\Kaixin\Chongzhi('KaixinNew1');            $liuliangUrl='http://ll.aikaixin.com:6666/charge.json';//正式//            $liuliangUrl='http://122.224.88.51:8280/charge.json';//测试地址//            $liuliangUrl='http://183.129.169.172:6666/trafic/charge.json';//正式            $liuliang['order_number'] = $order_info['order_number'];            $liuliang['phone']=$order_info['phone'];            $liuliang['area']=1;//1为省内 跟数据库字段相反            $qitaC['unit']=$order_info['units'];            $liuliang['fee']=$order_info['fee'];            $res = $pay->flowCharge($liuliang,$qitaC,$liuliangUrl);            $res = json_decode($res,true);            file_put_contents('./Public/log/kaixinquanguo.txt',json_encode($res), FILE_APPEND);            if (!$res['result']){                $true=false;            }            if ($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);        }    }    //调用开心通道2    public function kaixinTwo($type,$order_info){        $true=true;        $pay = new \Com\Kaixin\Chongzhi('KaixinTwo');        if($type=='money'){//话费充值            $array['order_number'] = $order_info['order_number']; //订单号            $array['phone'] = $order_info['phone'];//            $miane['price'] = 1;//面额            $miane['price'] = $order_info['units'];//面额            // $huafeiUrl='http://122.224.88.51:18080/mobile/charge.json';//测试//            $huafeiUrl='http://183.129.169.172:6666/mobile/charge.json';//正式            $huafeiUrl='http://www.aikaixin.com:6666/mobile/charge.json';//正式            $res = $pay->moneyCharge($array,$miane,$huafeiUrl); //话费充值            file_put_contents('./Public/log/kaixin2huafe.txt',json_encode($res), FILE_APPEND);            $res = json_decode($res,true);            if($res['result']['ret_code'] != "10000000"){                $true=false;            }            return array($true,$res['body']);        }    }    //调用19e话费    public function eNineteen($type,$order_info,$plat){        $true=false;        $epay = new \Com\E19\Chongzhi('NineteenE');        if($type=='money'){//话费充值            $Msg['notify_url']="https://wallet.insoonto.com/index.php/Payapi/PayReturn/e19Return";//回调地址            $Msg['phone']=$order_info['phone'];//            $Msg['phone']='17052945852';            $Msg['order_number']=$order_info['order_number'];            $Msg['price']=$order_info['units'];            if($plat=='liantong'){                $Msg['plat']=0;            }elseif($plat=='yd'){                $Msg['plat']=1;            }else{                $Msg['plat']=2;            }//            $MoneyCan['price']=$order_info['10'];            $res=$epay->moneyCharge($Msg);            file_put_contents('./Public/log/19e.txt',json_encode($res), FILE_APPEND);            if($res['resultDesc']=='申请发货提交成功' && ($res['resultCode']=='SUCCESS')){                $true=true;            }        }        return array($true,$res);    }    //斑马话费 游戏 加油卡    public function banma($type,$order_info,$province,$supplier){        $true=true;        if($type=='money'){            $array['order_number'] = $order_info['order_number']; //订单号            $array['phone'] = $order_info['phone'];            $array['unit'] = $order_info['units'];//            $miane['price'] = 1;//面额            $where['type']='money';            $where['plat']=$order_info['plat'];            $where['unit']=$order_info['units'];            $itemid=M('Chongzhi')->where($where)->getField('third_goodsid');            $pay = new \Com\Qm\Chongzhi('Banma');            $res = $pay->moneyCharge($array,$itemid); //话费充值            $res = json_decode(json_encode($res),true);            file_put_contents('./Public/log/banmareturn.txt',json_encode($res), FILE_APPEND);            if(!$itemid){                $true=false;            }            if(!$res){                $true=false;            }            if(!$res['payState'] && $res['payState']!=1){                $true=false;            }            if($res['subErrors']){                $true=false;            }            return array($true,$res);        }        elseif($type=='Qbi'){            //$province为ip            $array['order_number'] = $order_info['order_number']; //订单号            $array['account'] = $order_info['account'];            $array['unit'] = $order_info['units'];//充值具体数量//            $miane['price'] = 1;//面额            $where['type']='Qbi';            $where['unit']=$order_info['units'];            $itemid=M('Chongzhi')->where($where)->getField('third_goodsid');            if(!$itemid){                $true=false;                return array($true,array());            }            $pay = new \Com\Qm\Chongzhi('Banma');            $res = $pay->qbiCharge($array,$itemid,$province); //Qbi $province此处应传入IP地址            $res = json_decode(json_encode($res),true);            if(!$itemid){                $true=false;            }            if(!$res){                $true=false;            }            if(!$res['payState'] && $res['payState']!=1){                $true=false;            }            if($res['subErrors']){                $true=false;            }            return array($true,$res);        }        elseif($type=='refuel'){            //$province为ip            $array['order_number'] = $order_info['order_number']; //订单号            $array['account'] = $order_info['account'];            $array['accountname'] = $order_info['accountname'];            $array['phone'] = $order_info['phone'];            $array['unit'] = $order_info['units'];//充值具体数量            $array['province'] = $order_info['province'];//充值具体数量//            $miane['price'] = 1;//面额            $where['tongdao']='Banma';            $where['type']='refuel';            $where['unit']=$order_info['units'];            $where['plat']=$order_info['plat'];            $itemid=M('Chongzhi')->where($where)->getField('third_goodsid');            if(!$itemid){                $true=false;                return array($true,array());            }            $pay = new \Com\Qm\Chongzhi('Banma');            $res = $pay->refuelCharge($array,$itemid,$province); //refuel $province此处应传入IP地址            $res = json_decode(json_encode($res),true);            if(!$itemid){                $true=false;            }            if(!$res){                $true=false;            }            if(!$res['payState'] && $res['payState']!=1){                $true=false;            }            if($res['subErrors']){                $true=false;            }            return array($true,$res);        }    }    //千力流量和视频卡    public function qianyi($type,$order_info,$province,$supplier){        $true=true;        if($type=='flow'){//流量通道            $array['order_number'] = $order_info['order_number']; //订单号            $array['phone'] = $order_info['phone'];//            $miane['price'] = 1;//面额            $where['type']='flow';            $where['province']=$order_info['province'];            $where['plat']=$order_info['plat'];            $where['area']=0;            $where['tongdao']='Qianyi';            $where['unit']=$order_info['units'];            $itemid=M('Chongzhi')->where($where)->getField('third_goodsid');//先查询chongzhi（充值产品表，斑马通道使用）省内流量            if(!$itemid){                $where1['type']='flow';                $where1['tongdao']='Qianyi';                $where1['unit']=$order_info['units'];                $where1['plat']=$order_info['plat'];                $where1['area']=1;                $itemid=M('Chongzhi')->where($where1)->getField('third_goodsid');//无省内流量，再查询国内流量            }            $pay = new \Com\Qm\Chongzhi('Qianyi');            $res = $pay->flowCharge($array,$itemid); //流量充值            $res = json_decode(json_encode($res),true);            file_put_contents('./Public/log/qianyi1.txt',json_encode($res), FILE_APPEND);            if(!$itemid){                $true=false;            }            if(!$res){                $true=false;            }            if($res['subErrors']){                $true=false;            }            if(!$res['payState']){                $true=false;            }            return array($true,$res);        }    }    /*查询充值接口按等级排序     */    public static function level($product_id){        if(!$product_id){            return false;        }else{            $where['product_id']=$product_id;            $tid=M('Product')->where($where)->getField('cztongdao');            $levels=M('Cztongdao')->query("select * from y_cztongdao where `cztongdao_id` in ($tid) And  `isopen`=1 ORDER BY FIND_IN_SET(`cztongdao_id`,'$tid')");            if(!empty($levels)){                foreach ($levels as $key=>$v){                    $level[$key]['cztongdao_id']=$v['cztongdao_id'];                    $level[$key]['name']=$v['name'];                }            }        }        return $level;    }    /*选择通道接入接口     *@$type [string]充值类型     * @$tongdao [array]通道     * @$province  [string]归属地     * @$supplier  [string]运营商     * @$area  [string]0省内 1全国    */    public function ChoiceChannel($type,$tongdao,$order_info,$province,$supplier,$area){        switch ($tongdao[0]['name']){            case 'KaixinOne':                $res=$this->kaixinOne($type,$order_info,$province);                return $res;            case 'KaixinTwo':                $res=$this->kaixinTwo($type,$order_info);                return $res;            case 'NineteenE':                $res=$this->eNineteen($type,$order_info,$supplier);                return $res;            case 'Banma':                $res=$this->banma($type,$order_info,$province,$supplier,$area);                return $res;            case 'Qianyi':                $res=$this->qianyi($type,$order_info,$province,$supplier,$area);                return $res;            case 'KaixinNew':                $res=$this->kaixinNew($type,$order_info,$province,$supplier,$area);                return $res;            case 'KaixinNew1':                $res=$this->kaixinNew1($type,$order_info,$province,$supplier,$area);                return $res;            default:                return array(false,array());                break;        }    }    public function jiesuan($type,$order_info,$res,$uid,$tongdao){        //减去余额        $info = M('user')->where(array('user_id'=>$uid))->find();        if($order_info['pay_type']=='余额支付'){            $log['msg']='余额支付';            $tt['pay_name']='余额支付';            $tt['user_pay_supply_id']=21;            $info['wallet_money'] = $info['wallet_money'] - $order_info['fee'];//余额支付的时候，减去余额            $a=M('user')->save($info);            $order['isfukuan'] ='已付款';//付款完成，等待充值结果            $order['pay_time'] =time();//写入支付时间            $order['tongdao'] =$tongdao['name'];//写入通道            $order['cztongdao_id'] =$tongdao['cztongdao_id'];//写入通道            $order['pay_status'] =1;//写入付款状态0未付款 1已付款            $ordernumber['order_number']=$order_info['order_number'];            //插入用户资金变动记录            $arr=array(                'money'=>'话费充值',                'flow'=>'流量充值',                'Qbi'=>'Q币充值',                'refuel'=>'加油卡充值',                'Scard'=>'视频卡充值',            );            $arr1=array(                'money'=>'2',                'flow'=>'6',                'Qbi'=>'8',                'refuel'=>'10',            );            $msg=$arr[$type].'余额支付'.$order_info['fee'].'元';            $log['msg']=$msg;            $log['user_id']=$info['user_id'];            $log['money']=$order_info['fee'];            $log['pn']='-';            $log['ordersn']= $order_info['order_number'];            $log['type']= $arr1[$info['type']];            $log['is_type']= 2;            $log['t']= time();            M('usermoney_log')->add($log);        }elseif ($order_info['pay_type']=='微信支付'){            $log['msg']='微信支付';            $tt['user_pay_supply_id']=18;            $order['pay_time'] =time();//写入支付时间            $tt['pay_name']='微信支付';            $order['tongdao'] =$tongdao['name'];//写入通道            $order['cztongdao_id'] =$tongdao['cztongdao_id'];//写入通道            $order['pay_status'] =1;//写入付款状态0未付款 1已付款            $ordernumber['order_number']=$order_info['order_number'];        }        if($order_info['fee']>=100){//计算是否添加积分            $jifen['num']=round($order_info['fee']/100);            $jifen['t']=time();            $jifen['price']=100;            $jifen['user_id']=$uid;            if($type=='money'){                $jifen['type']=1;            }            elseif ($type=='flow'){                $jifen['type']=1;            }            elseif ($type=='Qbi'){                $jifen['type']=3;            }            elseif ($type=='refuel'){                $jifen['type']=4;            }            M('jifen_jilu')->data($jifen)->add();        }        $tt['user_id']=$info['user_id'];        $tt['goods_name'] = $order_info['goodsname'];        $tt['pt_ordersn'] = $order_info['order_number'];        //加入平台扣款金额 payfee        if($tongdao['name']=='NineteenE'){            $tt['sh_ordersn'] = $res['ehfOrderId'];            $order['payfee'] = $res['payMoney'];        }elseif($tongdao['name']=='KaixinOne'|| $tongdao['name']=='KaixinTwo' || $tongdao['name']=='KaixinNew'|| $tongdao['name']=='KaixinNew1'){            $tt['sh_ordersn'] = $res['stream_id'];            $order['payfee'] = $res['pay_money'];        }elseif($tongdao['name']=='Banma'|| $tongdao['name']=='Qianyi'){            $tt['sh_ordersn'] = $res['billId'];            $order['payfee'] = $res['orderCost'];        }        $tt['jy_status'] = 4;//结算状态 1结算中2结算成功3失败4未结算        $tt['money']= $order_info['fee']; //支付金额        $tt['tongdao']= $tongdao['name']; //充值通道        $tt['pay_money']=$order_info['fee'];        $tt['type']=$type;        $tt['t']=time();        $tt['timestamp']=time();        $tt['phone']=$order_info['phone'];        if($type=='money'){            $tt['money_type_id']=3;        }elseif($type=='flow'){            $tt['money_type_id']=4;        }elseif($type=='Qbi'){            $tt['money_type_id']=22;            $tt['account']=$order_info['account'];        }elseif($type=='refuel'){            $tt['money_type_id']=23;            $tt['account']=$order_info['account'];        }        $pinfo = M('money_detailed')->add($tt);//        if (!$pinfo){////            echo json_encode(array('code'=>'4018','msg'=>'充值失败,系统繁忙'));die;////        }        $zhuangtai1 = M('ChongzhiOrder')->where($ordernumber)->save($order);        if ($zhuangtai1){            return true;        }else{            return false;        }    }    #开心One充值查询接口    public function kaixinOneSelect(){        $pay = new \Com\Kaixin\Chongzhi('KaixinOne');        $order='HFCZ1526870529585';        //HFCZ1526870529585        $info = $pay->getinfo($order,'money');        dump($info);die;    }}