<?php# 银钱包对接接口 - 微信api接口namespace Payapi\Controller;use Think\Controller;class WxController extends Controller{    public $wxconfig;    public $weid;    public function _initialize()    {        # $weid = isset($_REQUEST['weid'])?intval($_REQUEST['weid']):1;        $this->wxconfig = M('wxconfig')->where(array('is_check'=>1))->find();        $this->weid = $this->wxconfig['weid'];    }    // 微信被动执行器 -- 去掉    public function responseMsg()    {        $postArr = $GLOBALS["HTTP_RAW_POST_DATA"];        if (!empty($postArr)){            $postObj = simplexml_load_string($postArr, 'SimpleXMLElement', LIBXML_NOCDATA);            $MsgType = trim($postObj->MsgType);            M("test")->add(array('text'=>json_encode($MsgType)));        }else {            echo "";            exit;        }    }    // 处理第二个公众号 - 调试    public function weid2()    {        import('Vendor.WechatSdk.Wechat');//        ob_clean();        $options = array(            'token'=>'d8998b2a8464ead', //填写你设定的key            'encodingaeskey'=>'fefmkMqlcWMFRWqKwo4r1282C585p4oUktrFM6IH2m8', //填写加密用的EncodingAESKey            'appid'=>'wxb240eb8052bab1d3', //填写高级调用功能的app id            'appsecret'=>'554189ecff4b932c22925d2cc8e36a56', //填写高级调用功能的密钥            'debug'=>true        );        $weObj = new \Wechat($options);//        $weObj->valid();        /**/        $type = $weObj->getRev()->getRevType();//        M('cs')->add(array('text'=>$type));        R("Payapi/Api/PaySetLog",array("./PayLog","Api_authinfos_","最新关注公众号==> 原始信息 "."openid:".$weObj->getRevFrom()."类型：".$type."，微信信息".json_encode($weObj)."\r\n"));        /**/        $returnMsg = M('wx_text')->where(array('wx_text_id'=>1))->find();//        $weObj->text("你好")->reply();//        M('cs')->add(json_encode($weObj->errMsg));        /**/        switch($type) {            case "text":                $msg = $weObj->getRevContent();                if (trim($msg) == '1'){                    $textMsg='点击链接进入下载App:https://wallet.insoonto.com/download.php';                    $weObj->text($textMsg)->reply();                }elseif(trim($msg) == '2'){                    $textMsg='登录链接:https://wallet.insoonto.com/index.php/Wap/Login/login';                    $weObj->text($textMsg)->reply();                }elseif(trim($msg) == '3'){                    $textMsg='查看帮助手册:https://wallet.insoonto.com/Public/Wap/zn/handbook_2.html';                    $weObj->text($textMsg)->reply();                }else{                    //              M('cs')->where(array('user_id'=>'DK300000030'))->delete();                    $openid = $weObj->getRevFrom(); //拿到openid//                    $kf =$weObj->getCustomServiceKFlist();//客服列表//                    $kfInfo=json_decode($kf,true);                    $res =$weObj->transfer_customer_service()->reply();                }                break;            case "event"://                $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜商服”公众号目前为钱兜兜唯一官方微信客服渠道。";                $canshu = $weObj->getRevSceneId();//获取到二维码参数值                $openid = $weObj->getRevFrom();                $data=$weObj->getRevEvent();                R("Payapi/Api/PaySetLog",array("./PayLog","Api_WxCs_"," "."二维码参数:".$canshu."---类型:".json_encode($data)."----openid:".$openid."\r\n"));                if ($data['event'] == 'SCAN'){ #已关注扫码                    $textMsg="【1】获取钱兜兜App下载链接\n【2】获取进入钱兜兜登录链接\n【3】获取帮助手册\n您可以通过输入【】方括号里的编号获取内容哦,回复其他信息将接入钱兜兜客服哟";                    $weObj->text($textMsg)->reply();                }elseif($data['event'] == 'subscribe'){#未关注扫码                    $textMsg="【1】获取钱兜兜App下载链接\n【2】获取进入钱兜兜登录链接\n【3】获取帮助手册\n您可以通过输入【】方括号里的编号获取内容哦,回复其他信息将接入钱兜兜客服哟";                    $weObj->text($textMsg)->reply();                }elseif($data['event'] == 'unsubscribe'){#取消关注                    $textMsg="【1】获取钱兜兜App下载链接\n【2】获取进入钱兜兜登录链接\n【3】获取帮助手册\n您可以通过输入【】方括号里的编号获取内容哦,回复其他信息将接入钱兜兜客服哟";                    $weObj->text($textMsg)->reply();                }else{                    $textMsg="【1】获取钱兜兜App下载链接\n【2】获取进入钱兜兜登录链接\n【3】获取帮助手册\n您可以通过输入【】方括号里的编号获取内容哦,回复其他信息将接入钱兜兜客服哟";                    $weObj->text($textMsg)->reply();                }//                $textInfo='点击链接下载App: https://wallet.insoonto.com/download.php';//                $weObj->text($textInfo)->reply();                break;            default:                $textMsg="【1】获取钱兜兜App下载链接\n【2】获取进入钱兜兜登录链接\n【3】获取帮助手册\n您可以通过输入【】方括号里的编号获取内容哦,回复其他信息将接入钱兜兜客服哟";                $weObj->text($textMsg)->reply();//                $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜商服”公众号目前为钱兜兜唯一官方微信客服渠道。";//                $weObj->text($textInfo)->reply();        }    }    // 处理公众号对接    public function index()    {        import('Vendor.WechatSdk.Wechat');        $weid = intval($_REQUEST['weid']);        ob_clean();        $wxconfig = M('wxconfig')->where(array('weid'=>$weid))->find();        $options = array(            'token'=>$wxconfig['token'], //填写你设定的key            'encodingaeskey'=>$wxconfig['encodingaeskey'], //填写加密用的EncodingAESKey            'appid'=>$wxconfig['appid'], //填写高级调用功能的app id            'appsecret'=>$wxconfig['appsecret'], //填写高级调用功能的密钥            'debug'=>true        );        $weObj = new \Wechat($options);        $weObj->valid();    }    // 自动处理服务器配置验证    public function weid_index()    {        $weObj = R('Func/Wxapi/getConfig');        # ob_clean();        /**         * 如果想重新配置公众号         * 请在数据表中/后台菜单，切换is_check公众号，并且把下面代码注释掉( 108 _line         * ob_clean(); $weObj->valid();         *///        R("Payapi/Api/PaySetLog", array("./PayLog", "testReturn", '----微信配置----' . json_encode($_REQUEST)));//        $weObj->valid();        R("Payapi/Api/PaySetLog", array("./PayLog", "testReturn", '----微信配置----' . json_encode($_REQUEST)));        /**/        $type = $weObj->getRev()->getRevType();        M('cs')->add(array('text'=>$type));        R("Payapi/Api/PaySetLog",array("./PayLog","Api_authinfos_","原始关注公众号==> 原始信息 "."openid:".$weObj->getRevFrom()."类型：".$type."，微信信息".json_encode($weObj)."\r\n"));        $returnMsg = M('wx_text')->where(array('wx_text_id'=>1))->find();            switch($type) {                   case "text"://                       getRevContent   接收文本消息                    $msg = $weObj->getRevContent();//                                                   M('cs')->where(array('user_id'=>'DK300000030'))->delete();                    $openid = $weObj->getRevFrom(); //拿到openid//                    $kf =$weObj->getCustomServiceKFlist();//客服列表                    $condtion['textKey']=array("like","%{$msg}%");//                    $returnInfo = M('wx_text')->where($condtion)->find();                     M('cs')->add(array('text'=>json_encode($returnInfo)));                    if($returnInfo){                        $weObj->text($returnInfo['textReply'])->reply();                    }//                    $kfInfo=json_decode($kf,true);                    $res =$weObj->transfer_customer_service()->reply();//                    $ress = $weObj->getKFSession();//                    $res =$weObj->createKFSession($openid,'',$msg);//                    M('cs')->add(array('text'=>json_encode($res)));//                    $ress = $weObj->getRevKFCreate();//                    $ress = $weObj->closeKFSession($openid,'kf2005@yxtwallet',$msg);//                    $res =$weObj->createKFSession($openid,'kf2003@yxtwallet',$msg);//                    $weObj->getKFSessionWait();//                    $res =$weObj->transfer_customer_service('kf2008@yxtwallet')->reply();//                    $res =$weObj->createKFSession($openid,'kf2008@yxtwallet',$msg);//                    $info = R('Func/Wxapi/getText'); //返回数据库的数据////                    else{//                        $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜小助手”公众号目前为钱兜兜唯一官方微信客服渠道。";                    $textInfo='点击链接下载App: https://wallet.insoonto.com/download.php';                        //$returnMsg['textKey']                        $weObj->text($textInfo)->reply();//                    }////                    }                       exit;                       break;                   case "event":////                       $weObj->text($returnMsg['textKey'])->reply();                       $data=$weObj->getRevEvent(); //接收事件推送是否等于订阅(subscribe)事件,可获得事件和key                       //扫码事件                       //要根据  ..订阅..  公众号事件接下面的逻辑                       if ($data['event'] == 'SCAN'){  # 已关注扫码                            $openid = $weObj->getRevFrom(); //拿到openid//                           M('cs')->add(array('text'=>'1'.$openid));                            $canshu = $weObj->getRevSceneId();//获取到二维码参数值//                           M('cs')->add(array('text'=>'1'.$canshu));//                            $userInfo = $weObj->getUserInfo($openid); //根据openid获取到用户信息//                           $where = array('openid'=>$userInfo['openid'],'uniacid'=>$this->weid);//                           $re = M('mapping_fans')->where($where)->find();                           //添加到粉丝表//                           if ($re) {////                               $fans['mapping_fans_id']=$re['mapping_fans_id'];////                               $fans['uniacid']=$this->weid;////                               $fans['openid']=$userInfo['openid'];////                               $fans['nickname']=$userInfo['nickname'];////                               $fans['headimg']=$userInfo['headimgurl'];////                               $fans['sex']=$userInfo['sex'];////                               $fans['follow']=$userInfo['subscribe'];////                               $fans['updatetime']=time();////                               M('mapping_fans')->save($fans);////                               M('cs')->add(array('text'=>112));//                           }else{////                               $fanss['uniacid']=$this->weid;////                               $fanss['openid']=$userInfo['openid'];////                               $fanss['nickname']=$userInfo['nickname'];////                               $fanss['headimg']=$userInfo['headimgurl'];////                               $fanss['sex']=$userInfo['sex'];////                               $fanss['follow']=$userInfo['subscribe'];////                               $fans['updatetime']=time();////                               M('mapping_fans')->add($fanss);//                           }                           //用户数据//                           $userShuju = M('user')->where(array('openid'=>$userInfo['openid']))->find();  //微信提供的信息                           //查询父级信息//                           $parentInfo = M('user')->where(array('user_id'=>$userShuju['pid']))->find();//                           if($canshu)//                           {//                               //你扫码那个人的id(上级id)////                               $userPinfoid = M('user')->where(array('tg_code'=>$canshu))->getField('user_id');////                               //你扫码的用户信息////                               $userPinfoType = M('user')->field('user_id,pid,tk_pid,institution_id,utype')->where(array('tg_code'=>$canshu))->find();//                               //判断你上级的身份////                               if ($parentInfo['pid'] == '' ) {////                                   M('cs')->add(array('text'=>json_encode($parentInfo))); //null//                                   //判断你上级的身份////                                   if ($userPinfoType['utype'] == '20') {////                                       //是推客////                                       $userInfoo['pid'] = $userPinfoType['user_id'];////                                       $userInfoo['tk_pid'] = $userPinfoType['user_id'];////                                       $userInfoo['institution_id'] = $userPinfoType['institution_id'];////                                   }else{////                                       $userInfoo['tk_pid'] = $userPinfoType['tk_pid'];////                                       $userInfoo['institution_id'] = $userPinfoType['institution_id'];////                                       $userInfoo['pid'] = $userPinfoType['user_id'];////                                       //是商家或兜客//                                   }////                                   M('cs')->add(array('text'=>json_encode($userInfoo['pid'])));   //有值//                               }////                           }//                           //添加到用户表//                           if ($userShuju) {//                               if ($userShuju['utype'] == '20' || $userShuju['utype'] == '10'){//                                   unset($userInfoo['pid']);//                                   unset($userInfoo['tk_pid']);//                                   unset($userInfoo['institution_id']);//                               }//                               if ($userShuju['pid'] != '' ){//                                   unset($userInfoo['pid']);//                               }//                               if ($userShuju['tk_pid'] != '' ){//                                   unset($userInfoo['tk_pid']);//                               }//                               if ($userShuju['institution_id'] != '' ){//                                   unset($userInfoo['institution_id']);//                               }////                               $userInfoo['user_id']=$userShuju['user_id'];////                               $userInfoo['openid']=$userShuju['openid'];////                               $userInfoo['nick_name']=$userInfo['nickname'];////                               $userInfoo['head_img']=$userInfo['headimgurl'];////                               $userInfoo['sex']=$userInfo['sex'];//////                               $userInfoo['utype']='1';////                               $userInfoo['time']=time()+1;////                               $ree = M('user')->where(array('openid'=>$userShuju['openid']))->save($userInfoo);//                           }else{//                               $shuzi = R('Func/Func/createRegisterId');////                               $shuzi = R('Func/Func/setUserIdRand');////                               $userInfoo['user_id'] =$shuzi;////                               $userInfoo['openid']=$userInfo['openid'];////                               $userInfoo['nick_name']=$userInfo['nickname'];//////                               $userInfoo['head_img']=$userInfo['headimgurl'];////                               $userInfoo['sex']=$userInfo['sex'];//                               $userInfoo['time']=time()+2;////                               $userInfoo['utype']='1';////                               M('cs')->add(array('text'=>$shuzi));//                              $ree =  M('user')->add($userInfoo);////                           }                           $ree=true;                           if ($ree){//                               $url="https://wallet.insoonto.com/index.php/Wap/Register/register";//                               $weObj->getOauthRedirect($url,'STATE');//                               $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜小助手”公众号目前为钱兜兜唯一官方微信客服渠道。";                               $textInfo='点击链接下载App: https://wallet.insoonto.com/download.php';                               //$returnMsg['textKey']                               $weObj->text($textInfo)->reply();                           }                       }elseif($data['event'] == 'subscribe')        # 未关注扫码( 绑定上下级 )                       {                            $openid = $weObj->getRevFrom(); //拿到openid                           M('cs')->add(array('text'=>'2'.$openid));                            $canshu = $weObj->getRevSceneId();//获取到二维码参数值                           M('cs')->add(array('text'=>'2'.$canshu));                            // M('test')->add(array('text'=>$canshu));                            $userInfo = $weObj->getUserInfo($openid); //根据openid获取到用户信息                           $where = array('openid'=>$userInfo['openid'],'uniacid'=>$this->weid);                           $re = M('mapping_fans')->where($where)->find();                            $w['text']=$canshu;                           //                           $openUser=M('user')->where($where)->find();//                           if (!$openUser){//                               $weObj->text('感谢关注钱兜兜小助手!')->reply();//                               die;//                           }//                            M('cs')->add($w);//                             if ($re) {////                                 $fans['mapping_fans_id']=$re['mapping_fans_id'];////                                 $fans['uniacid']=$this->weid;////                                 $fans['openid']=$userInfo['openid'];////                                 $fans['nickname']=$userInfo['nickname'];////                                 $fans['headimg']=$userInfo['headimgurl'];////                                 $fans['sex']=$userInfo['sex'];////                                 $fans['follow']=$userInfo['subscribe'];////                                 $fans['updatetime']=time()+3;////                                 M('mapping_fans')->save($fans);////                             }else{////                                 $fanss['uniacid']=$this->weid;////                                 $fanss['openid']=$userInfo['openid'];////                                 $fanss['nickname']=$userInfo['nickname'];////                                 $fanss['headimg']=$userInfo['headimgurl'];////                                 $fanss['sex']=$userInfo['sex'];////                                 $fanss['follow']=$userInfo['subscribe'];////                                 $fans['updatetime']=time()+4;////////                                M('mapping_fans')->add($fanss);////                             }//                             //用户表////                            $userShuju = M('user')->where(array('openid'=>$userInfo['openid']))->find();////                            $parentInfo = M('user')->where(array('user_id'=>$userShuju['pid']))->find();////                           if($canshu)////                           {////                               $userPinfoid = M('user')->where(array('tg_code'=>$canshu))->getField('user_id');//////                               //你扫码的用户信息////                               $userPinfoType = M('user')->field('user_id,pid,tk_pid,institution_id,utype')->where(array('tg_code'=>$canshu))->find();////                               if ($parentInfo['pid'] == '' ) {////                                   //判断你上级的身份////                                   if ($userPinfoType['utype'] == '20'){////                                       //是推客////                                       $userInfoo['pid'] = $userPinfoType['user_id'];////                                       $userInfoo['tk_pid'] = $userPinfoType['user_id'];////                                       $userInfoo['institution_id'] = $userPinfoType['institution_id'];////                                   }else{////                                       $userInfoo['tk_pid'] = $userPinfoType['tk_pid'];////                                       $userInfoo['institution_id'] = $userPinfoType['institution_id'];////                                       $userInfoo['pid'] = $userPinfoType['user_id'];////                                       //是商家或兜客////                                   }////                               }//////////////                               if ($parentInfo['pid'] == 0 ){//////                                   if($userPinfoid)//////                                   {//////                                       if (empty($userInfo['pid'])){//////                                           $userInfoo['pid']=$userPinfoid;//////                                       }//////                                   }//////                               }////                           }//                           if ($userShuju) {////                               if ($userShuju['utype'] == '20' || $userShuju['utype'] == 10){//                                   unset($userInfoo['pid']);//                                   unset($userInfoo['tk_pid']);//                                   unset($userInfoo['institution_id']);//                               }////                               if ($userShuju['pid'] != '' ){//                                   unset($userInfoo['pid']);//                               }//                               if ($userShuju['tk_pid'] != '' ){//                                   unset($userInfoo['tk_pid']);//                               }//                               if ($userShuju['institution_id'] != '' ){//                                   unset($userInfoo['institution_id']);//                               }////                               $userInfoo['user_id']=$userShuju['user_id'];////                               $userInfoo['openid']=$userShuju['openid'];////                               $userInfoo['nick_name']=$userInfo['nickname'];////                               $userInfoo['head_img']=$userInfo['headimgurl'];////                               $userInfoo['sex']=$userInfo['sex'];//////                               $userInfoo['utype']='1';////                               $userInfoo['time']=time();////                              $ree =  M('user')->where(array('openid'=>$userShuju['openid']))->save($userInfoo);////                           }else{//////                               $shuzi = R('Func/Func/createRegisterId');////                               $userInfoo['user_id'] =$shuzi;////                               $userInfoo['openid']=$userInfo['openid'];////                               $userInfoo['nick_name']=$userInfo['nickname'];////                               $userInfoo['head_img']=$userInfo['headimgurl'];////                               $userInfoo['sex']=$userInfo['sex'];////                               $userInfoo['utype']='1';//                               $userInfoo['time']=time();////                               $ree = M('user')->add($userInfoo);////                           }                            $ree=true;                           if ($ree){//                               $url="https://wallet.insoonto.com/index.php/Wap/Register/register";//                               $weObj->getOauthRedirect($url,'STATE');//                               $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜小助手”公众号目前为钱兜兜唯一官方微信客服渠道。";                               $textInfo='点击链接下载App: https://wallet.insoonto.com/download.php';                               //$returnMsg['textKey']                               $weObj->text($textInfo)->reply();                           }                            // M('test')->add(array('text'=>$canshu));                       }                       break;                   default://                       $url="https://wallet.insoonto.com/index.php/Wap/Register/register";//                       $weObj->getOauthRedirect($url,'STATE');//                       $textInfo="点击屏幕最下方左侧的“小键盘图标”，直接输入文字或表情您就可以和钱兜兜客服聊天了哟～////在线人工客服工作时间为上午9:00-12:00，下午14:00-21:00////温馨提醒：“钱兜兜小助手”公众号目前为钱兜兜唯一官方微信客服渠道。";                    $textInfo='点击链接下载App: https://wallet.insoonto.com/download.php';//$returnMsg['textKey']                    $weObj->text($textInfo)->reply();            }    }    # 暂不使用该方法    public function subscribe(){        $weObj = R('Func/Wxapi/getConfig');        // M('test')->add(array('text'=>'123'));        // $res->text("help info")->reply();        // // $openid = $res->getRevTo();  # openid        // // $type = $res->getRev()->getRevType();  # 接收微信方法        // $dingyue = $res->getRevEvent();        // if ($dingyue['event'] == Wechat::EVENT_SUBSCRIBE) {        //     M('test')->add(array('text'=>'123'));        // }        // getRevTicket        // getRevEvent        // // 捕捉扫码事件        $type = $weObj->getRev()->getRevType();            switch($type) {                   case Wechat::MSGTYPE_TEXT:                       $weObj->text("欢迎关注银钱包公众号")->reply();                       exit;                       break;                   case Wechat::EVENT_SCAN:                       //扫码事件                       //要根据  ..订阅..  公众号事件接下面的逻辑                       $data=$weObj->getRevEvent(); //接收事件推送是否等于订阅(subscribe)事件,可获得事件和key                       if ($data['Event'] == 'subscribe') {                        $openid = $weObj->getRevFrom(); //拿到openid                        $canshu = $weObj->getRevSceneId();//获取到二维码参数值                        $userInfo = $weObj->getUserInfo($openid); //根据openid获取到用户信息                        $uInfo['subscribe']=$userInfo['subscribe'];                        $uInfo['openid']=$userInfo['openid'];                         $uInfo['nickname']=$userInfo['nickname'];                         $uInfo['sex']=$userInfo['sex'];                         $uInfo['city']=$userInfo['city'];                         $uInfo['country']=$userInfo['country'];                         $uInfo['province']=$userInfo['province'];                         $uInfo['headimgurl']=$userInfo['headimgurl'];                         $uInfo['subscribe_time']=$userInfo['subscribe_time'];                         $uInfo['unionid']=$userInfo['unionid'];                         $uInfo['remark']=$userInfo['remark'];                         $uInfo['groupid']=$userInfo['groupid'];                         $uInfo['tagid_list']=$userInfo['tagid_list'];                         $uInfo['ewcode']=$canshu;                         M('ceshi')->add($uInfo);                        //保存关注用户的信息                        // $where=array('openid'=>$openid);                        // $fans = M('mapping_fans')->where($where)->find(); //粉丝表                        // if ($fans) {                        //     $fansInfo['']=$userInfo                        // }                        // $res = M('user')->where($where)->find();//用户表                       }                       break;                   case Wechat::MSGTYPE_IMAGE:                       $weObj->text("欢迎关注银钱包公众号")->reply();                        break;                   default:                       $weObj->text("欢迎关注银钱包公众号")->reply();            }    }    //自定义创建菜单    public function createWxMenu(){        $shuju = M('wxmenus')->where(array('is_show'=>1,'menu_pid'=>0))->select();        // dump($shuju);die;        $news = array();        foreach ($shuju as $k => $v) {            $v1['type']='view';            $v1['name']=htmlspecialchars_decode(trim($v['menu_name']));            if ($v['is_wxlogin'] == 1){                $v1['url']=$this->codeurl(trim($v['menu_url']));            }else{                $v1['url']=trim($v['menu_url']);            }            $news[]=$v1;            $pid = array('menu_pid'=>$v['wxmenus_id'],'is_show'=>1);            $erji = M('wxmenus')->where($pid)->select();            foreach ($erji as $kk => $vv) {                if ($vv['menu_pid']==$v['wxmenus_id']) {                    if ($vv['is_key'] == 1){                        $vv1['type']='view';                    }else{                        $vv1['type']='click';                    }                    $vv1['name']=trim($vv['menu_name']);                    if ($vv['is_wxlogin'] == 1){                        if ($vv['is_key'] == 1){                            $vv1['url']=$this->codeurl(trim($vv['menu_url']));                        }else{                            $vv1['key']='点击屏幕最下方左侧的“小键盘图标”,直接输入文字或表情您就可以和钱兜兜客服聊天了哟～';                        }                    }else{                        if ($vv['is_key'] == 2){                            $vv1['key']='点击屏幕最下方左侧的“小键盘图标”,直接输入文字或表情您就可以和钱兜兜客服聊天了哟～';                            unset($vv1['url']);//                            $vv1['url']=$this->codeurl(trim($vv['menu_url']));                        }else{                            $vv1['url']=trim($vv['menu_url']);                            unset($vv1['key']);                        }                    }                    $news[$k]['sub_button'][]=$vv1;                    unset($news[$k]['type']);                    unset($news[$k]['url']);                }            }        }        $array =array('button'=>$news);//        dump($array);die;//        echo json_encode($array);die;//    $ress=$this->createMenu2(json_encode($array));        // echo "<pre>";//dump($ress);die;        $weObj = R('Func/Wxapi/getConfig');        // $weObj->valid();//        dump($weObj);die;        $res = $weObj->createMenu($array);        R("Payapi/Api/PaySetLog",array("./PayLog","Wx_ScMenu_time","--错误信息:".$weObj->errMsg."----生成信息----".$res."-- 时间:".date('Y-m-d H:i:s',time())."------\r\n"));//        dump($res);die;        return $res;    }    public function createMenu2($data){        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, "https://api.weixin.qq.com/cgi-bin/menu/create?access_token=5__mmL58WhVtd8EPW04o8jb9b443uXHVMU_ESxzSgLNreZlVfC7bj9mrOpuw1v6mP-bsJkNx58amUNKMMSt7ACeOoyL5O7WjfYBXwp4ZyDO6Cc5KmnlKO6s9M-_oO8YAPYJa6tGH-MTRvWTDTyDMZhAFAPYL");        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (compatible; MSIE 5.01; Windows NT 5.0)');        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);        curl_setopt($ch, CURLOPT_AUTOREFERER, 1);        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);        $tmpInfo = curl_exec($ch);        if (curl_errno($ch)) {            return curl_error($ch);        }        curl_close($ch);        dump($tmpInfo);die;        return $tmpInfo;    }    // 测试加密    public function duijiewx(){        import('Vendor.WechatDj.wxBizMsgCrypt');        $encodingAesKey = "EnktmIJJL68qb1RHD67uRV19samLTrZo8mnvCHZvIjG";        $token = "weixin";        $timeStamp = "1409304348";        $nonce = "321123";        $appId = "wxe833c53aafe42ff9";        $text = "<xml><ToUserName><![CDATA[oia2Tj我是中文jewbmiOUlr6X-1crbLOvLw]]></ToUserName><FromUserName><![CDATA[gh_7f083739789a]]></FromUserName><CreateTime>1407743423</CreateTime><MsgType><![CDATA[video]]></MsgType><Video><MediaId><![CDATA[eYJ1MbwPRJtOvIEabaxHs7TX2D-HV71s79GUxqdUkjm6Gs2Ed1KF3ulAOA9H1xG0]]></MediaId><Title><![CDATA[testCallBackReplyVideo]]></Title><Description><![CDATA[testCallBackReplyVideo]]></Description></Video></xml>";        $pc = new \WXBizMsgCrypt($token, $encodingAesKey, $appId);        $encryptMsg = '';        $errCode = $pc->encryptMsg($text, $timeStamp, $nonce, $encryptMsg);        if ($errCode == 0) {            print("加密后: " . $encryptMsg . "\n");        } else {            print($errCode . "\n");        }        $xml_tree = new \DOMDocument();        $xml_tree->loadXML($encryptMsg);        $array_e = $xml_tree->getElementsByTagName('Encrypt');        $array_s = $xml_tree->getElementsByTagName('MsgSignature');        $encrypt = $array_e->item(0)->nodeValue;        $msg_sign = $array_s->item(0)->nodeValue;        $format = "<xml><ToUserName><![CDATA[toUser]]></ToUserName><Encrypt><![CDATA[%s]]></Encrypt></xml>";        $from_xml = sprintf($format, $encrypt);        // 第三方收到公众号平台发送的消息        $msg = '';        $errCode = $pc->decryptMsg($msg_sign, $timeStamp, $nonce, $from_xml, $msg);        if ($errCode == 0) {            print("解密后: " . $msg . "\n");        }else {            print($errCode . "\n");        }    }    public function decode(){        $a = urldecode('https%3A%2F%2Fwallet.insoonto.com%2Findex.php%2FWap%2FDai%2FgetList');        echo $a;    }    //授权登录    public function codeurl($url=''){        $res = R('Func/Wxapi/getConfig');        //获得code        // $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx29d53cc438330ecf&redirect_uri=        //https%3A%2F%2Fwallet.insoonto.com%2FPayapi%2FWx%2Fsouquan?pid=Q        //&response_type=code&scope=SCOPE&state=STATE#wechat_redirect";        $souquanurl = $res->getOauthRedirect($url,'STATE');        // $code = $_GET['code'];        // dump($code);die;        return $souquanurl;        // dump($souquanurl);die;        // return $souquanurl;    }    //跳转到注册页面    public function locationRegister(){        $pid=$_REQUEST['pid'];        $res = R('Func/Wxapi/getConfig');        $url ="https://wallet.insoonto.com/index.php/Wap/Register/register?pid=".$pid; //正式//        $url ="https://i.insoonto.net/index.php/Wap/Register/register?pid=".$pid;//测试        $souquanurl = $res->getOauthRedirect($url,'STATE');//        dump($souquanurl);die;//        $openid = $res->getOauthAccessToken();        header("location:".$souquanurl);    }//    public function set()//    {//        $pid = $_REQUEST['pid'];//        $res = R('Func/Wxapi/getConfig');////        //获得code//        // redirect_uri = 注册页面?pid=DQ000001  openid//         $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx29d53cc438330ecf&redirect_uri=https%3A%2F%2Fwallet.insoonto.com%2FPayapi%2FWx%2Fsouquan?pid=".$pid."&response_type=code&scope=SCOPE&state=STATE#wechat_redirect";////        $souquanurl = $res->getOauthRedirect($url,'STATE');////        header("location:".$souquanurl);// 重定向////    }            # 于2017.10.26日编写            # 生成带参数的二维码            # $scene_id 存的字符串值  例子参数，5位数。例子：   45dyh 、33yuw            # return 二维码路径            public function creatEwCode($scene_id="")            {                $wx = R('Func/Wxapi/getConfig');                $ticket = $wx->getQRCode($scene_id,2); // 0:临时二维码；1:数值型永久二维码(此时expire参数无效)；2:字符串型永久二维码(此时expire参数无效)                $url = $wx->getQRUrl($ticket);                $d['ticket'] = $ticket['ticket'];                $d['url'] = $url;                M("tk_ewcode")->add($d);                return $url.$ticket['ticket'];            }            #生成二维码            public function qrcode()            {                Vendor('phpqrcode.phpqrcode');                //生成二维码图片                $object = new \QRcode();                $qrcode_path = '';                $file_tmp_name = '';                $errors = array();                if (!empty($_REQUEST)) {                    $content = trim($_REQUEST['content']); //二维码内容                    $contentSize = $this->getStringLength($content);                    if ($contentSize > 150) {                        $errors[] = '字数过长，不能多于150个字符！';                    }                    if (isset($_FILES['upimage']['tmp_name']) && $_FILES['upimage']['tmp_name'] && is_uploaded_file($_FILES['upimage']['tmp_name'])) {                        if ($_FILES['upimage']['size'] > 512000) {                            $errors[] = "你上传的文件过大，最大不能超过500K。";                        }                        $file_tmp_name = $_FILES['upimage']['tmp_name'];                        $fileext = array("image/pjpeg", "image/jpeg", "image/gif", "image/x-png", "image/png");                        if (!in_array($_FILES['upimage']['type'], $fileext)) {                            $errors[] = "你上传的文件格式不正确，仅支持 png, jpg, gif格式。";                        }                    }                    $tpgs = $_REQUEST['tpgs'];//图片格式                    $qrcode_bas_path = 'upload/qrcode/';                    if (!is_dir($qrcode_bas_path)) {                        mkdir($qrcode_bas_path, 0777, true);                    }                    $uniqid_rand = date("Ymdhis") . uniqid() . rand(1, 1000);                    $qrcode_path = $qrcode_bas_path . $uniqid_rand . "_1." . $tpgs;//原始图片路径                    $qrcode_path_new = $qrcode_bas_path . $uniqid_rand . "_2." . $tpgs;//二维码图片路径                    if (Helper::getOS() == 'Linux') {                        $mv = move_uploaded_file($file_tmp_name, $qrcode_path);                    } else {                        //解决windows下中文文件名乱码的问题                        $save_path = Helper::safeEncoding($qrcode_path, 'GB2312');                        if (!$save_path) {                            $errors[] = '上传失败，请重试！';                        }                        $mv = move_uploaded_file($file_tmp_name, $qrcode_path);                    }                    if (empty($errors)) {                        $errorCorrectionLevel = $_POST['errorCorrectionLevel'];//容错级别                        $matrixPointSize = $_POST['matrixPointSize'];//生成图片大小                        $matrixMarginSize = $_POST['matrixMarginSize'];//边距大小                        //生成二维码图片                        $object::png($content, $qrcode_path_new, $errorCorrectionLevel, $matrixPointSize, $matrixMarginSize);                        $QR = $qrcode_path_new;//已经生成的原始二维码图                        $logo = $qrcode_path;//准备好的logo图片                        if (file_exists($logo)) {                            $QR = imagecreatefromstring(file_get_contents($QR));                            $logo = imagecreatefromstring(file_get_contents($logo));                            $QR_width = imagesx($QR);//二维码图片宽度                            $QR_height = imagesy($QR);//二维码图片高度                            $logo_width = imagesx($logo);//logo图片宽度                            $logo_height = imagesy($logo);//logo图片高度                            $logo_qr_width = $QR_width / 5;                            $scale = $logo_width / $logo_qr_width;                            $logo_qr_height = $logo_height / $scale;                            $from_width = ($QR_width - $logo_qr_width) / 2;                            //重新组合图片并调整大小                            imagecopyresampled($QR, $logo, $from_width, $from_width, 0, 0, $logo_qr_width,                                $logo_qr_height, $logo_width, $logo_height);                            //输出图片                            //header("Content-type: image/png");                            imagepng($QR, $qrcode_path);                            imagedestroy($QR);                        } else {                            $qrcode_path = $qrcode_path_new;                        }                    } else {                        $qrcode_path = '';                    }                }                $data = array('data' => array('errors' => $errors, 'qrcode_path' => $qrcode_path));            }            #简单的二维码生成            public function qrcode_2(){//                import('Vendor.Phpqrcode.Phpqrcode');                Vendor('phpqrcode.phpqrcode');                //生成二维码图片                if ($_REQUEST){                    $object = new \QRcode();                    $url='https://wallet.insoonto.com/index.php/Payapi/Wx/locationRegister?pid='.$_REQUEST['pid'];//网址或者是文本内容                    $level=3;  //容错级别                    $size=4; //尺寸                    $errorCorrectionLevel =intval($level) ;//容错级别                    $matrixPointSize = intval($size);//生成图片大小                    $object->png($url, false, $errorCorrectionLevel, $matrixPointSize, 2,true);//                    $object::png($url,false, $errorCorrectionLevel, $matrixPointSize, 2,true);                }else{                  echo '<script>alert("参数错误");</script>';                  die;                }            }            //include 'phpqrcode.php';            public function createQr(){                $value = $_GET['url'];//二维码内容                $errorCorrectionLevel = 'L';//容错级别                $matrixPointSize = 6;//生成图片大小            //生成二维码图片                QRcode::png($value, 'qrcode.png', $errorCorrectionLevel, $matrixPointSize, 2);                $logo = 'jb51.png';//准备好的logo图片                $QR = 'qrcode.png';//已经生成的原始二维码图                if ($logo !== FALSE) {                    $QR = imagecreatefromstring(file_get_contents($QR));                    $logo = imagecreatefromstring(file_get_contents($logo));                    $QR_width = imagesx($QR);//二维码图片宽度                    $QR_height = imagesy($QR);//二维码图片高度                    $logo_width = imagesx($logo);//logo图片宽度                    $logo_height = imagesy($logo);//logo图片高度                    $logo_qr_width = $QR_width / 5;                    $scale = $logo_width/$logo_qr_width;                    $logo_qr_height = $logo_height/$scale;                    $from_width = ($QR_width - $logo_qr_width) / 2;                    //重新组合图片并调整大小                    imagecopyresampled($QR, $logo, $from_width, $from_width, 0, 0, $logo_qr_width,                        $logo_qr_height, $logo_width, $logo_height);                }            //输出图片                Header("Content-type: image/png");                ImagePng($QR);            }    # 本地PHP库生成二维码(会员)    public function beifencode($id=''){        Vendor('phpqrcode.phpqrcode');//        return $id;//        die;        //生成二维码图片        $object = new \QRcode();        $matrixPointSize = intval(3);//生成图片大小        $pid=M('user')->field('user_id,tg_code,tg_ewcode')->where(array('user_id'=>$id))->find();//        if (!$pid['tg_code']){//          return 1;//          die;//        }elseif($pid['tg_ewcode']){//          return 3;//          die;//        }        //     http://        $content="https://wallet.insoonto.com/index.php/Payapi/Wx/locationRegister?pid=".$id;//        return $content;//        die;        $urlfile = "Uploads/Qrcode/qrcode_" .$id.".png";        $sc = M('User');        $one = $sc ->where(array('user_id'=>$id))->data(array('tg_ewcode'=>"https://wallet.insoonto.com/".$urlfile))->save();        $object->png($content, $urlfile, "L", $matrixPointSize, 2);        return "https://wallet.insoonto.com/".$urlfile;//        if ($one){//          return 2;//          die;//        }else{//          return 4;//          die;//        }//        return $one;//        $content=M("user")->where(array('id'=>$id))->getField('mch_id');//网址或者是文本内容////        // var_dump($content);exit;    }    #本地生成 机构二维码    public function jigouTgcode($id=''){        Vendor('phpqrcode.phpqrcode');        $object = new \QRcode();        $matrixPointSize = intval(3);//生成图片大小        $pid=M('institution')->field('institution_id,tg_ewcode')->where(array('institution_id'=>$id))->find();        $content="https://wallet.insoonto.com/index.php/Payapi/Wx/locationRegister?pid=".$id;        $urlfile = "Uploads/Qrcode/institution/qrcode_" .$id.".png";        $sc = M('institution');//        dump($urlfile);die;        $one = $sc ->where(array('institution_id'=>$id))->data(array('tg_ewcode'=>"https://wallet.insoonto.com/".$urlfile))->save();        $object->png($content, $urlfile, "L", $matrixPointSize, 2);//        return "https://wallet.insoonto.com/".$urlfile;    }    public function updQrcode(){        $data = M('institution')->select();//        dump($data);die;        foreach($data as $k=>$v){//              $dizhi=$this->jigouTgcode($v['institution_id']);//              M('institution')->where(array('institution_id'=>$v['institution_id']))->data(array('tg_ewcode'=>$dizhi))->save(        }    }}