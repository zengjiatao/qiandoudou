<?php# 银钱包对接接口 - 微信api接口namespace Payapi\Controller;class LoginController extends BaseController{    public $uid;    public $parem;    public $sign;    public function _initialize(){        parent::_initialize();        $this->uid = $_REQUEST['uid'];        $this->parem=array(            'signType'=>$_REQUEST['signType'],            'timestamp' => $_REQUEST['timestamp'],            'dataType' => $_REQUEST['dataType'],            'inputCharset' => $_REQUEST['inputCharset'],            'version' => $_REQUEST['version'],        );        $this->sign = $_REQUEST['sign'];    }     public function Memberlogin(){       $phone = $_REQUEST['phone'];       $type = $_REQUEST['type'];       $code = $_REQUEST['code'];       $pawd = $_REQUEST['pawd'];       $token = $_REQUEST['token'];//         echo json_encode(array('code'=>4455,'msg'=>'平台升级维护中,请稍等'));die;//         echo json_encode(array('code'=>4455,'msg'=>'平台升级维护中,请稍等'));die;         if (!$this->sign){             echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;         }        if (!preg_match("/^1[0-9]{10}$/",$phone)) {     	 	echo json_encode(array('code'=>4207,'msg'=>'手机号码格式不正确'));die;     	 }     	 if (!$type) {     	 	echo json_encode(array('code'=>4208,'msg'=>'缺少登录类型参数'));die;     	 }       $userMsg = M('user')->where(array('phone'=>$phone))->find();         echo json_encode(array('code'=>2090,'msg'=>'请前往钱兜兜商服公众号下载最新的APP版本'));die;         if ($userMsg) {            if ($type == 1) {                //验证码登录	       	$where=array('phone'=>$phone,'type'=>1);                $array=array(                    'phone'=>$phone,                    'type'=>$type,                    'code'=>$code,                    'token'=>$_REQUEST['token'],                );                $this->parem = array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断	       	$re = M('mobleyzm')->where($where)->find();            //验证码正确	        if($code != $re['code']) {	        	echo json_encode(array('code'=>4203,'msg'=>'验证码错误'));die;	        }else{                $userInfo = M('user')->where(array('phone'=>$phone))->find();                if(!$userInfo){                    echo json_encode(array('code'=>2223,'msg'=>'用户未注册'));die;                }//                if($userInfo['isopen'] != 1){//                    echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                }                if(!$userInfo['pid']){                    echo json_encode(array('code'=>2224,'msg'=>'联系上级进行注册'));die;                }                if (!$userInfo['openid'] ){                    echo json_encode(array('code'=>2277,'msg'=>'请在微信端登录后才能登录APP'));die;                }//                $mmsg = M('user')->where(array('phone'=>$phone,'isopen'=>1))->find();////                if(!$mmsg){//                    if ($userInfo['utype'] == '20'){  //推客//                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                        if (!$oneShimin ){ //扫码注册的推客 未实名认证 冻结中//                            if ($userInfo['co_idcard']){//                                $sfz=array(//                                    'name'=>$userInfo['nick_name'],//                                    'idcard'=>$userInfo['co_idcard'],//                                );//                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                            }else{//                                echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                            }//                        }else{ //已提交实名认证//                            if ($oneShimin['status'] != 1){ //审核中或审核失败//                                if ($oneShimin['status'] == 2){//                                    $sts='活体认证失败,等待人工审核';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }elseif($oneShimin['status'] == 3){//                                    $sts='审核失败,需重新提交实名';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }//                            }else{//                                $agent = M('agent')->where(array('user_id'=>$userInfo['user_id']))->find();//                                if ($agent['status'] == 2){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户正在实名审核中'));die;//                                }//                                if ($agent['status'] == 3){//                                    echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;//                                }//                                if ($agent['status'] == 4){//                                    echo json_encode(array('code'=>2243,'msg'=>'该用户初审已通过,请财审','user_id'=>$userInfo['user_id']));die;//                                }//                                if ($agent['status'] == 6){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户财审已通过,请等待终审'));die;//                                }//                                if ($agent['status'] == 8){//                                    echo json_encode(array('code'=>2244,'msg'=>'未通过终审'));die;//                                }//                                if ($agent['status'] == 7){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户未通过初审'));die;//                                }//                                if ($agent['status'] == 9){//                                    echo json_encode(array('code'=>2244,'msg'=>'资料不正确,请联系机构更改资料'));die;//                                }//                                echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;//                            }//                        }//                    }else{  //兜客//                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                        if (!$oneShimin ){ //未提交实名//                            if ($userInfo['co_idcard']){//                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                            }else{//                                echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                            }//                        }else{  //已提交实名//                            if ($oneShimin['status'] != 1){ //审核中或审核失败//                                if ($oneShimin['status'] == 2){//                                    $sts='该用户正在等待人工审核';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }elseif($oneShimin['status'] == 3){//                                    $sts='人工审核失败,需重新提交实名';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }//                            }else{//                                echo json_encode(array('code'=>2243,'msg'=>'该用户已通过实名认证'));die;//                            }//                        }////                        echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                    }//                }                if($userInfo['tg_code'] == ''){                    $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                }                //判断是否有推广二维码  没有则生成                if ($userInfo['tg_ewcode'] == ''){                    $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                }                //登录更新用户的token                $userInfo['token'] = $token;                $userInfo['last_logintime']=time();                $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                if ($tokenInfo !== false ){                    $shiming=array();                    $bankBind=array();                    $shiming = M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();                    $bankBind = M('mybank')->where(array('user_id'=>$userInfo['user_id']))->find();                    $business_id =M('business')->where(array('user_id'=>$userInfo['user_id']))->getField('business_id');                    if (!$business_id){                        $business_id='';                    }                    echo json_encode(array('code'=>4202,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'type'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id));die;                }else{                    echo json_encode(array('code'=>7776,'msg'=>'token保存失败'));                }                //验证保存token//                 R('Func/Func/updToken',array($this->token,$userInfo['id']));//                $res = M('user')->where(array('id'=>$this->uid))->find();//                if ($res['token'] == ''){//                    $res['token'] = $this->token;//                    $re = M('user')->where(array('id'=>$this->uid))->save($res);//                   if ($re){//                       echo json_encode(array('code'=>7778,'msg'=>'token记录成功,登录成功','uid'=>$userMsg['id']));die;//                   }else{//                       echo json_encode(array('code'=>7776,'msg'=>'token保存失败'));die;//                   }//                }//                if($res['token'] != $this->token){//                    $res['token'] = $this->token;//                    $re = M('user')->where(array('id'=>$this->uid))->save($res);//                    if ($re){//                        echo json_encode(array('code'=>7778,'msg'=>'token更新成功,登录成功','uid'=>$userMsg['id']));die;//                    }else{//                        echo json_encode(array('code'=>7776,'msg'=>'token保存失败.'));die;//                    }//                }	        }	       }else if($type == 2){                $array=array(                    'phone'=>$phone,                    'type'=>$type,                    'pawd'=>$pawd,                    'token'=>$_REQUEST['token'],                );                $this->parem = array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断            //密码登录            $pwdData = M('password')->where(array('user_id'=>$userMsg['user_id'],'type'=>2))->find();            if (md5(md5($pawd)) != $pwdData['pwd']) {            	echo json_encode(array('code'=>4205,'msg'=>'密码错误'));die;            }else{                $userInfo = M('user')->where(array('phone'=>$phone))->find();                if(!$userInfo){                    echo json_encode(array('code'=>2223,'msg'=>'用户未注册'));die;                }//                if($userInfo['isopen'] != 1){//                    echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                }                if(!$userInfo['pid']){                    echo json_encode(array('code'=>2224,'msg'=>'联系上级进行注册'));die;                }                if (!$userInfo['openid'] ){                   echo json_encode(array('code'=>2277,'msg'=>'请在微信端登录后才能登录APP'));die;                }//                //判断是否冻结////                $mmsg = M('user')->where(array('phone'=>$phone,'isopen'=>1))->find();////                if(!$mmsg){//                    if ($userInfo['utype'] == '20'){  //推客//                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                        if (!$oneShimin ){ //扫码注册的推客 未实名认证 冻结中//                            if ($userInfo['co_idcard']){//                                $sfz=array(//                                    'name'=>$userInfo['nick_name'],//                                    'idcard'=>$userInfo['co_idcard'],//                                );//                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;//                            }else{//                                echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                            }//                        }else{ //已提交实名认证//                            if ($oneShimin['status'] != 1){ //审核中或审核失败//                                if ($oneShimin['status'] == 2){//                                    $sts='活体认证失败,等待人工审核';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }elseif($oneShimin['status'] == 3){//                                    $sts='审核失败,需重新提交实名';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }//                            }else{//                                $agent = M('agent')->where(array('user_id'=>$userInfo['user_id']))->find();//                                if ($agent['status'] == 2){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户正在实名审核中'));die;//                                }//                                if ($agent['status'] == 3){//                                    echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;//                                }//                                if ($agent['status'] == 4){//                                    echo json_encode(array('code'=>2243,'msg'=>'该用户初审已通过,请财审','user_id'=>$userInfo['user_id']));die;//                                }//                                if ($agent['status'] == 6){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户财审已通过,请等待终审'));die;//                                }//                                if ($agent['status'] == 8){//                                    echo json_encode(array('code'=>2244,'msg'=>'未通过终审'));die;//                                }//                                if ($agent['status'] == 7){//                                    echo json_encode(array('code'=>2244,'msg'=>'该用户未通过初审'));die;//                                }//                                if ($agent['status'] == 9){//                                    echo json_encode(array('code'=>2244,'msg'=>'资料不正确,请联系机构更改资料'));die;//                                }//                                echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;//                            }//                        }//                    }else{  //兜客//                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                        if (!$oneShimin ){ //未提交实名//                            if ($userInfo['co_idcard']){//                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                            }else{//                                echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                            }//                        }else{  //已提交实名//                            if ($oneShimin['status'] != 1){ //审核中或审核失败//                                if ($oneShimin['status'] == 2){//                                    $sts='该用户正在等待人工审核';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }elseif($oneShimin['status'] == 3){//                                    $sts='人工审核失败,需重新提交实名';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz));die;//                                }//                            }else{//                                echo json_encode(array('code'=>2243,'msg'=>'该用户已通过实名认证'));die;//                            }//                        }////                        echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                    }//                }                if($userInfo['tg_code'] == ''){                    $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                }                //判断是否有推广二维码  没有则生成                if ($userInfo['tg_ewcode'] == ''){                    $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                }                $userInfo['token'] = $token;                $userInfo['last_logintime']=time();                $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                if ($tokenInfo !== false ){                    $shiming=array();                    $bankBind=array();                    $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                    $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                    $business_id =M('business')->where(array('user_id'=>$userMsg['user_id']))->getField('business_id');                    if (!$business_id){                        $business_id='';                    }                    echo json_encode(array('code'=>4206,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'type'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id));die;                }else{                    echo json_encode(array('code'=>7776,'msg'=>'你的手速太快了.'));                }            }	       }else{	       	 echo json_encode(array('code'=>4201,'msg'=>'未知的登录类型'));die;	       }       }else{	       	echo json_encode(array('code'=>4204,'msg'=>'登录手机号码不存在'));die;	   }     }     //验证码发送     public function sendCode(){     	 $type=$_REQUEST['type'];//     	 $phone =$_REQUEST['phone'];         if (!$this->sign){             echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;         }         $array=array(             'phone'=>$phone,             'type'=>$type,         );         $this->parem = array_merge($this->parem,$array);         $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;         if ($this->sign !== $msg){             echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;         }         R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)         $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断     	 if (!preg_match("/^1[0-9]{10}$/",$phone)) {     	 	echo json_encode(array('code'=>4304,'msg'=>'手机号码格式不正确'));die;     	 }     	 if ($type == 1) {     	 	$coco =create_yzm();//     	 	$msg = iconv("GB2312","UTF-8", "您的验证码为:").$coco;//     	 	R('Func/Func/sendMessage',array($phone,$coco));//             $phone='13762963956';             $msg ="验证码：".$coco."(为了您的账户安全，请勿告知他人，请在页面尽快完成验证)客服4008-272-278";             $infooo = R("Func/Func/send_mobile",array($phone,$msg));//              dump($infooo);die;     	 	// 注册     	 	$where = array('phone'=>$phone,'type'=>4);     	 	$info = M('mobleyzm')->where($where)->find();     	 	if ($info) {	     	 	$data['mobleyzm_id']=$info['mobleyzm_id'];	     	 	$data['type']=4;	     	 	$data['phone']=$phone;	     	 	$data['code']=$coco;	     	 	$data['c_t']=time();	     	 	$res =M('mobleyzm')->save($data);	     	 	if ($res) {	     	 			echo json_encode(array('code'=>4302,'msg'=>'发送验证码成功','data'=>$coco));die;	     	 		}else{	     	 			echo json_encode(array('code'=>4303,'msg'=>'发送验证码失败,系统繁忙.请联系管理员'));die;	     	 		}	     	 	}else{	     	 	$data['type']=4;	     	 	$data['phone']=$phone;	     	 	$data['code']=$coco;	     	 	$data['c_t']=time();	     	 	$res = M('mobleyzm')->add($data);	     	 	if ($res) {	     	 			echo json_encode(array('code'=>4302,'msg'=>'发送验证码成功','data'=>$coco));die;	     	 		}else{	     	 			echo json_encode(array('code'=>4303,'msg'=>'发送验证码失败,系统繁忙.请联系管理员'));die;	     	 		}	     	 	}     	 	     	 }else if($type == 2){           //登录            $userP = M('user')->where(array('phone'=>$phone))->find();            if (!$userP) {            	echo json_encode(array('code'=>4305,'msg'=>'该手机号码未绑定用户'));die;            }            $coco =create_yzm();             $msg ="验证码：".$coco."(为了您的账户安全，请勿告知他人，请在页面尽快完成验证)客服4008-272-278";             $infooo = R("Func/Func/send_mobile",array($phone,$msg));//     	 	$msg = iconv("GB2312","UTF-8", "您的验证码为:").$coco;//     	 	R('Func/Func/sendMessage',array($phone,$coco));           $where = array('phone'=>$phone,'type'=>1);           $info = M('mobleyzm')->where($where)->find();           if ($info) {	     	 	$data['mobleyzm_id']=$info['mobleyzm_id'];	     	 	$data['type']=1;	     	 	$data['phone']=$phone;	     	 	$data['code']=$coco;	     	 	$data['c_t']=time();	     	 	$res =M('mobleyzm')->save($data);	     	 	if ($res) {	     	 			echo json_encode(array('code'=>4302,'msg'=>'发送验证码成功','data'=>$coco));die;	     	 		}else{	     	 			echo json_encode(array('code'=>4303,'msg'=>'发送验证码失败,系统繁忙.请联系管理员'));die;	     	 		}	     	 	}else{	     	 	$data['type']=1;	     	 	$data['phone']=$phone;	     	 	$data['code']=$coco;	     	 	$data['c_t']=time();	     	 	$res = M('mobleyzm')->add($data);	     	 	if ($res) {	     	 			echo json_encode(array('code'=>4302,'msg'=>'发送验证码成功','data'=>$coco));die;	     	 		}else{	     	 			echo json_encode(array('code'=>4303,'msg'=>'发送验证码失败,系统繁忙.请联系管理员'));die;	     	 		}	     	 	}     	 }else{     	 	echo json_encode(array('code'=>4301,'msg'=>'未知的发送类型'));die;     	 }     }     public function downXian(){//         echo json_encode(array('code'=>4455,'msg'=>'平台升级维护中,请稍等'));die;         $token = $_REQUEST['token'];         $uid = $_REQUEST['uid'];         $pawd = $_REQUEST['pwd'];         $re = M('user')->where(array('user_id'=>$uid))->getField('token');         $userMsg=M('user')->field('user_id,utype,phone,level')->where(array('user_id'=>$uid))->find();         if($userMsg['utype'] == '20'){   //推客             $oneShimin=M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();             if (!$oneShimin ){   //扫码注册的推客 未实名认证 冻结中                 if ($userMsg['co_idcard']){                     $sfz=array(                         'name'=>$userMsg['nick_name'],                         'idcard'=>$userMsg['co_idcard'],                     );                     echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userMsg['user_id'],'data'=>$sfz,'utype'=>$userMsg['utype']));die;                 }else{                     if ($userMsg['phone']){                         echo json_encode(array('code'=>2238,'msg'=>'请前往实名!','user_id'=>$userMsg['user_id'],'utype'=>$userMsg['utype']));die;                     }else{                         echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;                     }                 }             }else{ //已提交实名认证                 if ($oneShimin['status'] != 1){ //审核中或审核失败                     if ($oneShimin['status'] == 2){                         $sts = '活体认证失败,等待人工审核';                         $sfz = array(                             'name' => $oneShimin['nickname'],                             'idcard' => $oneShimin['idcard'],                             'type' => $oneShimin['sh_type'],                         );                         echo json_encode(array('code' => 2241, 'msg' => $sts, 'user_id' => $userMsg['user_id'], 'data' => $sfz, 'utype' => $userMsg['utype']));                         die;                     }elseif ($oneShimin['status'] == 3){                         $sts = '审核失败,需重新提交实名';                         $sfz = array(                             'name' => $oneShimin['nickname'],                             'idcard' => $oneShimin['idcard'],                             'type' => $oneShimin['sh_type'],                         );                         echo json_encode(array('code' => 2242, 'msg' => $sts, 'user_id' => $userMsg['user_id'], 'data' => $sfz, 'utype' => $userMsg['utype']));                         die;                     }                 }else{  //实名成功 第二步 绑定银行卡//                                    echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;                     $mybankData = M('mybank')->where(array('type' => 1, 'jq_status' => 3, 'status' => 1, 'is_normal' => 1, 'user_id' => $userMsg['user_id']))->find();                     if (!$mybankData){  //不存在默认结算卡                         echo json_encode(array('code' => 2248, 'msg' => '请绑定储蓄卡', 'user_id' => $userMsg['user_id'], 'utype' => $userMsg['utype']));                         die;                     }else{                         if($token != $re){                             echo json_encode(array('code'=>4399,'msg'=>'您的账号在别处上线'));die;                         }                         $ree = M('password')->where(array('user_id'=>$uid,'type'=>2))->find();//         dump($ree);die;                         if ($ree['pwd'] != md5(md5($pawd))){                             echo json_encode(array('code'=>4398,'msg'=>'您的密码已修改'));die;                         }                         $bankBind=array();                         $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                         $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                         $business_id =M('business')->where(array('user_id'=>$uid))->getField('business_id');                         if (!$business_id){                             $business_id='';                         }                         $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();                         if ($xyCard){                             $xycreditcard = 1;  //有信用卡                         }else{                             $xycreditcard = 0; //无                         }                         echo json_encode(array('code'=>4206,'msg'=>'登陆成功','utype'=>$userMsg['utype'],'business_id'=>$business_id,'bankBind'=>$bankBind['jq_status'],'xycreditcard'=>$xycreditcard));die;                     }                 }             }         }else{  //兜客             if($token != $re){                 echo json_encode(array('code'=>4399,'msg'=>'您的账号在别处上线'));die;             }             $ree = M('password')->where(array('user_id'=>$uid,'type'=>2))->find();//         dump($ree);die;             if ($ree['pwd'] != md5(md5($pawd))){                 echo json_encode(array('code'=>4398,'msg'=>'您的密码已修改'));die;             }             $bankBind=array();             $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();             $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡             $business_id =M('business')->where(array('user_id'=>$uid))->getField('business_id');             if (!$business_id){                 $business_id='';             }             $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();             if ($xyCard){                 $xycreditcard = 1;  //有信用卡             }else{                 $xycreditcard = 0; //无             }             echo json_encode(array('code'=>4206,'msg'=>'登陆成功','utype'=>$userMsg['utype'],'business_id'=>$business_id,'bankBind'=>$bankBind['jq_status'],'xycreditcard'=>$xycreditcard));die;         }     }      //财审接口     public function tkLevel(){         echo json_encode(array('code'=>2090,'msg'=>'请前往钱兜兜商服公众号下载最新的APP版本'));die;          $uid=$_REQUEST['uid'];          if (!$uid){              echo json_encode(array('code'=>2090,'msg'=>'参数缺少'));die;          }          $data =M('user')->field('user_id,utype,level')->where(array('user_id'=>$uid))->find();         if (!$data){           echo json_encode(array('code'=>2091,'msg'=>'用户信息查询为空,请重试'));die;         }else{             if ($data['level']){                $res =M('distribution_level')->field('levelname,ordermoney')->where(array('distribution_level_id'=>$data['level']))->find();                $ress=M('wxsk_image')->where(array('is_index'=>1))->find();                if ($res){                 echo json_encode(array('code'=>2095,'msg'=>'获取成功','data'=>$res,'image'=>$ress));die;                }else{                 echo json_encode(array('code'=>2093,'msg'=>'推客等级信息查询为空,请重试'));die;                }             }else{                 echo json_encode(array('code'=>2091,'msg'=>'推客信息查询为空,请重试'));die;             }         }     }    /*     * 新版登录流程(测试)     * author zjt     * 第一步 活体实名  失败则提交新的文件进行人工审核,成功进行第二步     * 第二步 绑定默认结算卡 兜客绑卡成功则注册成功 推客绑卡成功到第三步 ,失败的话短信提示并保持在绑卡页面     * 第三步 推客缴费阶段 缴费成功则开通     *  */    public function logincs(){//        ob_clean();        $phone = $_REQUEST['phone']; //手机号码        $type = $_REQUEST['type'];  //分为验证码登录和密码登录        $code = $_REQUEST['code']; //验证码        $pawd = $_REQUEST['pawd']; //密码        $token = $_REQUEST['token']; //手机唯一标识//        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;////        }        if (!preg_match("/^1[0-9]{10}$/",$phone)) {            echo json_encode(array('code'=>4207,'msg'=>'手机号码格式不正确'));die;        }        if (!$type) {            echo json_encode(array('code'=>4208,'msg'=>'缺少登录类型参数'));die;        }        $userMsg = M('user')->where(array('phone'=>$phone))->find();        if($userMsg){            #验证码登录            if($type == 1){                $array=array(                    'phone'=>$phone,                    'type'=>$type,                    'code'=>$code,                    'token'=>$_REQUEST['token'],                );                $this->parem = array_merge($this->parem,$array);//                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//                if ($this->sign !== $msg){//                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;//                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                $where['phone']=$phone;                $where['type']=1;                $re = M('mobleyzm')->where($where)->find();                if ($re['code'] != $code){  //验证码错误                    echo json_encode(array('code'=>4203,'msg'=>'验证码错误'));die;                }else{   //验证码正确                    $userInfo = M('user')->where(array('phone'=>$phone))->find();                    if(!$userInfo){                        echo json_encode(array('code'=>2223,'msg'=>'用户未注册'));die;                    }//                if($userInfo['isopen'] != 1){//                    echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                }//                    if(!$userInfo['pid']){////                        echo json_encode(array('code'=>2224,'msg'=>'联系上级进行注册'));die;////                    }                    if (!$userInfo['openid'] ){                        echo json_encode(array('code'=>2277,'msg'=>'请在微信端登录后才能登录APP'));die;                    }                    //判断是否冻结//                    $mmsg = M('user')->where(array('phone'=>$phone,'isopen'=>1))->find();//                    if(!$mmsg){                        if ($userInfo['utype'] == '20'){  //推客//                            if ($userInfo['level'] == 9){//                                if ($userInfo['is_allow'] == 3){//                                    echo json_encode(array('code'=>2288,'msg'=>'您暂未通过合伙人的审核,请等待审核'));die;//                                }//                            }                            $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();                            if (!$oneShimin ){ //扫码注册的推客 未实名认证 冻结中                                if ($userInfo['co_idcard']){                                    $sfz=array(                                        'name'=>$userInfo['nick_name'],                                        'idcard'=>$userInfo['co_idcard'],                                    );                                    echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                                }else{                                    if ($userInfo['phone']){                                        echo json_encode(array('code'=>2238,'msg'=>'请前往实名!','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;                                    }else{                                        echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;                                    }                                }                            }else{ //已提交实名认证                                if ($oneShimin['status'] != 1){ //审核中或审核失败                                    if ($oneShimin['status'] == 2){                                        $sts='活体认证失败,等待人工审核';                                        $sfz=array(                                            'name'=>$oneShimin['nickname'],                                            'idcard'=>$oneShimin['idcard'],                                            'type'=>$oneShimin['sh_type'],                                        );                                        echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                                    }elseif($oneShimin['status'] == 3){                                        $sts='审核失败,需重新提交实名';                                        $sfz=array(                                            'name'=>$oneShimin['nickname'],                                            'idcard'=>$oneShimin['idcard'],                                            'type'=>$oneShimin['sh_type'],                                        );                                        echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                                    }                                }else{  //实名成功 第二步 绑定银行卡//                                    echo json_encode(array('code'=>2243,'msg'=>'请交款','user_id'=>$userInfo['user_id']));die;                                    $mybankData=M('mybank')->where(array('type'=>1,'jq_status'=>3,'status'=>1,'is_normal'=>1,'user_id'=>$userInfo['user_id']))->find();                                    if (!$mybankData){  //不存在默认结算卡                                        echo json_encode(array('code'=>2248,'msg'=>'请绑定储蓄卡','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;                                    }else{                                        //已经绑定储蓄卡                                        $agent =M('user_operation')->where(array('user_id'=>$userInfo['user_id'],'op_status'=>6))->find();//                                        if(!$agent){//                                            echo json_encode(array('code'=>2243,'msg'=>'请前往缴费','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype'],'level'=>$userInfo['level']));die;//                                        }                                        if (!$agent){                                           echo json_encode(array('code'=>2243,'msg'=>'请前往缴费','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype'],'level'=>$userInfo['level']));die;                                        }else{                                            if($userInfo['tg_code'] == ''){                                                $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                                            }                                            ///////////////////////                                            //判断是否有推广二维码  没有则生成                                            if ($userInfo['tg_ewcode'] == ''){                                                $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                                            }                                            $userInfo['token'] = $token;                                            $userInfo['last_logintime']=time();                                            $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                                            if ($tokenInfo !== false ){                                                $shiming=array();                                                $bankBind=array();                                                $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                                                $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                                                $business_id =M('business')->where(array('user_id'=>$userMsg['user_id']))->getField('business_id');                                                if (!$business_id){                                                    $business_id='';                                                }//                                                //提示升级//                                                if ($userInfo['is_upgrade'] == 0){//                                                    $parentInfo=M('user')->field('user_id,utype,level')->where(array('user_id'=>trim($userInfo['pid'])))->find();////                        echo json_encode(array('code'=>4399,'data'=>$parentInfo));die;//                                                    if ($parentInfo['level'] == 9 ){//                                                        if ($userInfo['level'] == 4 || $userInfo['level'] == 1 || !$userInfo['level']){//                                                            echo json_encode(array('code'=>4399,'msg'=>'可以升级!','user_id'=>$userInfo['user_id'],'level'=>$userInfo['level']));die;//                                                        }//                                                    }elseif($parentInfo['level'] == 6){//                                                        if ($userInfo['level'] == 1  || !$userInfo['level']){//                                                            echo json_encode(array('code'=>4399,'msg'=>'可以升级!','user_id'=>$userInfo['user_id'],'level'=>$userInfo['level']));die;//                                                        }//                                                    }//                                                }                                                $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();                                                if ($xyCard){                                                    $xycreditcard = 1;  //有信用卡                                                }else{                                                    $xycreditcard = 0; //无                                                }                                                echo json_encode(array('code'=>4206,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'utype'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id,'xycreditcard'=>$xycreditcard));die;                                            }else{                                                echo json_encode(array('code'=>7776,'msg'=>'你的手速太快了.'));                                            }                                            ////////////////////////////                                        }                                    }                                }                            }                        }else{  //兜客//                            $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                            if (!$oneShimin ){ //未提交实名//                                if ($userInfo['co_idcard']){//                                    echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                                }else{//                                    if ($userInfo['phone']){//                                        echo json_encode(array('code'=>2238,'msg'=>'请前往实名!','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                                    }else{//                                        echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                                    }//                                }//                            }else{  //已提交实名//                                if ($oneShimin['status'] != 1){ //审核中或审核失败//                                    if ($oneShimin['status'] == 2){//                                        $sts='该用户正在等待人工审核';//                                        $sfz=array(//                                            'name'=>$oneShimin['nickname'],//                                            'idcard'=>$oneShimin['idcard'],//                                            'type'=>$oneShimin['sh_type'],//                                        );//                                        echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;//                                    }elseif($oneShimin['status'] == 3){//                                        $sts='人工审核失败,需重新提交实名';//                                        $sfz=array(//                                            'name'=>$oneShimin['nickname'],//                                            'idcard'=>$oneShimin['idcard'],//                                            'type'=>$oneShimin['sh_type'],//                                        );//                                        echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;//                                    }//                                }else{  //该用户已通过实名认证//                                    echo json_encode(array('code'=>2243,'msg'=>'该用户已通过实名认证'));die;//                                    $mybankData=M('mybank')->where(array('type'=>1,'jq_status'=>3,'status'=>1,'is_normal'=>1,'user_id'=>$userInfo['user_id']))->find();//                                    if (!$mybankData){  //不存在默认结算卡//                                        echo json_encode(array('code'=>2248,'msg'=>'请绑定储蓄卡','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                                    }else{                                        if($userInfo['tg_code'] == ''){                                            $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                                        }                                        //判断是否有推广二维码  没有则生成                                        if ($userInfo['tg_ewcode'] == ''){                                            $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                                        }                                        $userInfo['token'] = $token;                                        $userInfo['last_logintime']=time();                                        $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                                        if ($tokenInfo !== false ){                                            $shiming=array();                                            $bankBind=array();                                            $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                                            $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                                            $business_id =M('business')->where(array('user_id'=>$userMsg['user_id']))->getField('business_id');                                            if (!$business_id){                                                $business_id='';                                            }                                            if (!$shiming){                                                $shiming['status']=0;                                            }                                            $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();                                            if ($xyCard){                                                $xycreditcard = 1;  //有信用卡                                            }else{                                                $xycreditcard = 0; //无                                            }                                            echo json_encode(array('code'=>4206,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'utype'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id,'xycreditcard'=>$xycreditcard));die;                                        }else{                                            echo json_encode(array('code'=>7776,'msg'=>'你的手速太快了.'));                                        }                        }                    }                }//            }            #密码登录            if($type == 2){                $array=array(                    'phone'=>$phone,                    'type'=>$type,                    'pawd'=>$pawd,                    'token'=>$_REQUEST['token'],                );                $this->parem = array_merge($this->parem,$array);////                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//////        dump($msg);die;////                if ($this->sign !== $msg){////                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;////                }//                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)////                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                //密码登录                $pwdData = M('password')->where(array('user_id'=>$userMsg['user_id'],'type'=>2))->find();                if (md5(md5($pawd)) != $pwdData['pwd']) {                    echo json_encode(array('code'=>4205,'msg'=>'密码错误'));die;                }else{                    $userInfo = M('user')->where(array('phone'=>$phone))->find();                    if(!$userInfo){                        echo json_encode(array('code'=>2223,'msg'=>'用户未注册'));die;                    }//                if($userInfo['isopen'] != 1){//                    echo json_encode(array('code'=>2222,'msg'=>'用户冻结中'));die;//                }//                    if(!$userInfo['pid']){////                        echo json_encode(array('code'=>2224,'msg'=>'联系上级进行注册'));die;////                    }                    if (!$userInfo['openid'] ){                        echo json_encode(array('code'=>2277,'msg'=>'请在微信端登录后才能登录APP'));die;                    }                    //判断是否冻结//                        $parentInfo=M('user')->field('user_id,utype,level')->where(array('user_id'=>$userInfo['pid']))->find();//                    $mmsg = M('user')->where(array('phone'=>$phone,'isopen'=>1))->find();//                    if(!$mmsg){                    if ($userInfo['utype'] == '20'){  //推客//                        if ($userInfo['level'] == 9){//                            if ($userInfo['is_allow'] == 3){//                                echo json_encode(array('code'=>2288,'msg'=>'您暂未通过合伙人的审核,请等待审核'));die;//                            }//                        }                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();                        if (!$oneShimin ){ //扫码注册的推客 未实名认证 冻结中                            if ($userInfo['co_idcard']){                                $sfz=array(                                    'name'=>$userInfo['nick_name'],                                    'idcard'=>$userInfo['co_idcard'],                                );                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                            }else{                                if ($userInfo['phone']){                                    echo json_encode(array('code'=>2238,'msg'=>'请前往实名!','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;                                }else{                                    echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;                                }                            }                        }else{ //已提交实名认证                            if ($oneShimin['status'] != 1){ //审核中或审核失败                                if ($oneShimin['status'] == 2){                                    $sts='活体认证失败,等待人工审核';                                    $sfz=array(                                        'name'=>$oneShimin['nickname'],                                        'idcard'=>$oneShimin['idcard'],                                        'type'=>$oneShimin['sh_type'],                                    );                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                                }elseif($oneShimin['status'] == 3){                                    $sts='审核失败,需重新提交实名';                                    $sfz=array(                                        'name'=>$oneShimin['nickname'],                                        'idcard'=>$oneShimin['idcard'],                                        'type'=>$oneShimin['sh_type'],                                    );                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;                                }                            }else{  //实名成功 第二步 绑定银行卡                                $mybankData=M('mybank')->where(array('type'=>1,'jq_status'=>3,'status'=>1,'is_normal'=>1,'user_id'=>$userInfo['user_id']))->find();                                if (!$mybankData){  //不存在默认结算卡                                    echo json_encode(array('code'=>2248,'msg'=>'请绑定储蓄卡','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;                                }else{                                    //已经绑定储蓄卡                                    $agent =M('user_operation')->where(array('user_id'=>$userInfo['user_id'],'op_status'=>6))->find();                                    if (!$agent){                                        echo json_encode(array('code'=>2243,'msg'=>'请前往缴费','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype'],'level'=>$userInfo['level']));die;                                    }else{                                        if($userInfo['tg_code'] == ''){                                            $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                                        }                                        ///////////////////////                                        //判断是否有推广二维码  没有则生成                                        if ($userInfo['tg_ewcode'] == ''){                                            $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                                        }                                        $userInfo['token'] = $token;                                        $userInfo['last_logintime']=time();                                        $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                                        if ($tokenInfo !== false ){                                            $shiming=array();                                            $bankBind=array();                                            $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                                            $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                                            $business_id =M('business')->where(array('user_id'=>$userMsg['user_id']))->getField('business_id');                                            if (!$business_id){                                                $business_id='';                                            }                                            $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();                                            if ($xyCard){                                                $xycreditcard = 1;  //有信用卡                                            }else{                                                $xycreditcard = 0; //无                                            }                                            echo json_encode(array('code'=>4206,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'utype'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id,'xycreditcard'=>$xycreditcard));die;                                        }else{                                            echo json_encode(array('code'=>7776,'msg'=>'你的手速太快了.'));                                        }                                        ////////////////////////////                                    }                                }                            }                        }                    }else{  //兜客//                        $oneShimin=M('myrealname')->where(array('user_id'=>$userInfo['user_id']))->find();//                        if (!$oneShimin ){ //未提交实名//                            if ($userInfo['co_idcard']){//                                echo json_encode(array('code'=>2238,'msg'=>'该用户需实名认证','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                            }else{//                                if ($userInfo['phone']){//                                    echo json_encode(array('code'=>2238,'msg'=>'请前往实名!','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                                }else{//                                    echo json_encode(array('code'=>2240,'msg'=>'未查找到该用户'));die;//                                }//                            }//                        }else{  //已提交实名//                            if ($oneShimin['status'] != 1){ //审核中或审核失败//                                if ($oneShimin['status'] == 2){//                                    $sts='该用户正在等待人工审核';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2241,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;//                                }elseif($oneShimin['status'] == 3){//                                    $sts='人工审核失败,需重新提交实名';//                                    $sfz=array(//                                        'name'=>$oneShimin['nickname'],//                                        'idcard'=>$oneShimin['idcard'],//                                        'type'=>$oneShimin['sh_type'],//                                    );//                                    echo json_encode(array('code'=>2242,'msg'=>$sts,'user_id'=>$userInfo['user_id'],'data'=>$sfz,'utype'=>$userInfo['utype']));die;//                                }//                            }else{  //该用户已通过实名认证//                                    echo json_encode(array('code'=>2243,'msg'=>'该用户已通过实名认证'));die;//                                $mybankData=M('mybank')->where(array('type'=>1,'jq_status'=>3,'status'=>1,'is_normal'=>1,'user_id'=>$userInfo['user_id']))->find();//                                if (!$mybankData){  //不存在默认结算卡//                                    echo json_encode(array('code'=>2248,'msg'=>'请绑定储蓄卡','user_id'=>$userInfo['user_id'],'utype'=>$userInfo['utype']));die;//                                }else{                                    if($userInfo['tg_code'] == ''){                                        $userInfo['tg_code']= R("Func/Func/setTgCodeIdRand"); //生成推广码                                    }                                    //判断是否有推广二维码  没有则生成                                    if ($userInfo['tg_ewcode'] == ''){                                        $userInfo['tg_ewcode']=R("Payapi/Wx/beifencode",array($userInfo['user_id']));//生成推广二维码//                    $userInfo['tg_ewcode']=R("Payapi/Wx/creatEwCode",array($userInfo['tg_code']));                                    }                                    $userInfo['token'] = $token;                                    $userInfo['last_logintime']=time();                                    $tokenInfo = M('user')->where(array('user_id'=>$userInfo['user_id']))->save($userInfo);                                    if ($tokenInfo !== false ){                                        $shiming=array();                                        $bankBind=array();                                        $shiming = M('myrealname')->where(array('user_id'=>$userMsg['user_id']))->find();                                        $bankBind = M('mybank')->where(array('user_id'=>$userMsg['user_id'],'type'=>1,'jq_status'=>3))->find();  # 获取默认结算卡                                        $business_id =M('business')->where(array('user_id'=>$userMsg['user_id']))->getField('business_id');                                        if (!$business_id){                                            $business_id='';                                        }                                        if (!$shiming){                                            $shiming['status']=0;                                        }                                        $xyCard = M('mybank')->where(array('type'=>2,'user_id'=>$userMsg['user_id'],'jq_status'=>3))->find();                                        if ($xyCard){                                            $xycreditcard = 1;  //有信用卡                                        }else{                                            $xycreditcard = 0; //无                                        }                                        echo json_encode(array('code'=>4206,'msg'=>'登陆成功','uid'=>$userMsg['user_id'],'nick_name'=>$userMsg['nick_name'],'utype'=>$userMsg['utype'],'shiming'=>$shiming['status'],'bankBind'=>$bankBind['jq_status'],'business_id'=>$business_id,'xycreditcard'=>$xycreditcard));die;                                    }else{                                        echo json_encode(array('code'=>7776,'msg'=>'你的手速太快了.'));                                    }                        }                    }                }        }else{            echo json_encode(array('code'=>4204,'msg'=>'登录手机号码不存在'));die;        }    }    public function cs(){        $phone='13548750126';        $msg="尊敬的".$phone."，您的实名认证不通过，已转人工操作！客服 4008-272-278";//        $infooo = R("Func/Func/send_mobile",array($phone,$msg));//        $msg="尊敬的".$phone."，您已成功绑卡，请尽快缴费开通！客服 4008-272-278";        $infooo = R("Func/Func/send_mobile",array($phone,$msg));        dump($infooo);    }    //不用    public function saveMoney(){        $where['user_id']=$_REQUEST['uid'];        M('agent')->where($where)->data(array('status'=>1))->save();       $dd= M('user_operation')->where(array('user_id'=>$_REQUEST['uid']))->find();        M('user')->where(array('user_id'=>$_REQUEST['uid']))->data(array('isopen'=>1))->save();        if ($dd){            $ee['op_name']='自动';            $ee['op_level']='钱兜兜互联网综合服务平台';            $ee['time']=time();            $ee['order_sn']='CS'.date('YmdHis');            $res =M('user_operation')->where(array('user_id'=>$_REQUEST['uid']))->data($ee)->save();            if ($res !== false){                echo json_encode(array('code'=>4449,'缴费成功'));die;            }else{                echo json_encode(array('code'=>4450,'系统繁忙'));die;            }        }else{            $tt['op_status']=1;            $tt['user_id']=$_REQUEST['uid'];            $tt['mark']='推客审核';            $tt['time']=time();            $tt['send_mail']=1;            $tt['send_phone']=1;            $tt['op_name']='自动';            $tt['op_level']='钱兜兜互联网综合服务平台';            $tt['order_sn']='CS'.date('YmdHis');            $tt['sq_type']=1;            $tt['sj_money']=1;            $tt['yj_money']=1;            $tt['is_pay']=1;            $tt['tk_level']=1;           $res = M('user_operation')->add($tt);         if ($res){             echo json_encode(array('code'=>4449,'缴费成功'));die;         }else{             echo json_encode(array('code'=>4450,'系统繁忙'));die;         }        }    }    #升级接口    public function  upgradeLevel(){        $is = $_REQUEST['is_yes'];  //点击的状态        $uid=$_REQUEST['uid']; //用户ID        $array=array(            'uid'=>$_REQUEST['uid'],            'is_yes'=>$_REQUEST['is_yes'],        );        $this->parem = array_merge($this->parem,$array);//        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if ($is == 1){  //点击不升级            $tt['is_upgrade']=1;           $res = M('user')->where(array('user_id'=>$uid))->save($tt);           if ($res !== false){               echo json_encode(array('code'=>6978,'msg'=>'选择了保留当前等级不升级'));die;           }else{               echo json_encode(array('code'=>6979,'msg'=>'系统繁忙'));die;           }        }else{  //选择升级            $tt['is_upgrade']=1;            M('user')->where(array('user_id'=>$uid))->save($tt);            $selfInfo =M('user')->field('user_id,level,utype,pid')->where(array('user_id'=>$uid))->find(); //自己信息            $parentInfo =M('user')->field('user_id,level,utype,pid')->where(array('user_id'=>trim($selfInfo['pid'])))->find();  //上级信息            if ($parentInfo['level'] == 9){  //上级是合伙人   查出大咖 和见习                if($selfInfo['level'] == 1 || !$selfInfo['level']){  //兜客                    $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(" distribution_level_id = 5 or distribution_level_id = 6 or distribution_level_id = 4")->select();                    echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;                }elseif($selfInfo['level'] == 4){                    $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(" distribution_level_id = 6 or distribution_level_id = 5")->select();                    echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;                }else{                    echo json_encode(array('code'=>4512,'msg'=>'不能升至和上级同级或超过上级'));die;                }            }elseif($parentInfo['level'] == 6){  //上级是大咖                $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where('distribution_level_id = 4 or distribution_level_id = 5')->select();                echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;            }elseif($parentInfo['level'] == 5){                $where['distribution_level_id']=4;                $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where($where)->select();                echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;            }        }    }    #个人中心 升级接口(获取到能升什么)    public function selfSjLevelold(){        $uid=$_REQUEST['uid']; //用户ID        $is = $_REQUEST['is_yes'];  //点击的状态        $uid=$_REQUEST['uid']; //用户ID        $array=array(            'uid'=>$_REQUEST['uid'],        );        $this->parem = array_merge($this->parem,$array);//                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $selfInfo =M('user')->field('user_id,level,utype,pid,is_allow')->where(array('user_id'=>$uid))->find(); //自己信息//        echo json_encode(array('code'=>4444,'msg'=>$selfInfo));die;        $parentInfo =M('user')->field('user_id,level,utype,pid')->where(array('user_id'=>trim($selfInfo['pid'])))->find();  //上级信息        if ($parentInfo['level'] == 9){  //上级是合伙人   查出大咖 和见习            if($selfInfo['level'] == 1 || !$selfInfo['level']){  //兜客                $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(" distribution_level_id = 6 or distribution_level_id = 4")->select();                echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;            }elseif($selfInfo['level'] == 4){                $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(" distribution_level_id = 6 ")->select();                echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;            }else{                echo json_encode(array('code'=>4512,'msg'=>'不能升至和上级同级或超过上级'));die;            }        }elseif($parentInfo['level'] == 6){  //上级是大咖            $where['distribution_level_id']=4;            $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where($where)->select();            echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$info));die;        }else{            $parentInfo =M('user')->field('user_id,level,utype,pid')->where(array('user_id'=>trim($selfInfo['pid'])))->find();  //上级信息            if (!$parentInfo){                $jigouInfo= M('institution')->field('institution_id')->where(array('institution_id'=>trim($selfInfo['pid'])))->find();                if ($jigouInfo){                    $xieyiInfo =M('xieyi_registerinfo')->where(array('user_id'=>$uid,'xieyi_id'=>4))->find();//                    if ($xieyiInfo){                        if ($selfInfo['level'] == 4){  //见习                            $is_allow=3;  //可以升级合伙人//                       $wh['distribution_level_id']=9;                            $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(' distribution_level_id = 5 or  distribution_level_id = 6 or distribution_level_id = 9')->select();                            echo json_encode(array('code'=>6977,'msg'=>'可升级合伙人','data'=>$info));die;                        }elseif($selfInfo['level'] == 6){  //大咖                            $is_allow=3;  //可以升级合伙人                            $wh['distribution_level_id']=9;                            $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where($wh)->select();                            echo json_encode(array('code'=>6977,'msg'=>'可升级合伙人','data'=>$info));die;                        }elseif($selfInfo['level'] == 9){                            echo json_encode(array('code'=>2288,'msg'=>'您已到达最高等级'));die;                        }elseif($selfInfo['level'] == 5){                            $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where('distribution_level_id = 6 or distribution_level_id = 9')->select();                            echo json_encode(array('code'=>6977,'msg'=>'可升级钻石推客','data'=>$info));die;                        }//                    }//                    $where['distribution_level_id']=9;//                    $info = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where($where)->select();                }else{                    echo json_encode(array('code'=>4512,'msg'=>'用户不存在或上级不存在'));die;                }            }            echo json_encode(array('code'=>6979,'msg'=>'暂无升级信息'));die;        }    }    #个人中心 升级测试接口    public function  selfSjLevel(){        $uid=$_REQUEST['uid']; //用户ID        $is = $_REQUEST['is_yes'];  //点击的状态        $uid=$_REQUEST['uid']; //用户ID        $array=array(            'uid'=>$_REQUEST['uid'],        );        $this->parem = array_merge($this->parem,$array);//        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $selfInfo =M('user')->field('user_id,level,utype,pid,is_allow')->where(array('user_id'=>$uid))->find(); //自己信息//        echo json_encode(array('code'=>4444,'msg'=>$selfInfo));die;        $parentInfo =M('user')->field('user_id,level,utype,pid')->where(array('user_id'=>trim($selfInfo['pid'])))->find();  //上级信息        if ($selfInfo['level'] == 9){            $is_allow=0;//不能升级        }else{            if ($selfInfo['level'] == 4){  //见习                $shengji = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where('distribution_level_id = 5 or distribution_level_id = 6 or distribution_level_id = 9')->select();            }elseif ($selfInfo['level'] == 6){  //大咖                $is_allow = 3;  //可以升级合伙人                $wh['distribution_level_id'] = 9;                $shengji = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where($wh)->select();            }elseif($selfInfo['level'] == 5){ //银牌                $shengji = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where('distribution_level_id = 6 or distribution_level_id = 9')->select();            }else{ #兜客                $is_allow = 3;  //可以升级合伙人                $shengji = M('distribution_level')->field("distribution_level_id,levelname,ordermoney")->where(array('type' => 20, 'is_use' => 1))->select();            }        }        echo json_encode(array('code'=>6977,'msg'=>'升级信息','data'=>$shengji));die;    }    #升级接口  点击升级的升级信息    public function upgradeTuiKe(){        $uid=trim($_REQUEST['uid']); //用户id        $level=$_REQUEST['level']; //升级的等级        $array=array(            'uid'=>$_REQUEST['uid'],            'level'=>$_REQUEST['level'],        );        $this->parem = array_merge($this->parem,$array);//                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $shengjiInfo = M('distribution_level')->field('distribution_level_id,levelname,ordermoney')->where(array('distribution_level_id'=>$level))->find();        $userInfo = M('myrealname')->field('nickname,idcard')->where(array('user_id'=>$uid))->find();        $userInfo['phone'] = M('user')->where(array('user_id'=>$uid))->getField('phone');        $userInfo['name']=$shengjiInfo['levelname'];        $userInfo['money']=$shengjiInfo['ordermoney'];        $userInfo['goods_name']='品牌服务费';        $res =M('user_operation')->where(array('user_id'=>$uid,'op_status'=>6))->find();        $userInfo['sf'] = M("site_config")->where(array('site_config_id'=>1))->getField('sf');        if (!$res){            $userInfo['is_one']='首次';        }else{            $userInfo['is_one']='非首次';            # 当前等级            $currentLevel = M("user")->where(array('user_id'=>$uid))->getField('level');            $currrentMoney = M('distribution_level')->where(array('distribution_level_id'=>$currentLevel))->getField("ordermoney");            $userInfo['money']=$shengjiInfo['ordermoney'] - $currrentMoney;        }       $uINfo =  M('user')->where(array('user_id'=>$uid))->find();        if($uINfo['level'] == '9'){            echo json_encode(array('code'=>'2048','msg'=>'您已到达最顶级,不需要升级啦'));die;        }elseif($uINfo['level'] == '6'){            $wh['distribution_level_id']=9;            $InfoAll = M('distribution_level')->field("distribution_level_id,levelname,ordermoney,is_tj")->where($wh)->select();            foreach($InfoAll as $k=>$v){                if ($v['distribution_level_id'] == 9){                    if($uINfo['is_allow'] == '1'){                        $InfoAll[$k]['is_money'] = 1;                    }else{                        $InfoAll[$k]['is_money'] = 1;                    }                }else{                    $InfoAll[$k]['is_money'] = 1;                }            }        }elseif($uINfo['level'] == '5'){ //银牌推客            $InfoAll = M('distribution_level')->field("distribution_level_id,levelname,ordermoney,is_tj")->where('distribution_level_id = 6 or distribution_level_id = 9')->select();        }elseif($uINfo['level'] == '4'){            $InfoAll = M('distribution_level')->field("distribution_level_id,levelname,ordermoney,is_tj")->where('distribution_level_id = 5 or distribution_level_id = 6 or distribution_level_id = 9')->select();            foreach($InfoAll as $k=>$v){                if ($v['distribution_level_id'] == 9){                    if($uINfo['is_allow'] == '1'){                        $InfoAll[$k]['is_money'] = 1;                    }else{                        $InfoAll[$k]['is_money'] = 1;                    }                }else{                    $InfoAll[$k]['is_money'] = 1;                }            }        }else{            $InfoAll = M('distribution_level')->field("distribution_level_id,levelname,ordermoney,is_tj")->where(" ( type = 20 and is_use = 1 ) or type = 1 ")->order('distribution_level_id desc')->select();            foreach($InfoAll as $k=>$v){                if ($v['distribution_level_id'] == 9){                    if($uINfo['is_allow'] == '1'){                        $InfoAll[$k]['is_money'] = 1;                    }else{                        $InfoAll[$k]['is_money'] = 1;                    }                }else{                    $InfoAll[$k]['is_money'] = 1;                }            }        }        echo json_encode(array('code'=>4456,'msg'=>'获取成功','data'=>$userInfo,'xieyiurl'=>"https://wallet.insoonto.com/Payapi/BaseFunc/getXieyi?type=1&level={$level}&uid=".$uid,'InfoAll'=>$InfoAll));die;     }    #升级接口 不点击 自动获取    public function upgradeTuiKeZd(){        $uid=trim($_REQUEST['uid']); //用户id        $array=array(            'uid'=>$_REQUEST['uid'],        );        $this->parem = array_merge($this->parem,$array);//                $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;                if ($this->sign !== $msg){                    echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;                }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $userData= M('user')->field('user_id,phone,level,is_allow')->where(array('user_id'=>$uid))->find();        $shengjiInfo = M('distribution_level')->field('distribution_level_id,levelname,ordermoney')->where(array('distribution_level_id'=>$userData['level']))->find();        $userInfo = M('myrealname')->field('nickname,idcard')->where(array('user_id'=>$uid))->find();        $userInfo['phone']=$userData['phone'];        $userInfo['name']=$shengjiInfo['levelname'];        $userInfo['money']=$shengjiInfo['ordermoney'];        $userInfo['goods_name']='品牌服务费';        $userInfo['sf'] = M("site_config")->where(array('site_config_id'=>1))->getField('sf');        $res =M('user_operation')->where(array('user_id'=>$uid,'op_status'=>6))->find();        if (!$res){            $userInfo['is_one']='首次';        }else{            $userInfo['is_one']='非首次';            # 当前等级            $currentLevel = M("user")->where(array('user_id'=>$uid))->getField('level');            $currrentMoney = M('distribution_level')->where(array('distribution_level_id'=>$currentLevel))->getField("ordermoney");            $userInfo['money']=$shengjiInfo['ordermoney'] - $currrentMoney;        }//        SELECT * FROM `y_distribution_level` WHERE type = 20 and is_use = 1 or type = 1        $InfoAll = M('distribution_level')->field("distribution_level_id,levelname,ordermoney,is_tj")->where(" ( type = 20 and is_use = 1 ) or type = 1 ")->order('distribution_level_id desc')->select();        foreach($InfoAll as $k=>$v){            if ($v['distribution_level_id'] == 9){                if($userData['is_allow'] == '1'){                    $InfoAll[$k]['is_money'] = 1;                }else{                    $InfoAll[$k]['is_money'] = 1;                }            }else{                $InfoAll[$k]['is_money'] = 1;            }        }        echo json_encode(array('code'=>4456,'msg'=>'获取成功','data'=>$userInfo,'xieyiurl'=>"https://wallet.insoonto.com/Payapi/BaseFunc/getXieyi?type=1&level={$userData['level']}&uid=".$uid,'InfoAll'=>$InfoAll));die;    }    #点击申请合伙人    public function upgradeHeHuoRen(){        $uid=trim($_REQUEST['uid']); //用户id        $level=$_REQUEST['level'];        $array=array(            'uid'=>$_REQUEST['uid'],            'level'=>$_REQUEST['level'],        );        $this->parem = array_merge($this->parem,$array);//        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'网络异常,请重新登录'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$level){            echo json_encode(array('code'=>4238,'msg'=>'请选择申请的等级'));die;        }        if (!$uid){            echo json_encode(array('code'=>4238,'msg'=>'参数不完整'));die;        }        if($level == '4'){   //申请见习            $one = M('user')->field('user_id,level,utype,is_allow')->where(array('user_id'=>$uid))->find();            if ($one['level'] == 1 ||  !$one['level']){                echo json_encode(array('code'=>4248,'msg'=>'可升级'));die;            }else{                echo json_encode(array('code'=>4249,'msg'=>'不可升至此等级'));die;            }        }elseif($level == '6'){ //申请大咖            $one = M('user')->field('user_id,level,utype,is_allow')->where(array('user_id'=>$uid))->find();            if($one['level'] == 6 || $one['level'] == 9){                echo json_encode(array('code'=>4249,'msg'=>'不可升至此等级'));die;            }else{                echo json_encode(array('code'=>4248,'msg'=>'可升级'));die;            }        }elseif($level == '9'){  //合伙人申请提交            $one = M('user')->field('user_id,level,utype,is_allow')->where(array('user_id'=>$uid))->find();            if ($one['level'] != 9){ //可升级合伙人//                if ($one['is_allow'] == 3){   //审批中//                    echo json_encode(array('code'=>4249,'msg'=>'您的申请正在审批中'));die;//                }elseif($one['is_allow'] == 2){   // 正常状态 提交申请//                    $res = M('user')->where(array('user_id'=>$uid))->save(array('is_allow'=>3));//                    if ($res !== false){//                        echo json_encode(array('code'=>4250,'msg'=>'您好，您的合伙人申请正在审核中，请您保持电话畅通，以便我们进行资格审核。'));die;//                    }else{//                        echo json_encode(array('code'=>4249,'msg'=>'系统繁忙,请稍后再提交'));die;//                    }//                }elseif($one['is_allow'] == 1){   //允许申请                    echo json_encode(array('code'=>4248,'msg'=>'可升级合伙人'));die;//                }elseif($one['is_allow'] == 4){  //拒绝申请//                    echo json_encode(array('code'=>4249,'msg'=>'您的申请已被拒绝.'));die;//                }            }else{                echo json_encode(array('code'=>4249,'msg'=>'不可升至此等级'));die;            }        }elseif($level == '5'){ #银牌推客            $one = M('user')->field('user_id,level,utype,is_allow')->where(array('user_id'=>$uid))->find();            if($one['level'] == 6 || $one['level'] == 9 || $one['level'] == 5){                echo json_encode(array('code'=>4249,'msg'=>'不可升至此等级'));die;            }else{                echo json_encode(array('code'=>4248,'msg'=>'可升级'));die;            }        }//        echo json_encode(array('code'=>4249,'msg'=>$level));die;    }}