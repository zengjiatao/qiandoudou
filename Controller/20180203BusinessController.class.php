<?php# 银钱包 - 商家功能模块namespace Payapi\Controller;class BusinessController extends BaseController {    public $cityinfo;    public $parem;    public $sign;    public $business_id;    public function _initialize()    {        parent::_initialize();        $this->uid = $_REQUEST['uid'];        $this->business_id=$_REQUEST['business_id'];        $this->parem=array(            'signType'=>$_REQUEST['signType'],            'timestamp' => $_REQUEST['timestamp'],            'dataType' => $_REQUEST['dataType'],            'inputCharset' => $_REQUEST['inputCharset'],            'version' => $_REQUEST['version'],        );        $this->sign = $_REQUEST['sign'];        $ipd = R("Func/Func/getIpAdr"); // ip地址        $url = "https://apis.map.qq.com/ws/location/v1/ip/?ip=".$ipd."&key=".C("QQMAPAPI");        $city = R("Func/Func/globalCurlGet",array($url));        $city = json_decode($city,true);        $this->cityinfo = $city['result'];    }    # 列表    public function getList(){//        if (!$this->sign){////            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;////        }////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//////        dump($msg);die;////        if ($this->sign !== $msg){////            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;////        }////        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)////        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $cw['is_index'] = 1;        $cate = R('Func/Business/getCate',array($cw));   //行业        $jxw['is_jx'] = 1;        $cityinfo = $this->cityinfo['ad_info'];        $jxw['city_id'] = M("city")->where(array('city'=>array("like","%{$cityinfo['city']}%")))->getField('cityids');        $loc = $this->cityinfo['location'];        $jl['lat1'] = $loc['lat'];        $jl['lng1'] = $loc['lng'];        $jxlist = R('Func/Business/getList',array($jxw,$jl));  //精选        $lw['is_tuijian'] = 1;        $cityinfo = $this->cityinfo['ad_info'];        $lw['city_id'] = M("city")->where(array('city'=>array("like","%{$cityinfo['city']}%")))->getField('cityids');//        dump(M('city')->_sql());die;        $p = intval($_REQUEST['page']);        $psize = intval($_REQUEST['psize']);        $list = R('Func/Business/getList',array($lw,$jl,$p,$psize));        # 轮播图        $lbarr = R('Func/Func/getLunbo',array(2));        #附近icon        $banner = M('industry')->field('industry_id,icon,name')->where(array('type'=>1,'status'=>1))->order('sort asc')->select();//        foreach ($jxlist as $k=>$v){//            unset($jxlist['coupon']);//        }//        foreach ($list as $k=>$v){//            unset($list['coupon']);//        }//        $sheng=M('province')->where(array('provids'=>$data['province_id']))->getField('province');//        $shi=M('city')->where(array('cityids'=>$data['city_id']))->getField('city');//        $qu=M('area')->where(array('areaids'=>$data['area_id']))->getField('area');//        $diQuName=$sheng.$shi.$qu.$data['address'];        foreach ($jxlist as $k =>$v){            $jxlist[$k]['thumb']=enThumb('./Uploads/',$v['thumb']);            unset($jxlist[$k]['coupon']);        }        foreach ($list as $k =>$v){            $list[$k]['thumb']=enThumb('./Uploads/',$v['thumb']);            unset($list[$k]['coupon']);        }//        dump($jxlist);//        unset($jxlist['coupon']);//        unset($list['coupon']);        $d = array(            'code' => 2001,            'msg' => '商家首页',            'data' => array(                'city' => $this->cityinfo,                'lbarr' => $lbarr,  //轮播图                'banner'=>$banner, //icon//                'cate' => $cate,                'jxlist' => $jxlist,    //jx                'list' => $list  // tj            )        );        echo json_encode($d);exit;    }    public function getBusinesslist()    {               if (!$this->sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                //        dump($msg);die;                if ($this->sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;                    }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                          $industry_id=$_REQUEST['industry_id'];                $keword=$_REQUEST['keword'];                 $lat=$_REQUEST['lat'];        $lng=$_REQUEST['lng'];        $page = $_REQUEST['page'];  //页数        if(!$lat)        {            $lat= $this->cityinfo["location"]['lat'];        }                if(!$lng)        {            $lng= $this->cityinfo["location"]['lng'];        }        $cityinfo = $this->cityinfo['ad_info'];        $where['city_id'] = M("city")->where(array('city'=>array("like","%{$cityinfo['city']}%")))->getField('cityid');        if($keword)        {            $where['_string']=" nick_name like '%$keword%' or phone like '%$keword%' or  name like '%$keword%' or address like '%$keword%' or shop_name like '%$keword%' ";        }//           var_dump($this->cityinfo);        if(!$page)        {            $page=1;        }                $pagenum=15;        $startnum=($page-1)*$pagenum;        $endnum=$page*$pagenum;                $limit=''.$startnum.','.$endnum.'';        //         $where['_string']=" industry_id=".$industry_id;        if($industry_id)        {            $where['industry_id']=$industry_id;        }//         echo $lat.",".$lng;        if($where){            $businesslist=M('business')->where($where)->field('y_business.*,ROUND(6378.138*2*ASIN(SQRT(POW(SIN(('.$lat.'*PI()/180-y_business.lat*PI()/180)/2),2)+COS('.$lat.'*PI()/180)*COS(y_business.lat*PI()/180)*POW(SIN(('.$lng.'*PI()/180-y_business.lng*PI()/180)/2),2)))*1000) AS juli')->limit($limit)->order('juli DESC')->select();                    }else{            $businesslist=M('business')->field('y_business.*,ROUND(6378.138*2*ASIN(SQRT(POW(SIN(('.$lat.'*PI()/180-y_business.lat*PI()/180)/2),2)+COS('.$lat.'*PI()/180)*COS(y_business.lat*PI()/180)*POW(SIN(('.$lng.'*PI()/180-y_business.lng*PI()/180)/2),2)))*1000) AS juli')->limit($limit)->order('juli DESC')->select();                    }      //         echo M('business')->getLastSql();                for ($i = 0; $i < count($businesslist); $i++) {            $businesslist[$i]['thumb']=enThumb("./Uploads/",$businesslist[$i]['thumb']);            $businesslist[$i]['zhizhaoPic']=enThumb("./Uploads/",$businesslist[$i]['zhizhaoPic']);            $businesslist[$i]['goodsPic']=enThumb("./Uploads/",$businesslist[$i]['goodsPic']);        }                echo json_encode(array('code'=>200,'msg'=>'获取成功','businesslist'=>$businesslist));die;                   }    # 详情    public function getDetail()    {        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array=array(            'id'=>intval($_REQUEST['id']),        );        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断            $w['business_id'] = intval($_REQUEST['id']);            $loc = $this->cityinfo['location'];            $jl['lat1'] = $loc['lat'];            $jl['lng1'] = $loc['lng'];            $d = R('Func/Business/getList',array($w,$jl));            if(!$d)            {                $d = array(                    'code' => 400,                    'msg' => '没有这个参数值'                );                echo json_encode($d);exit;            }            # 猜你喜欢            $tj['cate'] = $d[0]['city_id'];            $tj['business_id'] = array('neq',$d[0]['business_id']);            $cityinfo = $this->cityinfo['ad_info'];            $tj['city_id'] = M("city")->where(array('name'=>$cityinfo['city']))->getField('cityids');            $tjdata = R('Func/Business/getList',array($tj,$jl,1,5));            $tjsjdata = shuffle_assoc($tjdata);            $this->assign('d',$d[0]);            $this->assign('tjsjdata',$tjsjdata);        $d = array(            'code' => 2002,            'msg' => '商家详情',            'data' => array(                'detail' => $d[0],                'tjsjdata' => $tjsjdata  // 相关推荐            )        );        echo json_encode($d);exit;    }    # 领取优惠券    public function ajaxLqCoupon()    {        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array=array(            'uid'=>$this->uid,            'couponid'=>intval($_REQUEST['couponid']),            'bid'=>intval($_REQUEST['bid']),        );        $this->parem = array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        dump($msg);die;        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $w['coupon_id'] = intval($_REQUEST['couponid']);        $w['business_id'] = intval($_REQUEST['bid']);        if(empty($w['coupon_id']) && empty($w['business_id']))        {            $d = array(                'code'=>200,                'msg'=>'参数不全'            );            echo json_encode($d);exit;        }        $w['user_id'] = $this->uid;        $yhqarr['coupon_id'] = intval($_REQUEST['couponid']);        $yhqcount = R("Func/Business/getCoupon",array($w['business_id'],$yhqarr));        $count = R("Func/Business/getLqCoupon",array($w));        $lq_num = $yhqcount[0]['lq_num'];        # 判断每个人针对优惠券是否可以领取多张        if($count<=0)        {            if($count>$lq_num)            {                $d = array(                    'code'=>200,                    'msg'=>'已超出领取次数'                );            }else{                # 添加领取数据                $data['openid'] = trim($this->openid);                $data['user_id'] = trim($this->user_id);                $data['coupon_id'] = intval($_REQUEST['couponid']);                $data['gettime'] = time();                $data['used'] = 0;                $data['business_id'] = intval($_REQUEST['bid']);                M('coupon_data')->add($data);                $d = array(                    'code'=>400,                    'msg'=>'领取成功'                );            }        }else{            $d = array(                'code'=>700,                'msg'=>'已领取'            );        }        echoAJson($d);exit;    }    #商家 收款记录(本月)    public function receiptList(){        $uid = $_REQUEST['business_id'];  //商家ID//        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$uid,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'网络错误,请重新提交'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$uid){            echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;        }        $p=$_REQUEST['page'];        if (!$p){            $p=0;        }        #订单总数        $data = R('Func/Business/orderList',array($uid,$p));        $count = R('Func/Business/orderSum',array($uid));        //商家营业总额        $rental=R('Func/Business/rental',array($uid));        $rentalMoney=sprintf("%.2f",$rental);        $counts=count($count);        $sum=ceil($counts/5);//        echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>$details,'pagesize'=>$sum,'pagesum'=>$pagesum));die;        echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>$data,'pagesize'=>$count,'pagesum'=>$sum,'rental'=>$rentalMoney));        die;    }    #商家 收款记录(指定月份)    public function selectReceipt(){        $sj =$_REQUEST['time'];        $uid = $_REQUEST['business_id'];        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$uid,            'time'=>$_REQUEST['time'],        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$uid || !$sj){            echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;        }        $p=$_REQUEST['page'];        if (!$p){            $p=0;        }        $num=15;        if (!$sj){            echo json_encode(array('code'=>6901,'msg'=>'日期参数不存在'));die;        }        $zhidingY=$sj.'-01 00:00:00';        $strY=substr($sj,0,4).'-';        $zhidingM=strtotime($zhidingY);        $endday = strtotime(date($strY.'m-d', mktime(23, 59, 59, date('m', strtotime($zhidingY))+1, 00)));        $endday=$endday+86399;//        dump($endday);die;        $w['business_id']=$uid;        $w['t']=array(array('egt',$zhidingM),array('elt',$endday));        $benyue=array();        $count =M('business_order')->alias('a')->field('a.*,b.money_type_id as b_id,b.type as b_type')->join('left join y_money_type as b on a.money_type_id = b.money_type_id')->where($w)->order('t desc')->count();        $sum=ceil($count/$num);        $data =M('business_order')->alias('a')->field('a.*,b.money_type_id as b_id,b.type as b_type')->join('left join y_money_type as b on a.money_type_id = b.money_type_id')->where($w)->order('t desc')->limit($p*$num,$num)->select();        foreach ($data as $k=>$v){            if($v['money_type_id'] == 7){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 5){                $data[$k]['symbol']='-';            }        }        //商家营业总额        $rental=R('Func/Business/rental',array($uid));        $rentalMoney=sprintf("%.2f",$rental);        echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>$data,'pagesize'=>$count,'pagesum'=>$sum,'rental'=>$rentalMoney));die;    }    #商家 订单详情    public function selectOrder(){        $id=$_REQUEST['business_order_id'];        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_order_id'=>$id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$id){            echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;        }        $w['business_order_id']=$id;        $data =M('business_order')->field('business_order_id,business_id,user_id,goods_name,user_pay_supply_id,goods_type,pay_name,service_charge,pt_ordersn,timestamp,sh_ordersn,jy_status,js_status,money,pay_money,money_type_id,t,d_t,coupon_data_id,jifen_jilu_id,minus')->where($w)->find();        //付款用户名称        if ($data['user_id'] == '12' || $data['user_id'] == '13' || $data['user_id'] == '14' || $data['user_id'] == '15'){            $data['nick_name']=M('user')->where(array('user_id'=>$data['user_id']))->getField('nick_name');        }else{            $user_name=M('user')->where(array('user_id'=>$data['user_id']))->getField('nick_name');            $member =M('business_member')->where(array('business_id'=>$data['business_id'],'user_id'=>$data['user_id']))->find();           if ($member){  //存在当前商家会员表中            $data['nick_name']=$user_name.'-'.'店铺会员';           }else{               $data['nick_name']=$user_name.'-'.'普通用户';           }        }        if ($data['jifen_jilu_id']){         $data['jifen']=M('jifen_jilu')->where(array('jifen_jilu_id'=>$data['jifen_jilu_id']))->getField('num');        }else{            $data['jifen']='';        }        if ($data['coupon_data_id']){           $couponId=M('coupon_data')->where(array('coupon_data_id'=>$data['coupon_data_id']))->getField('coupon_id');           $data['coupon_money']=M('coupon')->where(array('coupon'=>$couponId))->getField('money');        }else{            $data['coupon_money']='';        }        if (!$data['minus']){           $data['minus']=0;        }        //支付方式        $data['fukuan']=M('user_pay_supply')->where(array('user_pay_supply_id'=>$data['user_pay_supply_id']))->getField('name');        echo json_encode(array(array('code'=>6501,'msg'=>'获取成功','data'=>$data)));die;    }    #商家中心首页    public function BusinessCenter(){       $business_id=$_REQUEST['business_id'];        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$business_id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$business_id){            echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;        }         $data = M('business')->field('business_id,name,thumb,shop_name')->where(array('business_id'=>$business_id))->find();        $data['thumb']=enThumb('./Uploads/',$data['thumb']);        #今日营业额         $today=R('Func/Business/today',array($business_id));         $todayMoney=sprintf("%.2f",$today);  //保留两位小数        #昨日营业额        $yesterday=R('Func/Business/yesterday',array($business_id));        $yesterdayMoney=sprintf("%.2f",$yesterday);  //保留两位小数        #可结算金额        $canMoney=M('business')->where(array('business_id'=>$business_id))->getField('business_wallet');        #店铺粉丝   business_cate_id 商家会员分类字段        $fans = M('business_member')->where(array('business_id'=>$business_id))->count();        #店铺会员   商家会员表        $member=M('business_member')->where(array('business_id'=>$business_id))->count();        echo json_encode(array('code'=>6501,'msg'=>'获取成功','today'=>$todayMoney,'yesterday'=>$yesterdayMoney,'member'=>$member,'fans'=>$fans,'canMoney'=>$canMoney,'data'=>$data));die;    }    #展示修改信息接口    public function MyDetails(){        // 商家id        $business_id=$_REQUEST['business_id'];        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$business_id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        if (!$business_id){            echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;        }        $data=M('business')->field('ms,thumb,business_id,user_id,phone,province_id,city_id,area_id,detailed_address,discount,address,shop_start_time,shop_end_time,minus,youhui,name,province_id,city_id,area_id,shop_name')->where(array('business_id'=>$business_id))->find();        $data['thumb']=enThumb('./Uploads/',$data['thumb']);        $sheng=M('province')->where(array('provids'=>$data['province_id']))->getField('province');        $shi=M('city')->where(array('cityids'=>$data['city_id']))->getField('city');        $qu=M('area')->where(array('areaids'=>$data['area_id']))->getField('area');        $diQuName=$sheng.$shi.$qu.$data['address'];        $data['xiangXi_diZhi']=$diQuName;        $images=M('business_thumb')->where(array('business_id'=>$business_id))->select();        foreach ($images as $k=>$v){            $images[$k]['image_pic']=enThumb('./Uploads/',$v['thumb']);        }        echo json_encode(array('code'=>3005,'msg'=>'获取成功','data'=>$data,'images'=>$images));die;    }    #修改接口    public function saveDetails(){  //修改详细信息        $shop_name=urldecode($_REQUEST['shop_name']);        $business_id=$_REQUEST['business_id'];        $phone=$_REQUEST['phone'];        //店铺地址        $province_id = $_REQUEST['province_id'];  //省id        $city_id = $_REQUEST['city_id'];  //市id        $area_id = $_REQUEST['area_id'];  //区id        $address=urldecode($_REQUEST['address']);  //详细地址        $thumb=urldecode(trim($_REQUEST['thumb']));//店铺门面照        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }//        $array = array(//            'business_id'=>$business_id,//        );////        $this->parem=array_merge($this->parem,$array);////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        if ($this->sign !== $msg){//            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;//        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $tt['province_id']=$_REQUEST['province_id'];        $tt['city_id'] = $_REQUEST['city_id'];        $tt['area_id'] = $_REQUEST['area_id'];        $tt['address'] = $address;        if (!$_REQUEST['thumb']){        }else{            $tt['thumb'] = $thumb;        }        $tt['phone']=$phone;        $tt['shop_name']=$shop_name;        $tt['ms']=urldecode($_REQUEST['ms']);        $res = M('business')->where(array('business_id'=>$business_id))->save($tt);        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'修改成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'修改失败'));die;        }    }    #修改营业时间    public function saveShopTime(){        $start_time=$_REQUEST['start_time'];        $end_time=$_REQUEST['end_time'];        $business_id=$_REQUEST['business_id'];        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'start_time'=>$start_time,            'end_time'=>$end_time,            'business_id'=>$business_id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $tt['shop_start_time']=$start_time;        $tt['shop_end_time']=$end_time;        $res = M('business')->where(array('business_id'=>$business_id))->save($tt);        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'修改成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'修改失败'));die;        }    }    #优惠活动更改    public function saveHuoDong(){        #新用户立减        $minus=$_REQUEST['minus'];        #钱兜兜支付        $discount=$_REQUEST['discount'];        #其他优惠        $business_id=$_REQUEST['business_id'];        $youhui=urldecode($_REQUEST['youhui']);        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$business_id,            'minus'=>$minus,            'discount'=>$discount,            'youhui'=>$youhui        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $tt['minus']=$minus;        $tt['discount']=$discount;        $tt['business_id']=$business_id;        $tt['youhui']=$youhui;        $res = M('business')->where(array('business_id'=>$business_id))->save($tt);        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'修改成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'修改失败'));die;        }    }    #商品店铺图片 上传    public function imagesAdd(){        $business_id=$_REQUEST['business_id'];        $thumb=$_REQUEST['thumb'];        if (!$business_id){            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;        }//        if (!$thumb){//            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;//        }//        if (!$big_thumb){//            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;//        }        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }//        $array = array(//            'business_id'=>$business_id,//            'thumb'=>$_REQUEST['thumb'],//        );////        $this->parem=array_merge($this->parem,$array);////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密////        if ($this->sign !== $msg){//            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;//        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $array=json_decode($thumb,true);        $name = M('business')->where(array('business_id'=>$business_id))->getField('name');        $status=1;        foreach($array['images'] as $k=>$v){           if ($v != ''){               $info=M('business_thumb')->where(array('business_id'=>$business_id,'key_name'=>$k))->find();               if ($info){                   $ww['thumb']=$v;                   $big_thumb=$v."_thumb.jpg";                   $ww['big_thumb']=$big_thumb;                   $ww['key_name']=$k;                   $res = M('business_thumb')->where(array('business_id'=>$business_id,'key_name'=>$k))->save($ww);;               }else{                   $tt['business_id']=$business_id;                   $tt['thumb']=$v;                   $big_thumb=$v."_thumb.jpg";                   $tt['big_thumb']=$big_thumb;                   $tt['name']=$name;                   $tt['status']=$status;                   $tt['key_name']=$k;                   $res = M('business_thumb')->add($tt);               }           }//        $big_thumb=$_REQUEST['thumb'].'_thumb.jpg';        }        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'上传成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'上传失败'));die;        }    }    #删除图片    public function imageDel(){        $business_thumb_id=$_REQUEST['business_thumb_id'];        if (!$business_thumb_id){            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;        }        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_thumb_id'=>$business_thumb_id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        $res = M('business_thumb')->where(array('business_thumb_id'=>$business_thumb_id))->delete();        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'删除成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'删除失败'));die;        }    }    #修改图片    public function imageSave(){        $business_id=$_REQUEST['business_id'];        $business_thumb_id=$_REQUEST['business_thumb_id'];        $thumb=$_REQUEST['thumb'];//        $big_thumb=$_REQUEST['thumb'].'_thumb.jpg';        if (!$business_thumb_id){            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;        }        if (!$thumb){            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;        }        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array=json_decode($thumb,true);        $name = M('business')->where(array('business_id'=>$business_id))->getField('name');        $status=1;//        $array = array(//            'business_thumb_id'=>$business_thumb_id,//            'thumb'=>$_REQUEST['thumb'],//        );//        $this->parem=array_merge($this->parem,$array);////        $msg = R('Func/Func/getKey',array($this->parem));//返回加密//        if ($this->sign !== $msg){//            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;//        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        foreach($array['images'] as $k=>$v){            if ($v != ''){                $tt['thumb']=$v;                $tt['big_thumb']=$v.'_thumb.jpg';                $res = M('business_thumb')->where(array('business_id'=>$business_id,'key_name'=>$k))->save($tt);            }//        $big_thumb=$_REQUEST['thumb'].'_thumb.jpg';        }//        $res = M('business_thumb')->where(array('business_thumb_id'=>$business_thumb_id))->save($tt);        if ($res !== false){            echo json_encode(array('code'=>3065,'msg'=>'修改成功'));die;        }else{            echo json_encode(array('code'=>3055,'msg'=>'修改失败'));die;        }    }    #展示已上传图片    public function imageList(){        $business_id=$_REQUEST['business_id'];        $res = M('business_thumb')->where(array('business_id'=>$business_id,'thumb'=>array('neq','')))->select();        if (!$business_id){            echo json_encode(array('code'=>3055,'msg'=>'参数错误'));die;        }        if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }        $array = array(            'business_id'=>$business_id,        );        $this->parem=array_merge($this->parem,$array);        $msg = R('Func/Func/getKey',array($this->parem));//返回加密        if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }        R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)        $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断        foreach($res as $k=>$v){            $res[$k]['thumb']=enThumb('./Uploads/',$v['thumb']);            $res[$k]['big_thumb']=enThumb('./Uploads/',$v['big_thumb']);        }        echo json_encode(array('code'=>4015,'msg'=>'获取成功','data'=>$res));die;    }    ///////////////////////////////////////////////////底线////////////////////////////////////////////////////////////////////////////////////////////////////////        //商家优惠劵接口    public function businesscoupon()    {        // 商家id        $business_id=$_REQUEST['business_id'];              if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }                $array = array(            'business_id'=>$business_id,        );                $this->parem=array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                if (!$business_id){                        echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                    }                           $page = $_REQUEST['page'];  //页数        $state = $_REQUEST['state'];  //状态                if(!$page)        {            $page=1;        }                if($state==0)        {            $where['y_coupon.status']=array('eq',$state);                    }else  if($state==1)        {            $where['y_coupon.status']=array('eq',$state);                    }else        {            $where['y_coupon.status']=array('neq',-1);        }                $pagenum=15;        $startnum=($page-1)*$pagenum;        $endnum=$page*$pagenum;                $limit=''.$startnum.','.$endnum.'';                $where['y_coupon.business_id']=array('eq',$business_id);        $couponlist=M('coupon')->JOIN('LEFT JOIN y_coupon_cate on y_coupon_cate.coupon_cate_id=y_coupon.coupon_cate_id')->where($where)->limit($limit)->field('y_coupon.*,y_coupon_cate.name as cname')->order('coupon_id desc')->select();                echo json_encode(array('code'=>200,'msg'=>'获取成功','couponlist'=>$couponlist));die;                            }            //删除优惠劵    public function deletecoupon()    {                // 商家id        $business_id=$_REQUEST['business_id'];               if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }                $array = array(            'business_id'=>$business_id,        );                $this->parem=array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                if (!$business_id){                        echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                    }                   $coupon_id=$_REQUEST['coupon_id'];                $where['business_id']=$business_id;        $where['coupon_id']=$coupon_id;        $coupon=M('coupon')->where($where)->find();        if($coupon['status']==1)        {            if($coupon['end_time']>time())  //判断时间是否已过期            {                echo json_encode(array('code'=>6502,'msg'=>'优惠劵正在使用中，不能删除'));die;            }        }               $data['status']="-1";       $res = M('coupon')->where($where)->save($data);       if($res)        {           echo json_encode(array('code'=>200,'msg'=>'删除成功'));die;       }else {           echo json_encode(array('code'=>201,'msg'=>'系统错误'));die;       }           }        //停用优惠劵    public function stopcoupon()    {                // 商家id        $business_id=$_REQUEST['business_id'];                  if (!$this->sign){         echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;         }                  $array = array(         'business_id'=>$business_id,         );                  $this->parem=array_merge($this->parem,$array);                  $msg = R('Func/Func/getKey',array($this->parem));//返回加密                  if ($this->sign !== $msg){         echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;         }                  R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                  $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                  if (!$business_id){                  echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                  }                  $coupon_id=$_REQUEST['coupon_id'];                $where['business_id']=$business_id;        $where['coupon_id']=array('in',$coupon_id);        $coupon=M('coupon')->where($where)->select();                      $data['status']="0";        $res = M('coupon')->where($where)->save($data);        if($res)        {            echo json_encode(array('code'=>200,'msg'=>'停用成功'));die;        }else {            echo json_encode(array('code'=>201,'msg'=>'系统错误'));die;        }            }    //获取商家优惠劵分类    public function getcouponcate()    {        // 商家id        $business_id=$_REQUEST['business_id'];               if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }                $array = array(            'business_id'=>$business_id,        );                $this->parem=array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                if (!$business_id){                        echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                    }                  $wherep['type']=array('eq',2);  //获取商家优惠券类型        $couponcate=M('coupon_cate')->where($wherep)->select();        if ($couponcate){            echo json_encode(array('code'=>200,'msg'=>'获取成功','coupon_cate'=>$couponcate));die;        }else {            echo json_encode(array('code'=>201,'msg'=>'获取信息为空'));die;        }            }        //添加优惠劵    public  function  addcoupon()    {                // 商家id        $business_id=$_REQUEST['business_id'];                if (!$this->sign){            echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;        }                $array = array(            'business_id'=>$business_id,        );                $this->parem=array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){            echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;        }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断                if (!$business_id){                        echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                    }                   $data=I('REQUEST.');                $res=M('coupon')->add($data);                if ($res){            echo json_encode(array('code'=>200,'msg'=>'添加成功'));die;        }else         {            echo json_encode(array('code'=>201,'msg'=>'添加失败'));die;        }                            }    //对应分类  的商家    public function cateBusiness(){        $industry_id=$_REQUEST['industry_id']; //行业id        $res = M('business')->alias('a')->field('a.thumb,a.name,a.discount,a.business_id,b.total,b.name as b_name,b.money,b.type')->join('left join y_coupon as b on a.business_id=b.business_id')->where(array('industry_id'=>$industry_id))->select();        echo json_encode(array('code'=>4015,'msg'=>'获取成功','data'=>$res));die;//        M('coupon')->where(array('business_id'=>$))->find();    }}