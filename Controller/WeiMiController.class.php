<?php# 微米空卡代还namespace Payapi\Controller;use Think\Controller;//class WeiMiController extends BaseController{        public $uid;        public $parem;        public $sign;        public $AppKey;        public $AppSecret;        public $AppCode;        public $host;        public $path;                //修改资料        public function _initialize(){                parent::_initialize();                $this->uid = $_REQUEST['user_id'];                $this->parem=array(                        'signType'=>$_REQUEST['signType'],                        'timestamp' => $_REQUEST['timestamp'],                        'dataType' => $_REQUEST['dataType'],                        'inputCharset' => $_REQUEST['inputCharset'],                        'version' => $_REQUEST['version'],                    );                $this->AppKey='24690055';                $this->AppSecret='92aab17a6f66a39ed6dc0b383041dcd9';                $this->AppCode='c9e2e959b905414a8f161489cfc7b7ac';                $this->host="http://api43.market.alicloudapi.com";                $this->path="/api/c43";                $this->sign = $_REQUEST['sign'];            }         //获取平台的token方法     public function createusertoken()    {        /*         if (!$this->sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $nick_name = $_REQUEST['nick_name'];                $array=array(                        'uid'=>$this->uid,                    );                $this->parem = array_merge($this->parem,$array);                $msg = R('Func/Func/getKey',array($this->parem));//返回加密                if ($this->sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;                    }                R('Func/Func/getTwoSign',array($this->sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $this->sign;//把sign存入session 为作判断          */                 $user_id=$_REQUEST['user_id'];        $token=$_REQUEST['token'];        $addtime=time();                $data['user_id']=$user_id;        $data['token']=$token;        $data['addtime']=$addtime;                $mToken=md5($user_id.$token.$data);                $data['singkey']= $mToken;                $wheretoken['user_id']=$user_id;                $usertoken=M('token')->where($wheretoken)->find();                if($usertoken)        {            $usertoken=M('token')->where($wheretoken)->save($data);        }else {            $usertoken=M('token')->add($data);        }                if($usertoken)        {            echo json_encode(array('code'=>200,'msg'=>'获取成功','mToken'=>$mToken));die;        }else         {            echo json_encode(array('code'=>201,'msg'=>'系统繁忙'));die;        }                 }        //2.1.1.根据token获取用户信息(通用)    public function getrefAccount()    {                      $config = C('WEIMI');        $publickey=$config['publickey'];        $privatekey=$config['privatekey'];        //          $test="你好";//          echo "加密".$this->encrypt_rsa($test,$publickey)."<br/>";//          echo "解密".$this->decrypt_rsa($this->encrypt_rsa($test,$publickey),$privatekey)."<br/>";             $input = file_get_contents('php://input');        //测试数据        /* $input="ETqnnc1ShFhVOU6GUaNFFrRyk3wU34YCVTw8wvdIYeel7fxd11RY+4H881wrGGfh+7iRV12KCGc4MYC+F9TgeFk+fnJWcQm+kaXgeuWT3iEzwGTdZv2GnQUrNxSgSRlvI259dxPcHGGp0Z32KinZ/aEWvDSLW0px+B0tgWQEOWwxlTRzRUSb7t1NGE9AxzTpTNbUs7JGo4n9Rn95HvMW/3NXAQGxL/79dyTqC06TETp4cxobA3xhcMNEJqThH3lhmOuttqAJoSXtSve/S/oyMdPd8snFIj3xyWb/OQbQXuhhl6I0nT/zgkgISCAfQFnG6pgR7F2T4tG9lgKZ9Frxog==";   */            $jsonInfo=$this->decrypt_rsa($input,$privatekey);//         echo $jsonInfo;                $nowtime= date("Y-m-d h:i:s", time());        # 写入日志        R("Payapi/Api/PaySetLog",array("./PayLog","WeiMi_getuserinfo_Return__",$nowtime.'----回调返回信息参数----'.$jsonInfo.'----'));                $data=json_decode($jsonInfo);        //         var_dump($data);                ob_clean(); //处理网页多余的字符                $redata['refAccount']="";        $redata['phone']="";        $redata['resultCode']="0";        $redata['errorCode']="0";        $redata['errorDesc']="0";        $redata['message']="0";                        if($data->token)        {            $whereuser['singkey']=$data->token;            $user=M('token')->join('left join y_user on y_user.user_id =y_token.user_id ')->field('y_user.user_id,y_user.phone')->where($whereuser)->find();                        $redata['refAccount']=$user['user_id'];            $redata['phone']=$user['phone'];            $redata['resultCode']="1";            $redata['errorCode']="0";            $redata['errorDesc']="获取成功";            $redata['message']="获取成功";                    }else{            $redata['refAccount']="";            $redata['phone']="";            $redata['resultCode']="0";            $redata['errorCode']="1";            $redata['errorDesc']="token已过期或不存在";            $redata['message']="token已过期或不存在";        }                $result='{"refAccount" : "'.$redata['refAccount'].'","phone" : "'.$redata['phone'].'","resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';        //         echo $result;        //         $result='﻿{ "token" : "84a098396347b60c7a1512c4a845acc9" }';                $returnmsg=$this->encrypt_rsa($result,$publickey);                echo $returnmsg;        //         echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                            }        //2.1.2.获取外部编号获取用户详细信息(通用)    public function getUserinfo()    {                       $config = C('WEIMI');        $publickey=$config['publickey'];        $privatekey=$config['privatekey'];        //           $test="你好你好你好你好你好";//           echo "加密".$this->encrypt_rsa($test,$publickey)."<br/>";//           echo "解密".$this->decrypt_rsa($this->encrypt_rsa($test,$publickey),$privatekey)."<br/>";                $input = file_get_contents('php://input');               /*  $input ="X/zDPCTOqILGmycq7I0tOcYCVK8qKnsP615qu80p5foaHyi+TzKHoj3vnAKv222cF/kcNMMj+fQERS9gBb15KBPQaCs0QHPXLvhqWqwq80lVouBTrBD9iLTCJ6QjkV640hDLk5GT5eVMP1MzjwcpSgAxoefjiL5GaM0VvdKJUWI="; */                $jsonInfo=$this->decrypt_rsa($input,$privatekey);        //         echo $jsonInfo;                $nowtime= date("Y-m-d h:i:s", time());        # 写入日志        R("Payapi/Api/PaySetLog",array("./PayLog","WeiMi_getUserinfo_Return__",$nowtime.'----回调返回信息参数----'.$jsonInfo.'----'));                $data=json_decode($jsonInfo);                ob_clean(); //处理网页多余的字符                if($data->refAccount)        {            $whereuser['y_user.user_id']=$data->refAccount;            $whereuser['y_mybank.type']=1;            $user=M('user')->join('left join y_myrealname on y_myrealname.user_id=y_user.user_id ')->join('left join y_mybank on y_mybank.user_id=y_user.user_id ')->field('y_user.user_id,y_user.time,y_user.pid,y_user.phone,y_myrealname.nickname,y_myrealname.idcard,y_mybank.province_id,y_mybank.city_id,y_mybank.area_id')->where($whereuser)->find();                        if($user){                $wherep['provid']=$user['province_id'];                                $province=M('province')->where($wherep)->find();                                $wherec['cityid']=$user['city_id'];                                $city=M('city')->where($wherec)->find();                                $wherea['areaid']=$user['area_id'];                                $area=M('area')->where($wherea)->find();                                $redata['refAccount']=$user['user_id'];                $redata['userRegDate']=date("Y-m-d H:i:s",$user['time']);                $redata['userAddr']=$province['province'].$city['city'].$area['area'];                $redata['userRegSource']="微信";                $redata['throughDate']=date("Y-m-d H:i:s",$user['time']);                $redata['userLongitude']=$area['longitude'];                $redata['userLatitude']=$area['latitude'];                $redata['userRecommendCode']=$user['pid'];                $redata['userId']=$user['user_id'];                $redata['userName']=$user['nickname'];                $redata['userLogin']=$user['phone'];                $redata['userPhone']=$user['phone'];                $redata['userEmail']=$user['phone']."@139.com";                $redata['userCardType']="1";                $redata['userCardNo']=$user['idcard'];                $redata['resultCode']="1";                $redata['errorCode']="0";                $redata['errorDesc']="获取成功";                $redata['message']="获取成功";            }else {                $redata['resultCode']="0";                $redata['errorCode']="1";                $redata['errorDesc']="refAccount不存在";                $redata['message']="refAccount不存在";            } //             var_dump($redata);                    }else {                        $redata['resultCode']="0";            $redata['errorCode']="1";            $redata['errorDesc']="refAccount不存在";            $redata['message']="refAccount不存在";        }                        $result='{"refAccount" : "'.$redata['refAccount'].'","userRegDate" : "'.$redata['userRegDate'].'","userAddr" : "'.$redata['userAddr'].'","userRegSource" : "'.$redata['userRegSource'].'","throughDate" : "'.$redata['throughDate'].'","userLongitude" : "'.$redata['userLongitude'].'","userLatitude" : "'.$redata['userLatitude'].'","userRecommendCode" : "'.$redata['userRecommendCode'].'","userId" : "'.$redata['userId'].'","userName" : "'.$redata['userName'].'","userLogin" : "'.$redata['userLogin'].'","userPhone" : "'.$redata['userPhone'].'","userEmail" : "'.$redata['userEmail'].'","userCardType" : "'.$redata['userCardType'].'","userCardNo" : "'.$redata['userCardNo'].'","resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                $returnmsg=$this->encrypt_rsa($result,$publickey);                echo $returnmsg;        //          echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                            }            //2.1.5.获取所有银行卡列表信息（通用）    public function banklist()    {        $config = C('WEIMI');        $publickey=$config['publickey'];        $privatekey=$config['privatekey'];                    $input = file_get_contents('php://input');                /*  $input ="X/zDPCTOqILGmycq7I0tOcYCVK8qKnsP615qu80p5foaHyi+TzKHoj3vnAKv222cF/kcNMMj+fQERS9gBb15KBPQaCs0QHPXLvhqWqwq80lVouBTrBD9iLTCJ6QjkV640hDLk5GT5eVMP1MzjwcpSgAxoefjiL5GaM0VvdKJUWI=";   */                $jsonInfo=$this->decrypt_rsa($input,$privatekey);                //         echo $jsonInfo;                $nowtime= date("Y-m-d h:i:s", time());        # 写入日志        R("Payapi/Api/PaySetLog",array("./PayLog","WeiMi_banklist_Return__",$nowtime.'----回调返回信息参数----'.$jsonInfo.'----'));                $data=json_decode($jsonInfo);                ob_clean(); //处理网页多余的字符                if($data->refAccount)        {            $returnjson="";                        $whereuser['user_id']=$data->refAccount;            $mybank=M('mybank')->join('left join y_bank on y_bank.bank_id=y_mybank.bank_id')->field('y_mybank.*,y_bank.name')->where($whereuser)->select();                                for ($i = 0; $i < count($mybank); $i++) {                $mybanks=$mybank[$i];//                 dump($mybanks);                $redata['userBankCard']=$mybanks['cart'];                $redata['acctBankNm']=$mybanks['name'];//                 echo $mybanks['type'];                $redata['bankCardType']="1";                if($mybanks['type']=='1') //储蓄卡                {                    $redata['bankCardType']="2";                }else{  //信用卡                    $redata['bankCardType']="1";                }                $redata['phoneNo']=$mybanks['mobile'];                                $returnjson=$returnjson.'{"userBankCard" : "'.$redata['userBankCard'].'","acctBankNm" : "'.$redata['acctBankNm'].'","bankCardType" : "'.$redata['bankCardType'].'","phoneNo" : "'.$redata['phoneNo'].'"}'.',';                            }            $returnjson=substr($returnjson,0,strlen($returnjson)-1);                        $returnjson='['.$returnjson.']';            //             echo $returnjson;                        $returnmsg=$this->encrypt_rsa($returnjson,$publickey);                        echo $returnmsg;            //             echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串         }else {            //             $redata['resultCode']="0";//             $redata['errorCode']="1";//             $redata['errorDesc']="refAccount不存在";//             $redata['message']="refAccount不存在";            echo '[]';        }                                    }        //2.1.3.获取用户授信，风控维度信息（合作机构定制）    public function usershouxin()    {        $config = C('WEIMI');        $publickey=$config['publickey'];        $privatekey=$config['privatekey'];                  $input = file_get_contents('php://input');                 /* $input ="X/zDPCTOqILGmycq7I0tOcYCVK8qKnsP615qu80p5foaHyi+TzKHoj3vnAKv222cF/kcNMMj+fQE         RS9gBb15KBPQaCs0QHPXLvhqWqwq80lVouBTrBD9iLTCJ6QjkV640hDLk5GT5eVMP1MzjwcpSgAx         oefjiL5GaM0VvdKJUWI=";   */                 $jsonInfo=$this->decrypt_rsa($input,$privatekey);                //         echo $jsonInfo;                $nowtime= date("Y-m-d h:i:s", time());        # 写入日志        R("Payapi/Api/PaySetLog",array("./PayLog","WeiMi_usershouxin_Return__",$nowtime.'----回调返回信息参数----'.$jsonInfo.'----'));                $data=json_decode($jsonInfo);                ob_clean(); //处理网页多余的字符                if($data->refAccount)        {            $whereuser['y_user.user_id']=$data->refAccount;            $whereuser['y_mybank.type']=1;            $user=M('user')->join('left join y_myrealname on y_myrealname.user_id=y_user.user_id ')->join('left join y_mybank on y_mybank.user_id=y_user.user_id ')->field('y_user.*,y_myrealname.nickname,y_myrealname.idcard,y_mybank.cart,y_mybank.province_id,y_mybank.city_id,y_mybank.area_id')->where($whereuser)->find();                        $whereorder['money_type_id']="11";            $whereorder['user_id']=$data->refAccount;            $whereorder['jy_status']=1;            $whereorder['js_status']=2;                        $sumpay_money=M('money_detailed')->where($whereorder)->sum('pay_money');            $sumpay_moneycount=M('money_detailed')->where($whereorder)->count();            $summoney=M('money_detailed')->where($whereorder)->sum('money');            $sumservice_charge=M('money_detailed')->where($whereorder)->sum('service_charge');                        if($user){                $redata['refAccount']=$data->refAccount;                $redata['availableBalance']=$user['wallet_money'];                $redata['marginBalance']=$user['money'];                $redata['applyCreditCardCount']=rand(1,10);                $redata['guideCount']=rand(1,10);                $redata['passwdCount']=rand(1,10);                $redata['planExecFirstCancelCount']=rand(1,10);                $redata['planExecutingCancelCount']=rand(1,10);                $redata['planExecFirstLatelyCancelTime']=date("Y-m-d H:i:s",$user['time']);                $redata['planExectingLatelyCancelTime']=date("Y-m-d H:i:s",$user['time']);                $redata['rechargeFailCount']=rand(1,10);                $redata['rechargeMaxAmount']=$user['money'];                $redata['maxBalance']=$user['wallet_money'];                $redata['accountMaxAmount']=$user['wallet_money'];                $redata['planFinishCount']=rand(1,10);                $redata['lately6ConsFailCount']=rand(1,10);                $redata['consFailCount']=rand(1,10);                $redata['cancelCreditCardCount']=rand(1,10);                $redata['isSVIP']='Y';                $redata['SVIPTime']=date("Y-m-d H:i:s",$user['time']);                $redata['cashProfit']=$user['money'];                $redata['myLoobun']=rand(1,10);                $redata['kpiInsuranceCount']=rand(1,10);                $redata['kpiGatheringTotal']=$sumpay_money;                $redata['kpiCashProfitTatal']=$sumservice_charge;                $redata['kpiWithdrawTotalAmount']=$summoney;                $redata['kpiUnionPayTotalAmount']=$sumpay_money;                $redata['kpiUnionPayTotalCount']=$sumpay_moneycount;                $redata['kpiUnionPayDays']=$sumpay_moneycount;                                $redata['mobileModifyRecord'][0]['modifyBefore']=$user['phone'];                $redata['mobileModifyRecord'][0]['modifyAfter']=$user['phone'];                $redata['mobileModifyRecord'][0]['modifyTime']=date("Y-m-d H:i:s",$user['time']);                                $redata['rechargeRecord'][0]['userBankCard']=$user['cart'];                $redata['rechargeRecord'][0]['tradeTime']=date("Y-m-d H:i:s",$user['time']);                $redata['rechargeRecord'][0]['amount']=$user['wallet_money'];                $redata['rechargeRecord'][0]['fee']=0;                $redata['rechargeRecord'][0]['success']='Y';                $redata['rechargeRecord'][0]['failReason']='';                $redata['rechargeRecord'][0]['tradeType']='1';                                                $redata['planRecord'][0]['userBankCard']=$user['cart'];                $redata['planRecord'][0]['planDays']=rand(1,10);                $redata['planRecord'][0]['planCount']=rand(1,10);                $redata['planRecord'][0]['repayAmount']=$user['wallet_money'];                $redata['planRecord'][0]['planTime']=date("Y-m-d H:i:s",$user['time']);                $redata['planRecord'][0]['firstPlanExecTime']=date("Y-m-d H:i:s",$user['time']);                $redata['planRecord'][0]['endPlanExecTime']=date("Y-m-d H:i:s",time());                 $redata['planRecord'][0]['totalFee']=$user['wallet_money'];                $redata['planRecord'][0]['realPayFee']=0;                $redata['planRecord'][0]['realPlanExecCount']=rand(1,10);                $redata['planRecord'][0]['planType']='2';                                 $redata['resultCode']="1";                $redata['errorCode']="0";                $redata['errorDesc']="获取成功";                $redata['message']="获取成功";                                                                //                   echo json_encode($redata);                $result=json_encode($redata);//                 $result='{"refAccount" : "'.$redata['refAccount'].'","userRegDate" : "'.$redata['userRegDate'].'","userAddr" : "'.$redata['userAddr'].'","userRegSource" : "'.$redata['userRegSource'].'","throughDate" : "'.$redata['throughDate'].'","userLongitude" : "'.$redata['userLongitude'].'","userLatitude" : "'.$redata['userLatitude'].'","userRecommendCode" : "'.$redata['userRecommendCode'].'","userId" : "'.$redata['userId'].'","userName" : "'.$redata['userName'].'","userLogin" : "'.$redata['userLogin'].'","userPhone" : "'.$redata['userPhone'].'","userEmail" : "'.$redata['userEmail'].'","userCardType" : "'.$redata['userCardType'].'","userCardNo" : "'.$redata['userCardNo'].'","resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                                $returnmsg=$this->encrypt_rsa($result,$publickey);                                echo $returnmsg;                //                  echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                            }else{                $redata['resultCode']="0";                $redata['errorCode']="1";                $redata['errorDesc']="用户不存在";                $redata['message']="用户不存在";                //                 $result='{"resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                             $result=json_encode($redata);                              $returnmsg=$this->encrypt_rsa($result,$publickey);                                echo $returnmsg;                                //          echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串            }                               }else {                        $redata['resultCode']="0";            $redata['errorCode']="1";            $redata['errorDesc']="refAccount不存在";            $redata['message']="refAccount不存在";                        $result='{"resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                        $returnmsg=$this->encrypt_rsa($result,$publickey);                        echo $returnmsg;                        //          echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                    }                    }        //2.1.4.按需获取用户授信，风控维度信息（合作机构定制）    public function usershouxin2()    {        $config = C('WEIMI');        $publickey=$config['publickey'];        $privatekey=$config['privatekey'];                        $input = file_get_contents('php://input');                /*  $input ="X/zDPCTOqILGmycq7I0tOcYCVK8qKnsP615qu80p5foaHyi+TzKHoj3vnAKv222cF/kcNMMj+fQE         RS9gBb15KBPQaCs0QHPXLvhqWqwq80lVouBTrBD9iLTCJ6QjkV640hDLk5GT5eVMP1MzjwcpSgAx         oefjiL5GaM0VvdKJUWI=";   */        //          echo $input;                 $jsonInfo=$this->decrypt_rsa($input,$privatekey);        //          echo $jsonInfo;                $nowtime= date("Y-m-d h:i:s", time());        # 写入日志        R("Payapi/Api/PaySetLog",array("./PayLog","WeiMi_usershouxin2_Return__",$nowtime.'----回调返回信息参数----'.$jsonInfo.'----'));                $data=json_decode($jsonInfo);                ob_clean(); //处理网页多余的字符                if($data->refAccount)        {            $whereuser['y_user.user_id']=$data->refAccount;            $whereuser['y_mybank.type']=1;            $user=M('user')->join('left join y_myrealname on y_myrealname.user_id=y_user.user_id ')->join('left join y_mybank on y_mybank.user_id=y_user.user_id ')->field('y_user.*,y_myrealname.nickname,y_myrealname.idcard,y_mybank.cart,y_mybank.province_id,y_mybank.city_id,y_mybank.area_id')->where($whereuser)->find();                        if($user){                $redata['refAccount']=$data->refAccount;                $redata['availableBalance']=$user['wallet_money'];                $redata['marginBalance']=$user['money'];                                               $redata['planRecord'][0]['userBankCard']=$user['cart'];                $redata['planRecord'][0]['planDays']=rand(1,10);                $redata['planRecord'][0]['planCount']=rand(1,10);                $redata['planRecord'][0]['repayAmount']=$user['wallet_money'];                $redata['planRecord'][0]['planTime']=date("Y-m-d H:i:s",$user['time']);                $redata['planRecord'][0]['firstPlanExecTime']=date("Y-m-d H:i:s",$user['time']);                $redata['planRecord'][0]['endPlanExecTime']=date("Y-m-d H:i:s",time());                $redata['planRecord'][0]['totalFee']=$user['wallet_money'];                $redata['planRecord'][0]['realPayFee']=0;                $redata['planRecord'][0]['realPlanExecCount']=rand(1,10);                $redata['planRecord'][0]['planType']='2';                                $redata['resultCode']="1";                $redata['errorCode']="0";                $redata['errorDesc']="获取成功";                $redata['message']="获取成功";                                                                                //                  echo json_encode($redata);                $result=json_encode($redata);                //                 $result='{"refAccount" : "'.$redata['refAccount'].'","userRegDate" : "'.$redata['userRegDate'].'","userAddr" : "'.$redata['userAddr'].'","userRegSource" : "'.$redata['userRegSource'].'","throughDate" : "'.$redata['throughDate'].'","userLongitude" : "'.$redata['userLongitude'].'","userLatitude" : "'.$redata['userLatitude'].'","userRecommendCode" : "'.$redata['userRecommendCode'].'","userId" : "'.$redata['userId'].'","userName" : "'.$redata['userName'].'","userLogin" : "'.$redata['userLogin'].'","userPhone" : "'.$redata['userPhone'].'","userEmail" : "'.$redata['userEmail'].'","userCardType" : "'.$redata['userCardType'].'","userCardNo" : "'.$redata['userCardNo'].'","resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                                $returnmsg=$this->encrypt_rsa($result,$publickey);                                echo $returnmsg;                //                 echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                            }else{                $redata['resultCode']="0";                $redata['errorCode']="1";                $redata['errorDesc']="用户不存在";                $redata['message']="用户不存在";                                //                 $result='{"resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                                $result=json_encode($redata);                                $returnmsg=$this->encrypt_rsa($result,$publickey);                                echo $returnmsg;                                //          echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串            }                                }else {                        $redata['resultCode']="0";            $redata['errorCode']="1";            $redata['errorDesc']="refAccount不存在";            $redata['message']="refAccount不存在";                        $result='{"resultCode" : "'.$redata['resultCode'].'","errorCode" : "'.$redata['errorCode'].'","errorDesc" : "'.$redata['errorDesc'].'","message" :"'.$redata['message'].'"}';                        $returnmsg=$this->encrypt_rsa($result,$publickey);                        echo $returnmsg;                        //          echo $this->decrypt_rsa($returnmsg,$privatekey);  //解密字符串                    }            }            //加密    public function encrypt_rsa($data, $pu_key){               $pu_key = openssl_pkey_get_public($pu_key);//这个函数可用来判断公钥是否是可用的        $encrypted="";        /* openssl_public_encrypt($data,$encrypted,$pu_key);//公钥加密        $encrypted = base64_encode($encrypted); */                //处理超过117长度的加密        $encryptData='';        $crypto = '';        foreach (str_split($data, 117) as $chunk) {//             echo $chunk;            openssl_public_encrypt($chunk, $encryptData, $pu_key);            $crypto .= $encryptData;        }        $encrypted =$this->urlsafe_b64encode($crypto);//加密后的内容通常含有特殊字符，需要编码转换下，在网络间通过url传输时要注意base64编码是否是url安全的                        return $encrypted;                    }        //解密    public function decrypt_rsa($data, $pi_key){                $pi_key =  openssl_pkey_get_private($pi_key);//这个函数可用来判断私钥是否是可用的，可用返回资源id Resource id//         $decrypted = "";//         openssl_private_decrypt(base64_decode($data),$decrypted,$pi_key);//私钥解密//         return $decrypted;        //处理超过117长度的加密        $crypto = '';        $decryptData = '';        foreach (str_split($this->urlsafe_b64decode($data), 128) as $chunk) {            openssl_private_decrypt($chunk, $decryptData, $pi_key);            $crypto .= $decryptData;        }        //openssl_public_decrypt($encrypted,$decrypted,$this->pu_key);//私钥加密的内容通过公钥可用解密出来        return $crypto;                                 }        //加密码时把特殊符号替换成URL可以带的内容    function urlsafe_b64encode($string) {        $data = base64_encode($string);//         $data = str_replace(array('+','/','='),array('-','_',''),$data);        return $data;    }        //解密码时把转换后的符号替换特殊符号    function urlsafe_b64decode($string) {//          $data = str_replace(array('-','_'),array('+','/'),$string);//          $mod4 = strlen($data) % 4;//         if ($mod4) {//             $data .= substr('====', $mod4);//         }//         return base64_decode($data);        return base64_decode($string);    }    }