<?php# 银钱包对接接口 - 首页单独功能接口namespace Payapi\Controller;class IndexController extends BaseController{                public function __initialize()        {                            }                //首页接口        public function index(){                $uid = $_REQUEST['uid'];                                $sign = $_REQUEST['sign'];                $parem=array(                        'signType'=>$_REQUEST['signType'],                        'timestamp' => $_REQUEST['timestamp'],                        'dataType' => $_REQUEST['dataType'],                        'inputCharset' => $_REQUEST['inputCharset'],                        'version' => $_REQUEST['version'],                    );              if (!$sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $array = array(                        'uid'=>$uid,                    );                $parem=array_merge($parem,$array);                $msg = R('Func/Func/getKey',array($parem));//返回加密                if ($sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;                    }                R('Func/Func/getTwoSign',array($sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $sign;//把sign存入session 为作判断                                /*                * 逻辑                * */                $nowOrder=array();                $banner=array();                $nowOrder = M('money_detailed')->field('pay_money,jy_status,t,goods_name,money')->where(array('user_id'=>$uid))->order('t desc')->find();                if ($nowOrder['pay_money'] == 0){                        $nowOrder['pay_money']=$nowOrder['money'];                        if (!$nowOrder['pay_money']){                                $nowOrder=array();                            }                    }                                   $banner = M('banner')->where(array('type'=>1,'status'=>1))->select();                if (!$uid){                        echo json_encode(array('code'=>6502,'msg'=>'参数不全'));die;                    }                                $wtype['type'] = 2;                $wtype['status'] = 1;                $gg = M('notice')->where($wtype)->order('t desc')->limit(0,7)->select();                foreach ($gg as $k => $v) {            unset($gg[$k]['content']);        }                $wtype2['type'] = 3;                $wtype2['status'] = 1;                $active = M('notice')->where($wtype2)->order('t desc')->limit(0,7)->select();                foreach ($active as $k => $v)                {//            unset($active[$k]['content']);            $active[$k]['thumb'] = enThumb("./Uploads/",$v['thumb']);                    }        if(!$banner)        {            $banner = array();        }                if(!$nowOrder)        {            $nowOrder = '';        }                        if(!$gg)        {            $gg = array();        }                        if(!$active)        {            $active = array();        }                $beginToday=time()-2592000;        $endToday=time()+3600;                $whereopen['user_id']=$uid;        $whereopen['update_t']=array('BETWEEN',array($beginToday,$endToday));        $whereopen['status']=2;        $openbusiness=M('business')->where($whereopen)->order('update_t desc')->find();//         echo M('business')->getLastSql();        $isopen=0;//         dump($openbusiness);        if($openbusiness)        {            $isopen=1;                        $wherehasopen['user_id']=$uid;            $wherehasopen['business_id']=$openbusiness['business_id'];            $isopenres=M('business_notice')->where($wherehasopen)->find();//             dump($isopenres);            if($isopenres)            {                $isopen=0;            }                                            }                                               echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>array('lunbo'=>$banner,'order'=>$nowOrder,'gg'=>$gg,'active'=>$active,'isopen'=>$isopen)));die;        /*         if($nowOrder){                  echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>array('lunbo'=>$banner,'order'=>$nowOrder,'gg'=>$gg,'active'=>$active)));die;                  }else{                  echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>array('lunbo'=>$banner)));die;                  }         */            }            public function isopen()    {        $uid = $_REQUEST['uid'];                                $sign = $_REQUEST['sign'];                $parem=array(                        'signType'=>$_REQUEST['signType'],                        'timestamp' => $_REQUEST['timestamp'],                        'dataType' => $_REQUEST['dataType'],                        'inputCharset' => $_REQUEST['inputCharset'],                        'version' => $_REQUEST['version'],                    );             if (!$sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $array = array(                        'uid'=>$uid,                    );                $parem=array_merge($parem,$array);                $msg = R('Func/Func/getKey',array($parem));//返回加密                if ($sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;                    }                R('Func/Func/getTwoSign',array($sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $sign;//把sign存入session 为作判断                 $beginToday=time()-2592000;        $endToday=time()+3600;        $whereopen['user_id']=$uid;        $whereopen['update_t']=array('BETWEEN',array($beginToday,$endToday));        $whereopen['status']=2;        $openbusiness=M('business')->where($whereopen)->order('update_t desc')->find();//         dump($openbusiness);        $isopen=0;        if($openbusiness)        {            $isopen=1;                        $wherehasopen['user_id']=$uid;            $wherehasopen['business_id']=$openbusiness['business_id'];            $isopenres=M('business_notice')->where($wherehasopen)->find();            if(!$isopenres)            {                $data['user_id']=$uid;                $data['business_id']=$openbusiness['business_id'];                $data['addtime']=time();                M('business_notice')->add($data);            }                    }                echo json_encode(array('code'=>200,'msg'=>'操作成功'));die;            }        # 新增系统通知接口        public function sysNotice()        {                $wtype['status'] = 1;                $uid = trim($_REQUEST['uid']);                $wtype['type'] = trim($_REQUEST['type']);                                /**/                $sign = $_REQUEST['sign'];                $parem=array(                        'signType'=>$_REQUEST['signType'],                        'timestamp' => $_REQUEST['timestamp'],                        'dataType' => $_REQUEST['dataType'],                        'inputCharset' => $_REQUEST['inputCharset'],                        'version' => $_REQUEST['version'],                    );                if (!$sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $array = array(                        'uid'=>$uid,                        'type' => $wtype['type']                    );                $parem=array_merge($parem,$array);                $msg = R('Func/Func/getKey',array($parem));//返回加密                if ($sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'禁止访问'));die;                    }                R('Func/Func/getTwoSign',array($sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $sign;//把sign存入session 为作判断                                                $gg = M('notice')->where($wtype)->order('t desc')->select();                $new = array();                foreach ($gg as $k => $v)                {                        //            if($v['type'] == 1 or $v['type'] == 2 )                            //            {                        $v['thumb'] = enThumb("./Uploads/",$v['thumb']);                        $ifread = M("read")->where(array('user_id'=>$uid,'notice_id'=>$v['notice_id']))->find();                        if($ifread)                        {                                $is_read = 1;                            }else{                                $is_read = 2;                            }                        # 已读                        $v['is_read'] = $is_read;                        # 阅读量                        $v['readnum'] = M("read")->where(array('notice_id'=>$v['notice_id']))->count();            $v['msg'] =htmlspecialchars_decode($v['content']);            $new[] = $v;                        //            }                    }                echo json_encode(array('code'=>6501,'msg'=>'获取成功','data'=>$new));die;            }                # 链接文章详情        public function getArticleH5()        {                $id = $_REQUEST['id'];                $uid = $_REQUEST['uid'];                                M('read')->add(array('user_id'=>$uid,'t'=>time(),'notice_id'=>$id));                                # 阅读数                $readSum = M("read")->where(array('notice_id'=>$id))->count();                $aricle = M('notice')->where(array('notice_id'=>$id))->find();                $this->assign('aricle',$aricle);                $this->assign('readSum',$readSum);                $this->display();            }            #测试 数据    public function xTcs(){        $content=M('notice')->where(array('notice_id'=>11))->getField('content');        //        $content="&lt;ul&gt;&lt;li&gt;已支持ApplePay支付&lt;/li&gt;&lt;li&gt;推出信用卡电子账单&lt;br /&gt;&lt;/li&gt;&lt;li&gt;消费满立减，万事达卡双币种信用卡携程酒店+景点消费满2388元立减388元&lt;br /&gt;&lt;/li&gt;&lt;li&gt;全国商圈扫码支付最高立减100元&lt;/li&gt;&lt;/ul&gt;";        echo $content;die;        //        dump(htmlspecialchars_decode($content));die;    }    //验证是否有支付密码接口        public function isZfPassword(){                $sign = $_REQUEST['sign'];                $uid = $_REQUEST['uid'];                if (!$uid){                        echo json_encode(array('code'=>2333,'msg'=>'参数不全'));die;                    }                $parem=array(                        'signType'=>$_REQUEST['signType'],                        'timestamp' => $_REQUEST['timestamp'],                        'dataType' => $_REQUEST['dataType'],                        'inputCharset' => $_REQUEST['inputCharset'],                        'version' => $_REQUEST['version'],                    );                if (!$sign){                        echo json_encode(array('code'=>10005,'msg'=>'加密字符串不存在'));die;                    }                $array = array(                        'uid'=>$uid,                    );                $parem=array_merge($parem,$array);                $msg = R('Func/Func/getKey',array($parem));//返回加密                if ($sign !== $msg){                        echo json_encode(array('code'=>10004,'msg'=>'网络错误,请重新提交'));die;                    }                R('Func/Func/getTwoSign',array($sign)); //判断是否相同参数传第二次(如果是正常调用接口,参数不可能和sign相同)                $_SESSION['last_sign'] = $sign;//把sign存入session 为作判断                                /*                * 通过uid查询密码表是否存在支付密码                * */                $zfpwd=M('password')->where(array('user_id'=>$uid,'type'=>1))->find();                if (!$zfpwd){                        echo json_encode(array('code'=>2998,'msg'=>"您未设置支付密码,请前往个人中心设置支付密码"));die;                    }else{                        echo json_encode(array('code'=>2999,'msg'=>'您已设置支付密码'));die;                    }            }    //520活动网页    public function huoDong_520(){        $this->display();    }    public function huoDong_520cs(){        $user_id = $_REQUEST['user_id'];        $weObj = R('Func/Wxapi/getConfig');//        dump($weObj);die;        $phone = M('user')->where(array('user_id'=>$user_id))->getField('phone');        $phonecs = intval($phone);//        dump($phonecs);die;        $titk = $weObj->getQRCode($user_id,2);        $data = $weObj->getQRUrl($titk['ticket']);        echo $data;die;        dump($data);die;        $this->display();    }            }