<?php# 银钱包 - 商家公共函数namespace Func\Controller;use Think\Controller;class BusinessController extends Controller {    # 获取列表    # $w 查询条件 $p 页码 $num 当前页码的总数    public function getList($w = array(),$jl=array(),$p = 1,$num = 6)    {        if($p == 1)        {            $p = 0;        }        $w['status'] = 2;        $list = M("business")->field('thumb,business_id,user_id,phone,shop_name,ms,province_id,city_id,area_id,detailed_address,discount,address,shop_start_time,shop_end_time,minus,youhui,name,lat,lng,province_id,city_id,area_id')->where($w)->limit($p*$num,$num)->select();        foreach ($list as $k=> $v)        {            $list[$k]['thumb'] = enThumb('./Uploads/',$v['thumb']);            $coupon = $this->getCoupon($v['business_id']);            # 是否有送领券            $list[$k]['have_coupon'] = !empty($coupon)?1:0;            $total = 0;            $lqnum = 0;            foreach ($coupon as $k1 => $v1)            {                $cw['coupon_id'] = $v1['coupon_id'];                $lqtotal = $this->getLqCoupon($cw);                $coupon[$k1]['lqtotal'] = $lqtotal;                $coupon[$k1]['starttime'] = date("Y.m.d",$v1['start_time']);                $coupon[$k1]['endtime'] =  date("Y.m.d",$v1['end_time']);                # 剩余多少张                $total += $v1['total'];                $lqnum += $lqtotal;                # 已领取多少张                $coupon[$k1]['already_coupon'] = $lqtotal;                $surplus_coupon = $v1['total'] - $lqtotal;                $coupon[$k1]['surplus_coupon'] = $surplus_coupon;            }            $list[$k]['coupon'] = $coupon;            $surplus_coupon = $total - $lqnum;            $list[$k]['surplus_coupon'] = $surplus_coupon;            # 已领取            $list[$k]['already_coupon'] = $total - $surplus_coupon;            # 轮播图            $lb = $this->getLunbo($v['business_id']);            $list[$k]['lunbo'] = $lb;            # 距离km            $lat1 = $jl['lat1'];            $lng1 = $jl['lng1'];            $lat2 = $v['lat'];            $lng2 = $v['lng'];            $jlkm = R("Func/Func/getDistance",array($lat1,$lng1,$lat2,$lng2));            $list[$k]['jl'] = round($jlkm/1000,2);        }        return $list;    }    # 获取列表    # $w 查询条件 $p 页码 $num 当前页码的总数    public function getList1($w = array(),$jl=array(),$p = 1,$num = 6)    {        if($p == 1)        {            $p = 0;        }        $w['status'] = 2;        $list = M("business")->field('(                    6371 * acos (                      cos ( radians('. $jl['lat1'].') )                      * cos( radians( lat ) )                      * cos( radians( lng ) - radians('. $jl['lng1'].') )                      + sin ( radians('. $jl['lat1'].') )                      * sin( radians( lat ) )                    )                  ) AS distance,thumb,business_id,user_id,phone,shop_name,ms,province_id,city_id,area_id,detailed_address,discount,address,shop_start_time,shop_end_time,minus,youhui,name,province_id,city_id,area_id')->having('distance<20')->where($w)->limit($p*$num,$num)->select();        //        dump($list);exit;        foreach ($list as $k=> $v)        {            $list[$k]['thumb'] = enThumb('./Uploads/',$v['thumb']);            $coupon = $this->getCoupon($v['business_id']);            # 是否有送领券            $list[$k]['have_coupon'] = !empty($coupon)?1:0;            $total = 0;            $lqnum = 0;            foreach ($coupon as $k1 => $v1)            {                $cw['coupon_id'] = $v1['coupon_id'];                $lqtotal = $this->getLqCoupon($cw);                $coupon[$k1]['lqtotal'] = $lqtotal;                $coupon[$k1]['starttime'] = date("Y.m.d",$v1['start_time']);                $coupon[$k1]['endtime'] =  date("Y.m.d",$v1['end_time']);                # 剩余多少张                $total += $v1['total'];                $lqnum += $lqtotal;                # 已领取多少张                $coupon[$k1]['already_coupon'] = $lqtotal;                $surplus_coupon = $v1['total'] - $lqtotal;                $coupon[$k1]['surplus_coupon'] = $surplus_coupon;            }            $list[$k]['coupon'] = $coupon;            $surplus_coupon = $total - $lqnum;            $list[$k]['surplus_coupon'] = $surplus_coupon;            # 已领取            $list[$k]['already_coupon'] = $total - $surplus_coupon;            # 轮播图            $lb = $this->getLunbo($v['business_id']);            $list[$k]['lunbo'] = $lb;            # 距离km            $lat1 = $jl['lat1'];            $lng1 = $jl['lng1'];            $lat2 = $v['lat'];            $lng2 = $v['lng'];            $jlkm = R("Func/Func/getDistance",array($lat1,$lng1,$lat2,$lng2));            $list[$k]['jl'] = round($jlkm/1000,2);        }        return $list;    }    # 获取行业分类    public function getCate($w = array())    {        $w['status'] = 1;        $list = M("industry")->where($w)->select();        foreach ($list as $k=> $v)        {            $list[$k]['icon'] = enThumb('/Public/',$v['icon']);        }        return $list;    }    # 获取商家轮播图    public function getLunbo($bid=0)    {        $w['business_id'] = $bid;        $w['status'] = 1;        $list = M('business_thumb')->where($w)->select();        foreach ($list as $k=> $v)        {            $list[$k]['thumb'] = enThumb('./Uploads/',$v['thumb']);            $list[$k]['big_thumb'] = enThumb('./Uploads/',$v['big_thumb']);        }        return $list;    }   #获取附近的icon图标    public function getBunner(){        $w['type']=1;        $w['status']=1;        $res = M('industry')->where($w)->select();        return $res;    }    # 获取商家的代金券    # $id 商家ID    public function getCoupon($bid=0,$w=array())    {        $w['business_id'] = $bid;        $w['status'] = 1;        $list = M("coupon")->where($w)->select();        return $list;    }    # 获取领取人数    public function getLqCoupon($w=array())    {        $d = M("coupon_data")->where($w)->count();        return $d;    }    public function index(){    	return '';    }    #商家    #uid  商家ID    public function  orderList($uid=0,$p=0,$num=5){//        $sj=date('Y-m',time());//        $zhidingY=$sj.'-01 00:00:00';////        $strY=substr($sj,0,4).'-';////        $zhidingM=strtotime($zhidingY);//////        $endday = strtotime(date($strY.'m-d', mktime(23, 59, 59, date('m', strtotime($zhidingY))+1, 00)));//        $endday=$endday+86399;        $where['business_id']=$uid;//        $where['t']=array(array('egt',$zhidingM),array('elt',$endday));        $data =M('business_order')->field('business_order_id,business_id,user_id,goods_name,user_pay_supply_id,goods_type,pay_name,service_charge,pt_ordersn,timestamp,sh_ordersn,jy_status,js_status,money,pay_money,money_type_id,t,d_t,coupon_data_id,jifen_jilu_id,minus')->where($where)->order('t desc')->limit($p*$num,$num)->select();            $benyue=array();        foreach ($data as $k=>$v){            if($v['money_type_id'] == 1){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 2){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 3){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 4){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 5){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 6){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 7){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 8){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 9){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 10){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 11){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 12){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 13){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 14){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 15){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 16){                $data[$k]['symbol']='-';            }elseif($v['money_type_id'] == 17){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 18){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 19){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 20){                $data[$k]['symbol']='+';            }elseif($v['money_type_id'] == 21){                $data[$k]['symbol']='+';            }//            if ($v['user_id'] == '12' || $v['user_id'] == '13' || $v['user_id'] == '14' || $v['user_id'] == '15'){              $v['money']=sprintf("%.2f",$v['money']);        }//        dump($data);die;        return $data;    }    #当前商家的订单总数    #uid  商家ID    public function orderSum($uid=0){//        $sj=date('Y-m',time());//        $zhidingY=$sj.'-01 00:00:00';////        $strY=substr($sj,0,4).'-';////        $zhidingM=strtotime($zhidingY);////        $endday = strtotime(date($strY.'m-d', mktime(23, 59, 59, date('m', strtotime($zhidingY))+1, 00)));//        $endday=$endday+86399;//        $where['t']=array(array('egt',$zhidingM),array('elt',$endday));        $where['business_id']=$uid;        $data =M('business_order')->alias('a')->field('a.*,b.money_type_id as b_id,b.type as b_type')->join('left join y_money_type as b on a.money_type_id = b.money_type_id')->where($where)->order('t desc')->select();        return $data;    }    #当前商家的营业总额    #uid  商家ID    public function rental($uid=0){       $data =M('business_order')->where(array('business_id'=>$uid))->sum('money');//       dump($data);die;      return $data;    }    #今日营业额    #uid  商家ID    public function today($uid=0){      $time=date('Y-m-d',time());        $begintime=date("Y-m-d H:i:s",mktime(0,0,0,date('m'),date('d'),date('Y')));        $endtime=date("Y-m-d H:i:s",mktime(0,0,0,date('m'),date('d')+1,date('Y'))-1);        $start_time=strtotime($begintime);        $end_time=strtotime($endtime);        $where['t']=array(array('egt',$start_time),array('elt',$end_time));        $where['business_id']=$uid;        $where['jy_status']=1;      $data = M('business_order')->where($where)->sum('money');//        dump($data);die;      return $data;    }    #昨日营业额    #uid  商家ID    public function yesterday($uid=0){        $beginYesterday=mktime(0,0,0,date('m'),date('d')-1,date('Y'));        $endYesterday=mktime(0,0,0,date('m'),date('d'),date('Y'))-1;        $where['t']=array(array('egt',$beginYesterday),array('elt',$endYesterday));        $where['business_id']=$uid;        $where['jy_status']=1;        $data = M('business_order')->where($where)->sum('money');//        dump($data);die;        return $data;    }}